<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en xml:lang=en><meta charset=utf-8><meta name=generator content="quarto-1.7.33"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><title>buffercache – Operating System (2025 Fall)</title><style>code{white-space:pre-wrap}span.smallcaps{font-variant:small-caps}div.columns{display:flex;gap:min(4vw,1.5em)}div.column{flex:auto;overflow-x:auto}div.hanging-indent{margin-left:1.5em;text-indent:-1.5em}ul.task-list{list-style:none}ul.task-list li input[type=checkbox]{width:.8em;margin:0 .8em .2em -1em;vertical-align:middle}html{-webkit-text-size-adjust:100%}pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em}pre.numberSource{margin-left:3em;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}</style><script src=../site_libs/quarto-nav/quarto-nav.js></script><script src=../site_libs/clipboard/clipboard.min.js></script><script src=../site_libs/quarto-search/autocomplete.umd.js></script><script src=../site_libs/quarto-search/fuse.min.js></script><script src=../site_libs/quarto-search/quarto-search.js></script><meta name=quarto:offset content="../"><link href=../images/orange.png rel=icon type=image/png><script src=../site_libs/quarto-html/quarto.js type=module></script><script src=../site_libs/quarto-html/tabsets/tabsets.js type=module></script><script src=../site_libs/quarto-html/popper.min.js></script><script src=../site_libs/quarto-html/tippy.umd.min.js></script><script src=../site_libs/quarto-html/anchor.min.js></script><link href=../site_libs/quarto-html/tippy.css rel=stylesheet><link href=../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css rel=stylesheet id=quarto-text-highlighting-styles><script src=../site_libs/bootstrap/bootstrap.min.js></script><link href=../site_libs/bootstrap/bootstrap-icons.css rel=stylesheet><link href=../site_libs/bootstrap/bootstrap-a3d6f4078ec9f2632a80ad631344d584.min.css rel=stylesheet append-hash=true id=quarto-bootstrap data-mode=light><script id=quarto-search-options type=application/json>{"location":"navbar","copy-button":false,"collapse-after":3,"panel-placement":"end","type":"overlay","limit":50,"keyboard-shortcut":["f","/","s"],"show-item-context":false,"language":{"search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search"}}</script><body class="nav-sidebar docked nav-fixed slimcontent quarto-light"><div id=quarto-search-results></div><header id=quarto-header class="headroom fixed-top"><nav class="navbar navbar-expand-lg" data-bs-theme=dark><div class="navbar-container container-fluid"><div class="navbar-brand-container mx-auto"><a class=navbar-brand href=../index.html><span class=navbar-title>Operating System (2025 Fall)</span></a></div><div id=quarto-search title=Search></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarCollapse aria-controls=navbarCollapse role=menu aria-expanded=false aria-label="Toggle navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarCollapse><ul class="navbar-nav navbar-nav-scroll me-auto"><li class=nav-item><a class="nav-link active" href=../index.html aria-current=page><span class=menu-text>Home</span></a><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-handouts role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Handouts</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-handouts><li><a class=dropdown-item href=../handouts/env_setup.html><span class=dropdown-text>Enviroment setup</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-admin role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Admin</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-admin><li><a class=dropdown-item href=../admin/policies.html><span class=dropdown-text>Policies</span></a><li><a class=dropdown-item href=../admin/explore.html><span class=dropdown-text>Exploratory Projects</span></a><li><a class=dropdown-item href=../admin/waitbutwhy.html><span class=dropdown-text>SD1↓ (燒蛋一下)</span></a></ul></ul><ul class="navbar-nav navbar-nav-scroll ms-auto"><li class="nav-item compact"><a class=nav-link href=https://dcs.site.nthu.edu.tw/><i class="bi bi-globe" role=img></i><span class=menu-text></span></a></ul></div><div class=quarto-navbar-tools></div></div></nav><nav class=quarto-secondary-nav><div class="container-fluid d-flex"><button type=button class="quarto-btn-toggle btn" data-bs-toggle=collapse role=button data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<i class="bi bi-layout-text-sidebar-reverse"></i></button><nav class=quarto-page-breadcrumbs aria-label=breadcrumb><ol class=breadcrumb></ol></nav><a class=flex-grow-1 role=navigation data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()></a><button type=button class="btn quarto-search-button" aria-label=Search onclick=window.quartoOpenSearch()>
<i class="bi bi-search"></i></button></div></nav></header><div id=quarto-content class="quarto-container page-columns page-rows-contents page-layout-article page-navbar"><nav id=quarto-sidebar class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center"><div class=sidebar-search><div id=quarto-search title=Search></div></div></div><div class=sidebar-menu-container><ul class="list-unstyled mt-1"><li class=sidebar-item><div class=sidebar-item-container><a href=../index.html class="sidebar-item-text sidebar-link"><span class=menu-text>OS 2025 Fall</span></a></div><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w2.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 2</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-1 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-1 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/env_setup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Environment setup</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w3.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 3</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-2 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-2 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/unix.html class="sidebar-item-text sidebar-link"><span class=menu-text>Unix Philosophy</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/mini-cloud.html class="sidebar-item-text sidebar-link"><span class=menu-text>Your First Week in OS Journey</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-creation.html class="sidebar-item-text sidebar-link"><span class=menu-text><code>fork()</code>/<code>exec()</code></span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w4.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 4</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-3 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-3 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/privilege.html class="sidebar-item-text sidebar-link"><span class=menu-text>Privilege</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/path-traversal.html class="sidebar-item-text sidebar-link"><span class=menu-text>Lab: Path Traversal Attack</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-address-space.html class="sidebar-item-text sidebar-link"><span class=menu-text>Address Space Layout</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/linking.html class="sidebar-item-text sidebar-link"><span class=menu-text>Static vs Dynamic Linking</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w5.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 5</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-4 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-4 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-passwords.html class="sidebar-item-text sidebar-link"><span class=menu-text>Parallelizing Rainbow Table Lookup with Pipes</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-dup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipes, Redirection, and File Descriptors</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/fifo.html class="sidebar-item-text sidebar-link"><span class=menu-text>FIFO (named pipe)</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w6.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 6</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-5 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-5 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/scheduler.html class="sidebar-item-text sidebar-link"><span class=menu-text>Schedulers</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-state.html class="sidebar-item-text sidebar-link"><span class=menu-text>Process States in Linux</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-pingpong.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipe Pingpong</span></a></div></ul></ul></div></nav><div id=quarto-sidebar-glass class=quarto-sidebar-collapse-item data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item></div><div id=quarto-margin-sidebar class="sidebar margin-sidebar"><nav id=TOC role=doc-toc class=toc-active><h2 id=toc-title>On this page</h2><ul><li><a href=#caching-and-buffering id=toc-caching-and-buffering class="nav-link active" data-scroll-target=#caching-and-buffering>Caching and Buffering</a><ul class=collapse><li><a href=#pages-and-blocks id=toc-pages-and-blocks class=nav-link data-scroll-target=#pages-and-blocks>Pages and Blocks</a><li><a href=#the-cache-hierarchy id=toc-the-cache-hierarchy class=nav-link data-scroll-target=#the-cache-hierarchy>The Cache Hierarchy</a><li><a href=#direct-io id=toc-direct-io class=nav-link data-scroll-target=#direct-io>Direct I/O</a><li><a href=#memory-mapping id=toc-memory-mapping class=nav-link data-scroll-target=#memory-mapping>Memory Mapping</a><li><a href=#write-caching-write-coalescing id=toc-write-caching-write-coalescing class=nav-link data-scroll-target=#write-caching-write-coalescing>Write Caching & Write Coalescing</a><ul class=collapse><li><a href=#write-through-vs.-write-back-caching id=toc-write-through-vs.-write-back-caching class=nav-link data-scroll-target=#write-through-vs.-write-back-caching>Write-Through vs.&nbsp;Write-Back Caching</a></ul><li><a href=#latency-vs.-throughput id=toc-latency-vs.-throughput class=nav-link data-scroll-target=#latency-vs.-throughput>Latency vs.&nbsp;Throughput</a><li><a href=#page-alignment id=toc-page-alignment class=nav-link data-scroll-target=#page-alignment>Page Alignment</a><li><a href=#cache-inside-ssd id=toc-cache-inside-ssd class=nav-link data-scroll-target=#cache-inside-ssd>Cache inside SSD</a><li><a href=#cache-is-deceptive id=toc-cache-is-deceptive class=nav-link data-scroll-target=#cache-is-deceptive>Cache is Deceptive</a><li><a href=#conclusion id=toc-conclusion class=nav-link data-scroll-target=#conclusion>Conclusion</a></ul></ul></nav></div><main class="content page-columns page-full" id=quarto-document-content><header id=title-block-header class=quarto-title-block></header><section id=caching-and-buffering class="level1 page-columns page-full"><h1>Caching and Buffering</h1><p><img src=../images/cache-hierarchy.png class=img-fluid><p>Think about how you get sushi for dinner. You first check your refrigerator (<strong>SRAM</strong>). If your fridge is empty, you call Uber Eat to get from 爭鮮 (Sushi Express) (<strong>DRAM</strong>). 爭鮮 might buy a large amount of salmon from Costco (<strong>SSD</strong>). Costco might get their salmon from Norway (very far away … <strong>Google Drive</strong>!?), which takes a very long time.<p>Each step in this chain is a <strong>cache</strong>. Your refrigerator is a cache for 爭鮮, 爭鮮 is a cache for Costco, Costco is a cache for Norway.<p>Your computer’s memory hierarchy is also the same. When your CPU needs data, it first checks its “refrigerator,” the SRAM. If the data isn’t there (a <em>cache miss</em>), it checks DRAM. If the data isn’t in RAM either, the OS must fetch it from the SSD.<div class="quarto-figure quarto-figure-center"><figure class=figure><p><img src=../images/gdrive-copy.png class="img-fluid figure-img"><figcaption>The first time copy from Google Drive. The second time directly from the memory</figcaption></figure></div><div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-1-contents aria-controls=callout-1 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Latency numbers every programmer should know</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-1 class="callout-1-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>Source: <a href=https://gist.github.com/hellerbarde/2843375>Latency numbers every programmer should know</a><div class=sourceCode id=cb1><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=ex>L1</span> cache reference ......................... 0.5 ns</span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a><span class=ex>Main</span> memory reference ...................... 100 ns             </span>
<span id=cb1-3><a href=#cb1-3 aria-hidden=true tabindex=-1></a><span class=ex>SSD</span> random read ........................ 150,000 ns  = 150 µs</span>
<span id=cb1-4><a href=#cb1-4 aria-hidden=true tabindex=-1></a><span class=ex>Send</span> packet CA-<span class=op>&gt;</span>Netherlands-<span class=op>&gt;</span>CA .... 150,000,000 ns  = 150 ms</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><div class=sourceCode id=cb2><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=ex>L1</span> cache reference                  0.5 s         One heart beat <span class=er>(</span><span class=ex>0.5</span> s<span class=kw>)</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a><span class=ex>Main</span> memory reference               100 s         Brushing your teeth</span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a><span class=ex>SSD</span> random read                     1.7 days      A normal weekend</span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a><span class=ex>Send</span> packet CA-<span class=op>&gt;</span>Netherlands-<span class=op>&gt;</span>CA     4.8 years     Average time it takes to complete a bachelor<span class=st>'s degree</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></div></div></div><p>In the first two weeks, we discussed how dynamic libraries solve two related problems: disk space and loading time. When you use TensorFlow on Google Colab, the first time you import it, the system loads the massive library from disk into memory. This takes several seconds. But if you restart your notebook and import TensorFlow again, it loads much faster. Why? Because the OS has cached the library in memory.<p><img src=../images/pytorch.png class=img-fluid><p>This week, we examine caching and buffering in detail.<section id=pages-and-blocks class=level2><h2 class=anchored data-anchor-id=pages-and-blocks>Pages and Blocks</h2><p>Before diving deeper, we need to understand the unit at which storage operates. Your hard disk or SSD doesn’t work with individual bytes. Instead, it organizes data into fixed-size units called <span class=red><strong>pages</strong></span> or <span class=red><strong>sectors</strong></span>. A page is typically <span class=red><strong>4 KB</strong></span> (4096 bytes). When the OS requests data from disk, it doesn’t ask for “give me 32 bytes at address X.” Instead, it says “give me the 4 KB page containing address X.” But CPU fetches data at an unit of <span class=red><strong>cacheline</strong></span> (64 bytes).<p>This is important because it means the size of disk I/O is much bigger than the granularity of CPU. When you call <code>fprintf(fp, "hello")</code>, you’re asking to write 5 bytes. But the kernel doesn’t immediately perform a disk write operation for those 5 bytes. Instead, the kernel accumulates many small writes into a buffer, and when that buffer fills up to something close to a page boundary, it writes to disk. This buffering strategy dramatically reduces the number of disk I/O, which is very important because disk I/O is very slow.</section><section id=the-cache-hierarchy class=level2><h2 class=anchored data-anchor-id=the-cache-hierarchy>The Cache Hierarchy</h2><p>Suppose your program calls <code>fread()</code> to read 100 bytes from a file. Here’s the journey that data takes:<p>First, the kernel checks the <span class=green><strong>buffer cache</strong></span> (or page cache). The buffer cache is <span class=green><strong>coherent</strong></span>, meaning if two different processes read the same file, they both see the same cached data from this shared kernel buffer cache. If the data is already in the buffer cache from a previous read, the kernel is done: just return the data immediately without touching the disk.<p>If the data is not in the buffer cache, the kernel issues a disk I/O request to fetch the relevant 4 KB page from the disk. Once the data arrives in the buffer cache, the kernel must then copy it from kernel memory into your application’s user-space memory. This second copy is required because of memory protection: your program cannot directly access kernel memory.<p><img src=../images/cache-path.png class=img-fluid><p>Notice something inefficient here? The data was copied twice. Memory copy takes CPU time. Two copies also waste DRAM space. But there is also a benefit. If you call <code>fread()</code> to 100 bytes, you only make a <code>read()</code> system call the first time. From the second time, you read more 100 bytes, these <code>fread()</code> can read directly from the user-spacee buffer without making a <code>read()</code> system call because in the first time, libc already load 4KB of data into the buffer. this is called <span class=green><em>prefetching</em></span>.<p>Similar for write, when you call <code>printf</code>, the C library doesn’t immediately make a system call to the kernel. Instead, it copies your data into a temporary buffer in your application’s own memory. It is only when this buffer is full, or when you explicitly flush it, libc will make one <code>write</code> system call to pass the whole chunk of data to the kernel’s buffer cache.<p><strong>The idea is that although caching/buffering needs to pay extra copy overhead, it avoids system call overheads, so can be a win.</strong><p>However, this user-space buffer is <span class=red><strong>not coherent</strong></span>. If two processes both read the same file, they each maintain their own separate user-space buffer. Process A’s buffer and Process B’s buffer contain independent copies of the data. This is why the kernel buffer cache is so important: it’s the single point of coherence for shared access.</section><section id=direct-io class=level2><h2 class=anchored data-anchor-id=direct-io>Direct I/O</h2><p>Sometimes you don’t want the kernel to cache your data. Imagine you’re writing a large video file to disk. The file is 50 GB, but your system has only 16 GB of RAM. If the kernel cache the data you write, it will <em>evict</em> other useful cached data from memory. This is called <span class=red><strong>cache pollution</strong></span>.<p>To prevent cache pollution, you can use <span class=green><strong>direct I/O</strong></span>. With direct I/O, your application reads or writes data directly to disk without storing anything to kernel’s buffer cache. In Linux, you can open a file with the <code>O_DIRECT</code> flag, or use the <code>dd</code> command with <code>oflag=direct</code>. <a href=https://www.cyberciti.biz/faq/creating-a-bootable-ubuntu-usb-stick-on-a-debian-linux/>For example</a>:<div class=sourceCode id=cb3><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=fu>dd</span> if=ubuntu.iso of=/dev/my-usb oflag=direct</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>This command copies <code>ubuntu.iso</code> to an USB, but it tells the kernel “don’t cache this data; I won’t read it again, so polluting the cache with it is wasteful.” The kernel skips the buffer cache and writes directly from the application’s memory to the device.</p></section><section id=memory-mapping class=level2><h2 class=anchored data-anchor-id=memory-mapping>Memory Mapping</h2><p>There’s a clever alternative to <code>fread()</code> called <span class=green><strong>memory mapping</strong></span>: the <code>mmap()</code> system call. When you call <code>mmap()</code> on a file, you’re asking the OS to do place a region of the file directly into your application’s address space <strong>without copying</strong>. Instead of reading the file into a separate buffer and then copying to your heap, the kernel maps the buffer cache directly into your virtual address space. When you read from those memory location in the virtual address space, you directly read from the buffer cache.<p>This avoids the double-copy. Only one copy exists in memory. <span class=green><strong>Another bonus</strong></span>: if another process also memory-maps the same file, both processes are looking at the same cached pages in the kernel buffer cache. The buffer cache coherence automatically ensures both processes see the same data.</p></section><section id=write-caching-write-coalescing class=level2><h2 class=anchored data-anchor-id=write-caching-write-coalescing>Write Caching & Write Coalescing</h2><p>Reading from cache is simple: if data is there, return it; if not, fetch it. For write buffering, the kernel must decide when to actually writes to disk.<p>The kernel uses <span class=green><strong>write buffering</strong></span> to batch small writes together. Suppose your program calls <code>printf()</code> five times to write five small data. Each <code>printf()</code> call writes to a user-space buffer maintained by <code>libc</code>. The <code>libc</code> library doesn’t immediately call <code>write()</code> system call for each <code>printf()</code>. It accumulates the writes. When the buffer fills up, or when the program explicitly calls <code>fflush()</code>, <code>libc</code> call <code>write()</code>.<p>Once the writes reach the kernel, a similar batching occurs. The kernel collects many small writes that fall within the same 4 KB page into a single buffer. This is called <span class=green><strong>write coalescing</strong></span>. Instead of writing the same page multiple times, the kernel combines all the writes into one page-sized operation and sends it to disk once. Write bandwidth on SSDs is maximum if we perform a lot of I/O operations at the same time instead of one by one.<div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-2-contents aria-controls=callout-2 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Demo: write coalescing</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-2 class="callout-2-contents callout-collapse collapse"><div class="callout-body-container callout-body"><div class=sourceCode id=cb4><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;stdio.h&gt;</span></span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;stdlib.h&gt;</span></span>
<span id=cb4-3><a href=#cb4-3 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;string.h&gt;</span></span>
<span id=cb4-4><a href=#cb4-4 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;time.h&gt;</span></span>
<span id=cb4-5><a href=#cb4-5 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;unistd.h&gt;</span></span>
<span id=cb4-6><a href=#cb4-6 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-7><a href=#cb4-7 aria-hidden=true tabindex=-1></a><span class=dt>static</span> <span class=dt>double</span> now<span class=op>(){</span> <span class=kw>struct</span> timespec t<span class=op>;</span> clock_gettime<span class=op>(</span>CLOCK_MONOTONIC<span class=op>,</span> <span class=op>&amp;</span>t<span class=op>);</span> <span class=cf>return</span> t<span class=op>.</span>tv_sec <span class=op>+</span> t<span class=op>.</span>tv_nsec<span class=op>/</span><span class=fl>1e9</span><span class=op>;</span> <span class=op>}</span></span>
<span id=cb4-8><a href=#cb4-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-9><a href=#cb4-9 aria-hidden=true tabindex=-1></a><span class=dt>int</span> main<span class=op>(</span><span class=dt>int</span> argc<span class=op>,</span> <span class=dt>char</span> <span class=op>**</span>argv<span class=op>){</span></span>
<span id=cb4-10><a href=#cb4-10 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=op>(</span>argc <span class=op>&lt;</span> <span class=dv>3</span><span class=op>){</span> fprintf<span class=op>(</span>stderr<span class=op>,</span> <span class=st>"Usage: </span><span class=sc>%s</span><span class=st> write-through or write-coalescing</span><span class=sc>\n</span><span class=st>"</span><span class=op>,</span> argv<span class=op>[</span><span class=dv>0</span><span class=op>]);</span> <span class=cf>return</span> <span class=dv>1</span><span class=op>;</span> <span class=op>}</span></span>
<span id=cb4-11><a href=#cb4-11 aria-hidden=true tabindex=-1></a>    <span class=dt>FILE</span> <span class=op>*</span>fp <span class=op>=</span> fopen<span class=op>(</span>argv<span class=op>[</span><span class=dv>1</span><span class=op>],</span> <span class=st>"w"</span><span class=op>);</span> <span class=cf>if</span> <span class=op>(!</span>fp<span class=op>){</span> perror<span class=op>(</span><span class=st>"fopen"</span><span class=op>);</span> <span class=cf>return</span> <span class=dv>1</span><span class=op>;</span> <span class=op>}</span></span>
<span id=cb4-12><a href=#cb4-12 aria-hidden=true tabindex=-1></a>    <span class=dt>char</span> buf<span class=op>[</span><span class=dv>4096</span><span class=op>];</span> memset<span class=op>(</span>buf<span class=op>,</span> <span class=ch>'X'</span><span class=op>,</span> <span class=kw>sizeof</span><span class=op>(</span>buf<span class=op>));</span></span>
<span id=cb4-13><a href=#cb4-13 aria-hidden=true tabindex=-1></a></span>
<span id=cb4-14><a href=#cb4-14 aria-hidden=true tabindex=-1></a>    <span class=dt>double</span> t0 <span class=op>=</span> now<span class=op>();</span></span>
<span id=cb4-15><a href=#cb4-15 aria-hidden=true tabindex=-1></a>    <span class=cf>for</span> <span class=op>(</span><span class=dt>int</span> i<span class=op>=</span><span class=dv>0</span><span class=op>;</span> i<span class=op>&lt;</span><span class=dv>5000</span><span class=op>;</span> i<span class=op>++){</span></span>
<span id=cb4-16><a href=#cb4-16 aria-hidden=true tabindex=-1></a>        fwrite<span class=op>(</span>buf<span class=op>,</span> <span class=dv>1</span><span class=op>,</span> <span class=kw>sizeof</span><span class=op>(</span>buf<span class=op>),</span> fp<span class=op>);</span></span>
<span id=cb4-17><a href=#cb4-17 aria-hidden=true tabindex=-1></a>        <span class=cf>if</span> <span class=op>(!</span>strcmp<span class=op>(</span>argv<span class=op>[</span><span class=dv>2</span><span class=op>],</span> <span class=st>"write-through"</span><span class=op>))</span> <span class=op>{</span> fflush<span class=op>(</span>fp<span class=op>);</span> fsync<span class=op>(</span>fileno<span class=op>(</span>fp<span class=op>));</span> <span class=op>}</span></span>
<span id=cb4-18><a href=#cb4-18 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb4-19><a href=#cb4-19 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=op>(!</span>strcmp<span class=op>(</span>argv<span class=op>[</span><span class=dv>2</span><span class=op>],</span> <span class=st>"write-coalescing"</span><span class=op>))</span> <span class=op>{</span> fflush<span class=op>(</span>fp<span class=op>);</span> fsync<span class=op>(</span>fileno<span class=op>(</span>fp<span class=op>));</span> <span class=op>}</span></span>
<span id=cb4-20><a href=#cb4-20 aria-hidden=true tabindex=-1></a>    <span class=dt>double</span> t1 <span class=op>=</span> now<span class=op>();</span></span>
<span id=cb4-21><a href=#cb4-21 aria-hidden=true tabindex=-1></a>    printf<span class=op>(</span><span class=st>"mode=</span><span class=sc>%s</span><span class=st> time=</span><span class=sc>%.3f</span><span class=st> s</span><span class=sc>\n</span><span class=st>"</span><span class=op>,</span> argv<span class=op>[</span><span class=dv>2</span><span class=op>],</span> t1 <span class=op>-</span> t0<span class=op>);</span></span>
<span id=cb4-22><a href=#cb4-22 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> <span class=dv>0</span><span class=op>;</span></span>
<span id=cb4-23><a href=#cb4-23 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Try to run it and see the difference:<div class=sourceCode id=cb5><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb5-1><a href=#cb5-1 aria-hidden=true tabindex=-1></a>gcc <span class=op>-</span>O2 demo<span class=op>.</span>c <span class=op>-</span>o demo</span>
<span id=cb5-2><a href=#cb5-2 aria-hidden=true tabindex=-1></a><span class=op>./</span>demo test<span class=op>.</span>txt write<span class=op>-</span>through</span>
<span id=cb5-3><a href=#cb5-3 aria-hidden=true tabindex=-1></a><span class=op>./</span>demo test<span class=op>.</span>txt write<span class=op>-</span>coalescing</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></div></div></div><p><span class=red><strong>But!!!</strong></span> If your computer’s power socket is unplugged after you write data but before the kernel flushes it to disk, that data is lost. If you don’t like that, you can call <code>fsync()</code> to force the kernel to flush buffers to disk immediately.<p><img src=../images/unplug.png class=img-fluid><section id=write-through-vs.-write-back-caching class=level3><h3 class=anchored data-anchor-id=write-through-vs.-write-back-caching>Write-Through vs.&nbsp;Write-Back Caching</h3><p>The kernel uses a policy called <span class=green><strong>write-back caching</strong></span> by default. In write-back caching, when you call the <code>write()</code> system call, the kernel returns control to your program immediately after placing the data in the buffer cache. The actual disk write happens later in the background. This makes writes appear fast to the application, but it introduces the durability risk we just discussed.<p>The alternative is <span class=green><strong>write-through caching</strong></span>, where the kernel doesn’t return until the data has been physically written to disk. Write-through is safer but slower. On Linux data is marked as <em>dirty</em> to indicate it’s been modified but not yet written. Linux periodically flushes all dirty pages to disk in batches. Once the page that is cached or buffered in the memory is the same as the page on disk, the page is called <span class=green><em>clean</em></span><p>Let’s verify that buffered write really return immediately and does not cause a context switch:<div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-3-contents aria-controls=callout-3 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">The behavior of <code>dd</code></div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-3 class="callout-3-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>The first <code>dd</code> call <code>write(fd, buf, 4000K)</code> for one time, the second <code>dd</code> calls <code>write(fd, buf, 4K)</code> for 1000 times.<div class=sourceCode id=cb6><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb6-1><a href=#cb6-1 aria-hidden=true tabindex=-1></a><span class=ex>yunchih@angel</span>  $ strace <span class=at>-c</span> dd if=/dev/zero of=test bs=4000K count=1 <span class=dv>2</span><span class=op>&gt;&amp;</span><span class=dv>1</span> <span class=kw>|</span> <span class=fu>head</span></span>
<span id=cb6-2><a href=#cb6-2 aria-hidden=true tabindex=-1></a><span class=ex>1+0</span> records in</span>
<span id=cb6-3><a href=#cb6-3 aria-hidden=true tabindex=-1></a><span class=ex>1+0</span> records out</span>
<span id=cb6-4><a href=#cb6-4 aria-hidden=true tabindex=-1></a><span class=ex>4096000</span> bytes <span class=er>(</span><span class=ex>4.1</span> MB, 3.9 MiB<span class=kw>)</span> <span class=ex>copied,</span> 0.0111685 s, 367 MB/s</span>
<span id=cb6-5><a href=#cb6-5 aria-hidden=true tabindex=-1></a><span class=ex>%</span> time     seconds  usecs/call     calls    errors syscall</span>
<span id=cb6-6><a href=#cb6-6 aria-hidden=true tabindex=-1></a><span class=ex>------</span> <span class=at>-----------</span> <span class=at>-----------</span> <span class=at>---------</span> <span class=at>---------</span> <span class=at>----------------</span></span>
<span id=cb6-7><a href=#cb6-7 aria-hidden=true tabindex=-1></a> <span class=ex>41.97</span>    0.004807        1201         4           write</span>
<span id=cb6-8><a href=#cb6-8 aria-hidden=true tabindex=-1></a> <span class=ex>25.44</span>    0.002914         728         4           read</span>
<span id=cb6-9><a href=#cb6-9 aria-hidden=true tabindex=-1></a> <span class=ex>12.97</span>    0.001485         148        10           close</span>
<span id=cb6-10><a href=#cb6-10 aria-hidden=true tabindex=-1></a> <span class=ex>11.83</span>    0.001355          75        18        11 openat</span>
<span id=cb6-11><a href=#cb6-11 aria-hidden=true tabindex=-1></a>  <span class=ex>3.93</span>    0.000450         450         1           execve</span>
<span id=cb6-12><a href=#cb6-12 aria-hidden=true tabindex=-1></a><span class=ex>yunchih@angel</span>  $ strace <span class=at>-c</span> dd if=/dev/zero of=test bs=4K count=1000 <span class=dv>2</span><span class=op>&gt;&amp;</span><span class=dv>1</span> <span class=kw>|</span> <span class=fu>head</span></span>
<span id=cb6-13><a href=#cb6-13 aria-hidden=true tabindex=-1></a><span class=ex>1000+0</span> records in</span>
<span id=cb6-14><a href=#cb6-14 aria-hidden=true tabindex=-1></a><span class=ex>1000+0</span> records out</span>
<span id=cb6-15><a href=#cb6-15 aria-hidden=true tabindex=-1></a><span class=ex>4096000</span> bytes <span class=er>(</span><span class=ex>4.1</span> MB, 3.9 MiB<span class=kw>)</span> <span class=ex>copied,</span> 0.0414901 s, 98.7 MB/s</span>
<span id=cb6-16><a href=#cb6-16 aria-hidden=true tabindex=-1></a><span class=ex>%</span> time     seconds  usecs/call     calls    errors syscall</span>
<span id=cb6-17><a href=#cb6-17 aria-hidden=true tabindex=-1></a><span class=ex>------</span> <span class=at>-----------</span> <span class=at>-----------</span> <span class=at>---------</span> <span class=at>---------</span> <span class=at>----------------</span></span>
<span id=cb6-18><a href=#cb6-18 aria-hidden=true tabindex=-1></a> <span class=ex>63.27</span>    0.006420           6      1003           write</span>
<span id=cb6-19><a href=#cb6-19 aria-hidden=true tabindex=-1></a> <span class=ex>33.56</span>    0.003405           3      1003           read</span>
<span id=cb6-20><a href=#cb6-20 aria-hidden=true tabindex=-1></a>  <span class=ex>2.88</span>    0.000292          29        10           close</span>
<span id=cb6-21><a href=#cb6-21 aria-hidden=true tabindex=-1></a>  <span class=ex>0.23</span>    0.000023           1        18        11 openat</span>
<span id=cb6-22><a href=#cb6-22 aria-hidden=true tabindex=-1></a>  <span class=ex>0.04</span>    0.000004           0        10           mmap</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></div></div></div><div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-4-contents aria-controls=callout-4 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Direct v.s Indirect write on Linux</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-4 class="callout-4-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>For each command, observe the total time elapsed and the number of context switch.<div class=sourceCode id=cb7><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb7-1><a href=#cb7-1 aria-hidden=true tabindex=-1></a><span class=ex>yunchih@angel</span> $ sudo perf stat <span class=at>-e</span> context-switches dd if=/dev/zero of=test bs=4000K count=1 oflag=direct</span>
<span id=cb7-2><a href=#cb7-2 aria-hidden=true tabindex=-1></a><span class=ex>1+0</span> records in</span>
<span id=cb7-3><a href=#cb7-3 aria-hidden=true tabindex=-1></a><span class=ex>1+0</span> records out</span>
<span id=cb7-4><a href=#cb7-4 aria-hidden=true tabindex=-1></a><span class=ex>4096000</span> bytes <span class=er>(</span><span class=ex>4.1</span> MB, 3.9 MiB<span class=kw>)</span> <span class=ex>copied,</span> 0.00543247 s, 754 MB/s</span>
<span id=cb7-5><a href=#cb7-5 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-6><a href=#cb7-6 aria-hidden=true tabindex=-1></a> <span class=ex>Performance</span> counter stats for <span class=st>'dd if=/dev/zero of=test bs=4000K count=1 oflag=direct'</span>:</span>
<span id=cb7-7><a href=#cb7-7 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-8><a href=#cb7-8 aria-hidden=true tabindex=-1></a>                 <span class=ex>1</span>      context-switches</span>
<span id=cb7-9><a href=#cb7-9 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-10><a href=#cb7-10 aria-hidden=true tabindex=-1></a>       <span class=ex>0.007534555</span> seconds time elapsed</span>
<span id=cb7-11><a href=#cb7-11 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-12><a href=#cb7-12 aria-hidden=true tabindex=-1></a>       <span class=ex>0.000000000</span> seconds user</span>
<span id=cb7-13><a href=#cb7-13 aria-hidden=true tabindex=-1></a>       <span class=ex>0.005731000</span> seconds sys</span>
<span id=cb7-14><a href=#cb7-14 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-15><a href=#cb7-15 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-16><a href=#cb7-16 aria-hidden=true tabindex=-1></a><span class=ex>yunchih@angel</span> $ sudo perf stat <span class=at>-e</span> context-switches dd if=/dev/zero of=test bs=4K count=1000 oflag=direct</span>
<span id=cb7-17><a href=#cb7-17 aria-hidden=true tabindex=-1></a><span class=ex>1000+0</span> records in</span>
<span id=cb7-18><a href=#cb7-18 aria-hidden=true tabindex=-1></a><span class=ex>1000+0</span> records out</span>
<span id=cb7-19><a href=#cb7-19 aria-hidden=true tabindex=-1></a><span class=ex>4096000</span> bytes <span class=er>(</span><span class=ex>4.1</span> MB, 3.9 MiB<span class=kw>)</span> <span class=ex>copied,</span> 0.0216545 s, 189 MB/s</span>
<span id=cb7-20><a href=#cb7-20 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-21><a href=#cb7-21 aria-hidden=true tabindex=-1></a> <span class=ex>Performance</span> counter stats for <span class=st>'dd if=/dev/zero of=test bs=4K count=1000 oflag=direct'</span>:</span>
<span id=cb7-22><a href=#cb7-22 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-23><a href=#cb7-23 aria-hidden=true tabindex=-1></a>             <span class=ex>1,000</span>      context-switches</span>
<span id=cb7-24><a href=#cb7-24 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-25><a href=#cb7-25 aria-hidden=true tabindex=-1></a>       <span class=ex>0.023533212</span> seconds time elapsed</span>
<span id=cb7-26><a href=#cb7-26 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-27><a href=#cb7-27 aria-hidden=true tabindex=-1></a>       <span class=ex>0.000000000</span> seconds user</span>
<span id=cb7-28><a href=#cb7-28 aria-hidden=true tabindex=-1></a>       <span class=ex>0.015128000</span> seconds sys</span>
<span id=cb7-29><a href=#cb7-29 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-30><a href=#cb7-30 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-31><a href=#cb7-31 aria-hidden=true tabindex=-1></a><span class=ex>yunchih@angel</span> $ sudo perf stat <span class=at>-e</span> context-switches dd if=/dev/zero of=test bs=4000K count=1</span>
<span id=cb7-32><a href=#cb7-32 aria-hidden=true tabindex=-1></a><span class=ex>1+0</span> records in</span>
<span id=cb7-33><a href=#cb7-33 aria-hidden=true tabindex=-1></a><span class=ex>1+0</span> records out</span>
<span id=cb7-34><a href=#cb7-34 aria-hidden=true tabindex=-1></a><span class=ex>4096000</span> bytes <span class=er>(</span><span class=ex>4.1</span> MB, 3.9 MiB<span class=kw>)</span> <span class=ex>copied,</span> 0.00784169 s, 522 MB/s</span>
<span id=cb7-35><a href=#cb7-35 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-36><a href=#cb7-36 aria-hidden=true tabindex=-1></a> <span class=ex>Performance</span> counter stats for <span class=st>'dd if=/dev/zero of=test bs=4000K count=1'</span>:</span>
<span id=cb7-37><a href=#cb7-37 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-38><a href=#cb7-38 aria-hidden=true tabindex=-1></a>                 <span class=ex>3</span>      context-switches</span>
<span id=cb7-39><a href=#cb7-39 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-40><a href=#cb7-40 aria-hidden=true tabindex=-1></a>       <span class=ex>0.010150750</span> seconds time elapsed</span>
<span id=cb7-41><a href=#cb7-41 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-42><a href=#cb7-42 aria-hidden=true tabindex=-1></a>       <span class=ex>0.000000000</span> seconds user</span>
<span id=cb7-43><a href=#cb7-43 aria-hidden=true tabindex=-1></a>       <span class=ex>0.008459000</span> seconds sys</span>
<span id=cb7-44><a href=#cb7-44 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-45><a href=#cb7-45 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-46><a href=#cb7-46 aria-hidden=true tabindex=-1></a><span class=ex>yunchih@angel</span> $ sudo perf stat <span class=at>-e</span> context-switches dd if=/dev/zero of=test bs=4K count=1000</span>
<span id=cb7-47><a href=#cb7-47 aria-hidden=true tabindex=-1></a><span class=ex>1000+0</span> records in</span>
<span id=cb7-48><a href=#cb7-48 aria-hidden=true tabindex=-1></a><span class=ex>1000+0</span> records out</span>
<span id=cb7-49><a href=#cb7-49 aria-hidden=true tabindex=-1></a><span class=ex>4096000</span> bytes <span class=er>(</span><span class=ex>4.1</span> MB, 3.9 MiB<span class=kw>)</span> <span class=ex>copied,</span> 0.00718135 s, 570 MB/s</span>
<span id=cb7-50><a href=#cb7-50 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-51><a href=#cb7-51 aria-hidden=true tabindex=-1></a> <span class=ex>Performance</span> counter stats for <span class=st>'dd if=/dev/zero of=test bs=4K count=1000'</span>:</span>
<span id=cb7-52><a href=#cb7-52 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-53><a href=#cb7-53 aria-hidden=true tabindex=-1></a>                 <span class=ex>4</span>      context-switches</span>
<span id=cb7-54><a href=#cb7-54 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-55><a href=#cb7-55 aria-hidden=true tabindex=-1></a>       <span class=ex>0.010053949</span> seconds time elapsed</span>
<span id=cb7-56><a href=#cb7-56 aria-hidden=true tabindex=-1></a></span>
<span id=cb7-57><a href=#cb7-57 aria-hidden=true tabindex=-1></a>       <span class=ex>0.004513000</span> seconds user</span>
<span id=cb7-58><a href=#cb7-58 aria-hidden=true tabindex=-1></a>       <span class=ex>0.004513000</span> seconds sys</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></div></div></div></section></section><section id=latency-vs.-throughput class=level2><h2 class=anchored data-anchor-id=latency-vs.-throughput>Latency vs.&nbsp;Throughput</h2><p>Storage devices have two different performance characteristics that often work <strong>against</strong> each other.<ul><li><p><span class=red><strong>Latency</strong></span> is the time it takes to satisfy <strong>a single</strong> read or write request. If you read a single 4 KB page from disk, how long does it take to get it? For a modern SSD, this might be around 100 microseconds. For a traditional hard disk, it could be 10 milliseconds. Latency determines how fast an operation feels.<li><p><span class=green><strong>Throughput</strong></span> (also called <strong>bandwidth</strong>) is how many read or write operations a device can complete per second, or equivalently, how many bytes per second it can transfer. A device might have a throughput of 500 MB/second, meaning it can transfer 500 million bytes in one second.</ul><p>Here’s where it gets interesting. You might think that low latency and high throughput always go together, but they don’t. Consider shipping. An airplane has <span class=red><strong>low latency</strong></span>: your package arrives in a few days. But an airplane has <span class=green><strong>low throughput</strong></span>: only a few packages fly per day. A container ship, on the other hand, has <span class=red><strong>high latency</strong></span> (your package takes months) but <span class=green><strong>very high throughput</strong></span> (thousands of packages travel together).<p>SSD works similarly: a single random read has relatively high latency, but when you queue up many reads simultaneously, the throughput can be enormous.<div class="quarto-figure quarto-figure-center" style=margin:10px;max-width:400px;float:right><figure class=figure><p><img src=https://maxfreights.com/wp-content/uploads/2021/06/Air-vs-Sea-1-1536x864.jpg class="img-fluid figure-img"><figcaption><a href=https://maxfreights.com/air-freight-vs-sea-freight/>source</a></figcaption></figure></div><p>This is measured by something called <span class=green><strong>queue depth</strong></span> (QD). If your application sends one I/O request and then waits for it to complete before sending the next request, you have a queue depth of 1. But if your application sends 32 I/O requests simultaneously and lets them queue up inside the SSD controller, you have a queue depth of 32. At queue depth 32, the SSD can achieve much higher throughput, even though individual requests might experience higher latency (since they wait in queue).<p>Here is a typical I/O benchmark (Micron Storage Benchmark: <a href=https://www.micron.com/about/blog/storage/ssd/millions-iops-networked-file-system>source</a>): <img src=../images/fig-3-4kb-100-random-writes.jpg class=img-fluid><p>As you can see, when the QD (queue depth) increases, both throughput and latency increase. That is why write buffering is useful. The kernel collects sufficient among of dirty pages and <strong>flushes the cache at once into the SSD</strong>. By doing so, it can enjoy a good write bandwidth because the queue depth is high.<p><img src=../images/flush-the-cache.png class=img-fluid></section><section id=page-alignment class=level2><h2 class=anchored data-anchor-id=page-alignment>Page Alignment</h2><p>When using direct I/O or memory-mapped I/O, your buffers must be <span class=green><strong>4 KB aligned</strong></span>. This means the starting address of your buffer must be a multiple of 4096. For example, address 0x1000 is aligned, but address 0x1001 is not.<div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-5-contents aria-controls=callout-5 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Example alignment check</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-5 class="callout-5-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>Observe: <code>posix_memalign</code> guarantees 4 KB alignment; <code>malloc</code> does not.<div class=sourceCode id=cb8><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb8-1><a href=#cb8-1 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;stdio.h&gt;</span></span>
<span id=cb8-2><a href=#cb8-2 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;stdint.h&gt;</span></span>
<span id=cb8-3><a href=#cb8-3 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;stdlib.h&gt;</span></span>
<span id=cb8-4><a href=#cb8-4 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>&lt;malloc.h&gt;</span></span>
<span id=cb8-5><a href=#cb8-5 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-6><a href=#cb8-6 aria-hidden=true tabindex=-1></a><span class=dt>int</span> main<span class=op>(){</span></span>
<span id=cb8-7><a href=#cb8-7 aria-hidden=true tabindex=-1></a>    <span class=dt>void</span> <span class=op>*</span>p1 <span class=op>=</span> malloc<span class=op>(</span><span class=dv>4096</span><span class=op>),</span> <span class=op>*</span>p2<span class=op>;</span></span>
<span id=cb8-8><a href=#cb8-8 aria-hidden=true tabindex=-1></a>    posix_memalign<span class=op>(&amp;</span>p2<span class=op>,</span> <span class=dv>4096</span><span class=op>,</span> <span class=dv>4096</span><span class=op>);</span></span>
<span id=cb8-9><a href=#cb8-9 aria-hidden=true tabindex=-1></a>    printf<span class=op>(</span><span class=st>"malloc ptr   = </span><span class=sc>%p</span><span class=st> (</span><span class=sc>%%</span><span class=st>4096=</span><span class=sc>%zu</span><span class=st>)</span><span class=sc>\n</span><span class=st>"</span><span class=op>,</span> p1<span class=op>,</span> <span class=op>(</span><span class=dt>size_t</span><span class=op>)((</span><span class=dt>uintptr_t</span><span class=op>)</span>p1 <span class=op>%</span> <span class=dv>4096</span><span class=op>));</span></span>
<span id=cb8-10><a href=#cb8-10 aria-hidden=true tabindex=-1></a>    printf<span class=op>(</span><span class=st>"aligned ptr  = </span><span class=sc>%p</span><span class=st> (</span><span class=sc>%%</span><span class=st>4096=</span><span class=sc>%zu</span><span class=st>)</span><span class=sc>\n</span><span class=st>"</span><span class=op>,</span> p2<span class=op>,</span> <span class=op>(</span><span class=dt>size_t</span><span class=op>)((</span><span class=dt>uintptr_t</span><span class=op>)</span>p2 <span class=op>%</span> <span class=dv>4096</span><span class=op>));</span></span>
<span id=cb8-11><a href=#cb8-11 aria-hidden=true tabindex=-1></a>    free<span class=op>(</span>p1<span class=op>);</span> free<span class=op>(</span>p2<span class=op>);</span></span>
<span id=cb8-12><a href=#cb8-12 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> <span class=dv>0</span><span class=op>;</span></span>
<span id=cb8-13><a href=#cb8-13 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></div></div></div><p>Why does alignment matter? Recall that disk pages are 4 KB and memory pages are 4 KB. When the kernel transfers data directly between memory and disk without intermediate copying, it must align memory pages with disk pages exactly. If your buffer started at an unaligned address, the kernel would have to perform internal copying to align the data, defeating the purpose of direct I/O.</section><section id=cache-inside-ssd class="level2 page-columns page-full"><h2 class=anchored data-anchor-id=cache-inside-ssd>Cache inside SSD</h2><p>Modern SSDs have their own internal caching to increase write performance, known as <span class=green><strong>SLC cache</strong></span>.<p>When you write data to an SSD, it initially goes to the SLC cache. As long as the amount of data doesn’t exceed the SLC cache capacity, writes are very fast. But once the SLC cache fills up, the SSD must flush the cache to the slower internal storage. This will cause a terrible performance drop.<p>In this benchmark, the write bandwidth of Samsung 980 PRO drops from 4000MB/s to 2000MB/s when its SLC cache is filled:<div class="quarto-figure quarto-figure-center"><figure class=figure><p><img src=https://tpucdn.com/review/samsung-980-pro-1-tb-ssd/images/write-over-time.png class="img-fluid figure-img"><figcaption><a href=https://www.techpowerup.com/review/samsung-980-pro-1-tb-ssd/6.html>Samsung benchmark</a></figcaption></figure></div><div class="no-row-height column-margin column-container"><div class=margin-aside><p>You can see the SLC size of different SSDs <a href=https://www.techpowerup.com/review/samsung-980-pro-1-tb-ssd/6.html>here</a></div></div><p>This benchmark tests the write performance of a portable SSD:<div class="quarto-figure quarto-figure-center"><figure class=figure><p><img src=../images/StorageReview-Portable-SSD-Performance-Seq-TB3.jpg class="img-fluid figure-img"><figcaption><a href=https://www.storagereview.com/review/the-best-portable-ssd-for-sustained-performance>Source</a></figcaption></figure></div><p>The SLC cache of these SSDs seem to be very small or there is none. Notice that the write bandwidth jumps up and down. This is because when you keep writing and writing, the disk can become too hot. The disk controller will reduce performance to protect itself from burning out. When the temperature reduces, the disk controller can again raise the bandwidth.</section><section id=cache-is-deceptive class=level2><h2 class=anchored data-anchor-id=cache-is-deceptive>Cache is Deceptive</h2><p>Caching has a huge influence on system performance, but it can also be deeply deceiving. When you buy a new SSD, you feel excited in the first few weeks. Write is so fast! But then, as you write more data into the SSD, you slowly discover the “reality” (國王的新衣). The performance drops …<blockquote class=blockquote><p>“The bitterness of poor quality remains long after the sweetness of low price is forgotten.” ― Benjamin Franklin</blockquote><p>This is why you must be skeptical when companies advertise performance numbers. Under what conditions did they benchmark? Was the drive empty or 80% full? Did they test with queue depth 1 or queue depth 32? Did they measure peak performance or sustained performance over 30 minutes? Were the caches warm or cold? Many vendors show you the best-case scenario (a quick burst write to an empty SSD with a warm cache) but real-world workloads don’t always look like that.<p>When you benchmark your own programs, caching makes measurement tricky. Consider the <a href=https://github.com/sharkdp/hyperfine><code>hyperfine</code> tool</a>, which is excellent for command-line benchmarking. Its documentation explicitly warns about cache effects:<blockquote class=blockquote><p>For programs that perform a lot of disk I/O, the benchmarking results can be heavily influenced by disk caches and whether they are cold or warm.</blockquote><p>If you want consistent measurements, you need to control the cache state. You can use the <code>--warmup</code> option to run your program a few times before measuring. This ensures the cache is warm:<div class=sourceCode id=cb9><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb9-1><a href=#cb9-1 aria-hidden=true tabindex=-1></a><span class=ex>hyperfine</span> <span class=at>--warmup</span> 3 <span class=st>'grep -R TODO *'</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>This gives you the <span class=blue>“best case”</span> performance, which might be representative if your program runs repeatedly on the same data.<p>But what if you want to measure the <span class=red>worst case</span> performance, the cold-cache scenario? You need to explicitly clear the page cache before each benchmark run:<div class=sourceCode id=cb10><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb10-1><a href=#cb10-1 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> 3 <span class=kw>|</span> <span class=fu>sudo</span> tee /proc/sys/vm/drop_caches</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>This command tells the kernel to remove all pages from the buffer cache. Then, your next <code>read()</code> will cache miss and must read from the disk.<div class="callout callout-style-default callout-tip callout-titled"><div class="callout-header d-flex align-content-center"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Tip</div></div><div class="callout-body-container callout-body"><p><strong>Caching makes systems fast, but it also makes them unpredictable.</strong> As a systems programmer, your job is to understand these layers deeply enough that you can predict and control performance, rather than being surprised by it.</div></div></section><section id=conclusion class=level2><h2 class=anchored data-anchor-id=conclusion>Conclusion</h2><p>We human are incredibly slow compared to computers. When you type at your keyboard, you might produce a few characters per second—maybe 5 to 10 keystrokes if you’re fast. Each keystroke is just one byte. But in that same second, your computer can transfer millions of bytes and perform billions of calculations.<p>This is why the operating system doesn’t handle data one byte at a time. It would be absurd for the OS to perform a separate disk operation for each character you type. Instead, the OS works in units of 4 KB pages because that’s the natural disk I/O size. The OS automatically coalesces your tiny writes into page-sized operations.<p>The OS also uses caching to hide the slowness of disk. It would be absurd if every time you wanted to eat 鮭魚, you had to fly to Norway. When you read a file the first time, yes, it’s slow … you’re going to Norway. But the OS keeps that data in the buffer cache. The second time you read the same file, you’re just opening your refrigerator. When you open VS Code and it loads in 2 seconds, you’re reading from cached pages in DRAM that were loaded during previous sessions.<p><strong>This is the magic trick of OS: it makes the disk appear far faster than it actually is.</strong></p></section></section><a onclick="return window.scrollTo(0,0),!1" role=button id=quarto-back-to-top><i class="bi bi-arrow-up"></i> Back to top</a></main><script id=quarto-html-after-body>window.document.addEventListener("DOMContentLoaded",function(){const j="",c=new window.AnchorJS;c.options={placement:"right",icon:j},c.add(".anchored");const v=e=>{for(const t of e.classList)if(t.startsWith("code-annotation-"))return!0;return!1},p=function(e){const t=e.trigger;t.blur(),t.classList.add("code-copy-button-checked");var s=t.getAttribute("title");t.setAttribute("title","Copied!");let n;window.bootstrap&&(t.setAttribute("data-bs-toggle","tooltip"),t.setAttribute("data-bs-placement","left"),t.setAttribute("data-bs-title","Copied!"),n=new bootstrap.Tooltip(t,{trigger:"manual",customClass:"code-copy-button-tooltip",offset:[0,-8]}),n.show()),setTimeout(function(){n&&(n.hide(),t.removeAttribute("data-bs-title"),t.removeAttribute("data-bs-toggle"),t.removeAttribute("data-bs-placement")),t.setAttribute("title",s),t.classList.remove("code-copy-button-checked")},1e3),e.clearSelection()},m=function(e){const t=e.previousElementSibling.cloneNode(!0);for(const e of t.children)v(e)&&e.remove();return t.innerText},b=new window.ClipboardJS(".code-copy-button:not([data-in-quarto-modal])",{text:m});if(b.on("success",p),window.document.getElementById("quarto-embedded-source-code-modal")){const e=new window.ClipboardJS(".code-copy-button[data-in-quarto-modal]",{text:m,container:window.document.getElementById("quarto-embedded-source-code-modal")});e.on("success",p)}for(var s,g=new RegExp(/^(?:http|https):\/\/localhost:?[0-9]*\//),x=new RegExp(/^mailto:/),O=new RegExp("/"+window.location.host+"/"),w=e=>O.test(e)||g.test(e)||x.test(e),u=window.document.querySelectorAll("a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)"),t=0;t<u.length;t++){const e=u[t];w(e.href)||(e.dataset.originalHref!==0[0]&&(e.href=e.dataset.originalHref),e.setAttribute("target","_blank"),e.getAttribute("rel")===null&&e.setAttribute("rel","noopener"),e.classList.add("external"))}function i(e,t,n,s){const o={allowHTML:!0,maxWidth:500,delay:100,arrow:!1,appendTo:function(e){return e.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"bottom-start"};t&&(o.content=t),n&&(o.onTrigger=n),s&&(o.onUntrigger=s),window.tippy(e,o)}const f=window.document.querySelectorAll('a[role="doc-noteref"]');for(t=0;t<f.length;t++){const e=f[t];i(e,function(){let t=e.getAttribute("data-footnote-href")||e.getAttribute("href");try{t=new URL(t).hash}catch{}const s=t.replace(/^#\/?/,""),n=window.document.getElementById(s);return n?n.innerHTML:""})}const r=window.document.querySelectorAll("a.quarto-xref"),o=(e,t)=>{const n=e=>{if(e.classList.remove("page-full","page-columns"),e.children)for(const t of e.children)n(t)};if(n(t),e===null||e.startsWith("sec-")){const e=document.createElement("div");if(t.children&&t.children.length>2){e.appendChild(t.children[0].cloneNode(!0));for(let n=1;n<t.children.length;n++){const s=t.children[n];if(s.tagName==="P"&&s.innerText==="")continue;e.appendChild(s.cloneNode(!0));break}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(e),e.innerHTML}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.innerHTML}else{const e=t.querySelector("a.anchorjs-link");return e&&e.remove(),window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.classList.contains("callout")?t.outerHTML:t.innerHTML}};for(t=0;t<r.length;t++){const e=r[t];i(e,0[0],function(t){t.disable();let n=e.getAttribute("href"),s=0[0];if(n.startsWith("#"))s=n;else try{s=new URL(n).hash}catch{}if(s){const e=s.replace(/^#\/?/,""),i=window.document.getElementById(e);if(i!==null)try{const n=o(e,i.cloneNode(!0));t.setContent(n)}finally{t.enable(),t.show()}else fetch(n.split("#")[0]).then(e=>e.text()).then(n=>{const i=new DOMParser,a=i.parseFromString(n,"text/html"),s=a.getElementById(e);if(s!==null){const n=o(e,s);t.setContent(n)}}).finally(()=>{t.enable(),t.show()})}else fetch(n).then(e=>e.text()).then(e=>{const s=new DOMParser,i=s.parseFromString(e,"text/html"),n=i.querySelector("main.content");if(n!==null){n.children.length>0&&n.children[0].tagName==="HEADER"&&n.children[0].remove();const e=o(null,n);t.setContent(e)}}).finally(()=>{t.enable(),t.show()})},function(){})}let n;const h=(e,t)=>{let n='data-code-cell="'+e+'"',s='data-code-annotation="'+t+'"';const o="span["+n+"]["+s+"]";return o},a=e=>{const d=window.document,i=e.getAttribute("data-target-cell"),r=e.getAttribute("data-target-annotation"),c=window.document.querySelector(h(i,r)),l=c.getAttribute("data-code-lines").split(","),t=l.map(e=>i+"-"+e);let s=null,o=null,a=null;if(t.length>0){const r=window.document.getElementById(t[0]);if(s=r.offsetTop,o=r.offsetHeight,a=r.parentElement.parentElement,t.length>1){const e=window.document.getElementById(t[t.length-1]),n=e.offsetTop+e.offsetHeight;o=n-s}if(s!==null&&o!==null&&a!==null){let e=window.document.getElementById("code-annotation-line-highlight");e===null&&(e=window.document.createElement("div"),e.setAttribute("id","code-annotation-line-highlight"),e.style.position="absolute",a.appendChild(e)),e.style.top=s-2+"px",e.style.height=o+4+"px",e.style.left=0;let t=window.document.getElementById("code-annotation-line-highlight-gutter");if(t===null){t=window.document.createElement("div"),t.setAttribute("id","code-annotation-line-highlight-gutter"),t.style.position="absolute";const e=window.document.getElementById(i),n=e.querySelector(".code-annotation-gutter");n.appendChild(t)}t.style.top=s-2+"px",t.style.height=o+4+"px"}n=e}},y=()=>{const e=["code-annotation-line-highlight","code-annotation-line-highlight-gutter"];e.forEach(e=>{const t=window.document.getElementById(e);t&&t.remove()}),n=0[0]};window.addEventListener("resize",_(()=>{elRect=0[0],n&&a(n)},10));function _(e,t){let s=!1,n;return(...o)=>{s?(n&&clearTimeout(n),n=setTimeout(()=>{e.apply(this,o),n=s=!1},t)):(e.apply(this,o),s=!0)}}const d=window.document.querySelectorAll(".code-annotation-anchor");for(let e=0;e<d.length;e++){const t=d[e],n=t.getAttribute("data-target-cell"),s=t.getAttribute("data-target-annotation"),o=()=>{const e=window.document.querySelector(h(n,s));if(e){const t=e.cloneNode(!0);return t.classList.add("code-annotation-tip-content"),t.outerHTML}},i={allowHTML:!0,content:o,onShow:e=>{a(e.reference),e.reference.classList.add("code-annotation-active"),window.tippy.hideAll()},onHide:e=>{y(),e.reference.classList.remove("code-annotation-active")},maxWidth:300,delay:[50,0],duration:[200,0],offset:[5,10],arrow:!0,appendTo:function(e){return e.parentElement.parentElement.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"right",popperOptions:{modifiers:[{name:"flip",options:{flipVariations:!1,allowedAutoPlacements:["right"],fallbackPlacements:["right","top","top-start","top-end","bottom","bottom-start","bottom-end","left"]}},{name:"preventOverflow",options:{mainAxis:!1,altAxis:!1}}]}};window.tippy(t,i)}const l=e=>{const t=e.parentElement;if(t){const n=t.dataset.cites;return n?{el:e,cites:n.split(" ")}:l(e.parentElement)}else return 0[0]};for(s=window.document.querySelectorAll('a[role="doc-biblioref"]'),t=0;t<s.length;t++){const n=s[t],e=l(n);e&&i(e.el,function(){var t=window.document.createElement("div");return e.cites.forEach(function(e){var s,n=window.document.createElement("div");n.classList.add("hanging-indent"),n.classList.add("csl-entry"),s=window.document.getElementById("ref-"+e),s&&(n.innerHTML=s.innerHTML),t.appendChild(n)}),t.innerHTML})}})</script></div><footer class=footer><div class=nav-footer><div class=nav-footer-left><p><img id=footer-cat-left src=../images/cat-left.png alt="Cat Left"></div><div class=nav-footer-center><p><span id=footer-center>Made with ❤️ by Tony, (CC&nbsp;BY&nbsp;4.0)<br><span style=font-size:8px>Cat source: Freepik and ChatGPT</span></span></div><div class=nav-footer-right><p><img id=footer-cat-right src=../images/cat-right.png alt="Cat Right"></div></div></footer>
<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en xml:lang=en><meta charset=utf-8><meta name=generator content="quarto-1.7.33"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><title>vm-page-size – Operating System (2025 Fall)</title><style>code{white-space:pre-wrap}span.smallcaps{font-variant:small-caps}div.columns{display:flex;gap:min(4vw,1.5em)}div.column{flex:auto;overflow-x:auto}div.hanging-indent{margin-left:1.5em;text-indent:-1.5em}ul.task-list{list-style:none}ul.task-list li input[type=checkbox]{width:.8em;margin:0 .8em .2em -1em;vertical-align:middle}</style><script src=../site_libs/quarto-nav/quarto-nav.js></script><script src=../site_libs/clipboard/clipboard.min.js></script><script src=../site_libs/quarto-search/autocomplete.umd.js></script><script src=../site_libs/quarto-search/fuse.min.js></script><script src=../site_libs/quarto-search/quarto-search.js></script><meta name=quarto:offset content="../"><link href=../images/orange.png rel=icon type=image/png><script src=../site_libs/quarto-html/quarto.js type=module></script><script src=../site_libs/quarto-html/tabsets/tabsets.js type=module></script><script src=../site_libs/quarto-html/popper.min.js></script><script src=../site_libs/quarto-html/tippy.umd.min.js></script><script src=../site_libs/quarto-html/anchor.min.js></script><link href=../site_libs/quarto-html/tippy.css rel=stylesheet><link href=../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css rel=stylesheet id=quarto-text-highlighting-styles><script src=../site_libs/bootstrap/bootstrap.min.js></script><link href=../site_libs/bootstrap/bootstrap-icons.css rel=stylesheet><link href=../site_libs/bootstrap/bootstrap-a3d6f4078ec9f2632a80ad631344d584.min.css rel=stylesheet append-hash=true id=quarto-bootstrap data-mode=light><script id=quarto-search-options type=application/json>{"location":"navbar","copy-button":false,"collapse-after":3,"panel-placement":"end","type":"overlay","limit":50,"keyboard-shortcut":["f","/","s"],"show-item-context":false,"language":{"search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search"}}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js></script><script>const typesetMath=e=>{if(window.MathJax)window.MathJax.typeset([e]);else if(window.katex)for(var s,n=e.getElementsByClassName("math"),o=[],t=0;t<n.length;t++)s=n[t].firstChild,n[t].tagName=="SPAN"&&window.katex.render(s.data,n[t],{displayMode:n[t].classList.contains("display"),throwOnError:!1,macros:o,fleqn:!1})};window.Quarto={typesetMath}</script><body class="nav-sidebar docked nav-fixed slimcontent quarto-light"><div id=quarto-search-results></div><header id=quarto-header class="headroom fixed-top"><nav class="navbar navbar-expand-lg" data-bs-theme=dark><div class="navbar-container container-fluid"><div class="navbar-brand-container mx-auto"><a class=navbar-brand href=../index.html><span class=navbar-title>Operating System (2025 Fall)</span></a></div><div id=quarto-search title=Search></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarCollapse aria-controls=navbarCollapse role=menu aria-expanded=false aria-label="Toggle navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarCollapse><ul class="navbar-nav navbar-nav-scroll me-auto"><li class=nav-item><a class="nav-link active" href=../index.html aria-current=page><span class=menu-text>Home</span></a><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-handouts role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Handouts</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-handouts><li><a class=dropdown-item href=../handouts/env_setup.html><span class=dropdown-text>Environment Setup</span></a><li><a class=dropdown-item href=../handouts/unix.html><span class=dropdown-text>Unix</span></a><li><a class=dropdown-item href=../handouts/privilege.html><span class=dropdown-text>Privilege</span></a><li><a class=dropdown-item href=../handouts/scheduler.html><span class=dropdown-text>Scheduler</span></a><li><a class=dropdown-item href=../handouts/buffercache.html><span class=dropdown-text>Buffer Cache</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-labs role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Labs</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-labs><li><a class=dropdown-item href=../labs/mini-cloud.html><span class=dropdown-text>Mini Cloud</span></a><li><a class=dropdown-item href=../labs/linking.html><span class=dropdown-text>Linking</span></a><li><a class=dropdown-item href=../labs/process-creation.html><span class=dropdown-text>Process Creation</span></a><li><a class=dropdown-item href=../labs/process-state.html><span class=dropdown-text>Process State</span></a><li><a class=dropdown-item href=../labs/process-address-space.html><span class=dropdown-text>Process Address Space</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/path-traversal.html><span class=dropdown-text>Path Traversal</span></a><li><a class=dropdown-item href=../labs/pipe-passwords.html><span class=dropdown-text>Pipe Passwords</span></a><li><a class=dropdown-item href=../labs/pipe-dup.html><span class=dropdown-text>Pipe and dup()</span></a><li><a class=dropdown-item href=../labs/pipe-pingpong.html><span class=dropdown-text>Pipe Ping-Pong</span></a><li><a class=dropdown-item href=../labs/fifo.html><span class=dropdown-text>FIFO (named pipe)</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/cat.html><span class=dropdown-text>Cat</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/xv6-syscall.html><span class=dropdown-text>xv6 System Call Tracing</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-admin role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Admin</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-admin><li><a class=dropdown-item href=../admin/policies.html><span class=dropdown-text>Policies</span></a><li><a class=dropdown-item href=../admin/explore.html><span class=dropdown-text>Exploratory Projects</span></a><li><a class=dropdown-item href=../admin/waitbutwhy.html><span class=dropdown-text>SD1↓ (燒蛋一下)</span></a></ul></ul><ul class="navbar-nav navbar-nav-scroll ms-auto"><li class="nav-item compact"><a class=nav-link href="https://elearn.nthu.edu.tw/course/view.php?id=38873"><i class="bi bi-globe" role=img></i><span class=menu-text></span></a></ul></div><div class=quarto-navbar-tools></div></div></nav><nav class=quarto-secondary-nav><div class="container-fluid d-flex"><button type=button class="quarto-btn-toggle btn" data-bs-toggle=collapse role=button data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<i class="bi bi-layout-text-sidebar-reverse"></i></button><nav class=quarto-page-breadcrumbs aria-label=breadcrumb><ol class=breadcrumb></ol></nav><a class=flex-grow-1 role=navigation data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()></a><button type=button class="btn quarto-search-button" aria-label=Search onclick=window.quartoOpenSearch()>
<i class="bi bi-search"></i></button></div></nav></header><div id=quarto-content class="quarto-container page-columns page-rows-contents page-layout-article page-navbar"><nav id=quarto-sidebar class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center"><div class=sidebar-search><div id=quarto-search title=Search></div></div></div><div class=sidebar-menu-container><ul class="list-unstyled mt-1"><li class=sidebar-item><div class=sidebar-item-container><a href=../index.html class="sidebar-item-text sidebar-link"><span class=menu-text>OS 2025 Fall</span></a></div><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w2.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 2</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-1 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-1 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/env_setup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Environment setup</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w3.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 3</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-2 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-2 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/unix.html class="sidebar-item-text sidebar-link"><span class=menu-text>Unix Philosophy</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/mini-cloud.html class="sidebar-item-text sidebar-link"><span class=menu-text>Your First Week in OS Journey</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-creation.html class="sidebar-item-text sidebar-link"><span class=menu-text><code>fork()</code>/<code>exec()</code></span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w4.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 4</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-3 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-3 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/privilege.html class="sidebar-item-text sidebar-link"><span class=menu-text>Privilege</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/path-traversal.html class="sidebar-item-text sidebar-link"><span class=menu-text>Lab: Path Traversal Attack</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-address-space.html class="sidebar-item-text sidebar-link"><span class=menu-text>Address Space Layout</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/linking.html class="sidebar-item-text sidebar-link"><span class=menu-text>Static vs Dynamic Linking</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w5.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 5</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-4 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-4 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-passwords.html class="sidebar-item-text sidebar-link"><span class=menu-text>Parallelizing Rainbow Table Lookup with Pipes</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-dup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipes, Redirection, and File Descriptors</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/fifo.html class="sidebar-item-text sidebar-link"><span class=menu-text>FIFO (named pipe)</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w6.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 6</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-5 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-5 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/scheduler.html class="sidebar-item-text sidebar-link"><span class=menu-text>Schedulers</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-state.html class="sidebar-item-text sidebar-link"><span class=menu-text>Process States in Linux</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-pingpong.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipe Pingpong</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w8.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 8</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-6 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-6 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/buffercache.html class="sidebar-item-text sidebar-link"><span class=menu-text>Caching and Buffering</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/cat.html class="sidebar-item-text sidebar-link"><span class=menu-text>How <code>cat</code> works?</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w9.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 9</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-7 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-7 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-intro.html class="sidebar-item-text sidebar-link"><span class=menu-text>Introduction to xv6</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-gdb.html class="sidebar-item-text sidebar-link"><span class=menu-text>GNU Debugger Tutorial</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-syscall.html class="sidebar-item-text sidebar-link"><span class=menu-text>xv6 Syscall Tracing</span></a></div></ul></ul></div></nav><div id=quarto-sidebar-glass class=quarto-sidebar-collapse-item data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item></div><div id=quarto-margin-sidebar class="sidebar margin-sidebar"><nav id=TOC role=doc-toc class=toc-active><h2 id=toc-title>On this page</h2><ul><li><a href=#why-android-moved-to-16kb-pages id=toc-why-android-moved-to-16kb-pages class="nav-link active" data-scroll-target=#why-android-moved-to-16kb-pages>Why Android Moved to 16KB Pages</a><ul class=collapse><li><a href=#androids-early-day id=toc-androids-early-day class=nav-link data-scroll-target=#androids-early-day>Android’s Early Day</a><ul class=collapse><li><a href=#memory-poverty id=toc-memory-poverty class=nav-link data-scroll-target=#memory-poverty>Memory Poverty</a><li><a href=#running-java id=toc-running-java class=nav-link data-scroll-target=#running-java>Running Java</a></ul><li><a href=#the-4kb-legacy id=toc-the-4kb-legacy class=nav-link data-scroll-target=#the-4kb-legacy>The 4KB Legacy</a><li><a href=#apple-silicon-16kb-page id=toc-apple-silicon-16kb-page class=nav-link data-scroll-target=#apple-silicon-16kb-page>Apple Silicon: 16KB Page</a><li><a href=#fragmentation id=toc-fragmentation class=nav-link data-scroll-target=#fragmentation>Fragmentation</a><li><a href=#hybrid-pages id=toc-hybrid-pages class=nav-link data-scroll-target=#hybrid-pages>Hybrid pages?</a><li><a href=#android-in-the-age-of-abundance id=toc-android-in-the-age-of-abundance class=nav-link data-scroll-target=#android-in-the-age-of-abundance>Android in the age of abundance</a><li><a href=#kb-pages-page-table-structure id=toc-kb-pages-page-table-structure class=nav-link data-scroll-target=#kb-pages-page-table-structure>16KB Page’s Page Table Structure</a><li><a href=#lessons-for-you id=toc-lessons-for-you class=nav-link data-scroll-target=#lessons-for-you>Lessons for You</a><ul class=collapse><li><a href=#review-questions id=toc-review-questions class=nav-link data-scroll-target=#review-questions>Review Questions</a></ul></ul></ul></nav></div><main class="content page-columns page-full" id=quarto-document-content><header id=title-block-header class=quarto-title-block></header><section id=why-android-moved-to-16kb-pages class="level1 page-columns page-full"><h1>Why Android Moved to 16KB Pages</h1><p>In previous lectures, we learned how virtual memory gives each process its own isolated address space. We also learned how page tables translate virtual addresses into physical addresses, and how TLB caches recent translations to make this process fast.<p>We discussed fragmentation: Internal fragmentation is unused space inside an allocated page; external fragmentation is holes between allocated space.<p>4KB has long been the standard page size, but Google announced that <span class=green>from Android 15, it will support 16KB page size</span>. <span class=red>Why would an operating system increase page size when that could increase internal fragmentation?</span> Let’s trace the evolution of Android and see what has changed over the years.<div class="quarto-figure quarto-figure-center"><figure class=figure><p><img src=https://timgm.eprice.com.tw/tw/mobile/img/2024-10/16/5812939/eprice_1_409c909db009f93cbf1dd537a981e716.jpg class="img-fluid figure-img"><figcaption>Android 15</figcaption></figure></div><section id=androids-early-day class="level2 page-columns page-full"><h2 class=anchored data-anchor-id=androids-early-day>Android’s Early Day</h2><blockquote class=blockquote><p>窮則變, 變則通 (Innovation happens under huge constraints)</blockquote><p><strong>Android is born at the time of 192MB RAM.</strong><p>Small device, like a microwave controller, doesn’t need an MMU because it only runs a single application. It just uses raw physical addressing. But how do we support multi-tasking under extremely small memory? How to run Pokemon Go and Facebook at the same time???<div class="quarto-figure quarto-figure-center" style=max-width:300px><figure class=figure><p><img src=../images/multi-tasking.png class="img-fluid figure-img"><figcaption>Multi-tasking on Android</figcaption></figure></div><section id=memory-poverty class=level3><h3 class=anchored data-anchor-id=memory-poverty>Memory Poverty</h3><p>Your current phone probably has 12~16GB of RAM. But, consider one of the very first Android phones in 2008, the <a href=https://en.wikipedia.org/wiki/HTC_Dream><strong>HTC Dream</strong></a> (designed in Taiwan!).<div class="quarto-figure quarto-figure-center" style=max-width:300px><figure class=figure><p><img src=../images/htc.png class="img-fluid figure-img"><figcaption>HTC Dream Phone</figcaption></figure></div><p>It had <strong>192MB of RAM</strong>! The challenge was clear: How do you run an entire OS and multiple applications on that? The constraints forced engineers to think about innovative memory management.</p><p>On your desktop, you can open dozens of browser tabs without problems. On early smartphones, “switching apps” can mean killing and releasing memory used by the previous app. But, how do you create the <em>illusion</em> of multitasking? When you go back to the previous app, how to quickly go back to the previous state? How did the OS decide which app to sacrifice if memory is almost running out? This required carefully process lifecycle management, low-memory killer mechanisms, and efficient context switching. Applications had to save their state quickly to avoid data loss.</section><section id=running-java class="level3 page-columns page-full"><h3 class=anchored data-anchor-id=running-java>Running Java</h3><p>Android apps were written in Java (not in C/C++ like most embedded system). The programmer doesn’t need to <code>malloc</code>/<code>free</code> their memory like C++. Java’s runtime does automatic memory management. The challenge was making Java work on phones with small RAM and slow CPU without constant pauses for garbage collection or out-of-memory errors.<div class="no-row-height column-margin column-container"><div class=margin-aside><p>The material of this page is written after listening to this <a href=https://corecursive.com/android-with-chet-haase/>podcast: Android’s Unlikely Success</a>. This is an interview with former Google engineer in charge of Android.</div></div><p>Apple’s iPhone doesn’t have this problem because Apple controls both the hardware and software. Before the Pixel phone, Google wasn’t selling hardware. They licensed Android to run on devices from dozens of manufacturers: HTC, Samsung, etc, which makes it difficult to do many optimization specific to certain hardware.</section></section><section id=the-4kb-legacy class=level2><h2 class=anchored data-anchor-id=the-4kb-legacy>The 4KB Legacy</h2><p>Historically, most systems, including x86 and Linux, use <strong>4KB pages</strong>. This size dates back to the 1980s when physical memory was small and page tables had to fit in limited address space. Modern x86 systems use four-level page tables built around the 4KB unit, though they also support “huge pages” (2 MB or 1 GB) for special cases.<p>The 4KB page became the standard because it kind of balances page table overhead, TLB coverage, and internal fragmentation for the memory sizes of its time. But that balance point was chosen when main memory was measured in <strong>megabytes</strong>. Now, your smartphone easily has >12GB of DRAM.<p>Similar to the problem Google was facing, Intel and AMD cannot do many hardware optimization on x86-64 specific to certain software because they cannot control the OS running on top of it. If x86-64 suddenly switches its page size to 16KB, the vast software on top of it will be broken. Again, Apple doesn’t have this problem.<p>(Remember the PCID feature in TLB we mentioned in the lecture? This is indeed a hardware-software co-optimization feature because address space or process is a OS-level mechanism.)</section><section id=apple-silicon-16kb-page class=level2><h2 class=anchored data-anchor-id=apple-silicon-16kb-page>Apple Silicon: 16KB Page</h2><p>In 2013, Apple introduced the <strong>A7 chip</strong> (the first 64-bit ARM processor used in iPhones), which first used <strong>16KB pages</strong> for iOS (and later on M-series chip for Mac). Because Apple controls the hardware (<a href=https://en.wikipedia.org/wiki/Apple_silicon>Apple Silicon</a>), operating system (iOS and Mac OS X), it could enforce a single page size across all devices.<p><img src="https://www.cnet.com/a/img/resize/abe31dfc53d07f964294cbc7c830fe157402e645/hub/2013/09/14/f29762e7-6de1-11e3-913e-14feb5ca9861/a7-cnet.jpg?auto=webp&amp;fit=crop&amp;height=675&amp;width=1200" class=img-fluid><p>Larger pages reduce the number of entries needed in the page table and TLB. This increases the effective <em>coverage</em> of each TLB entry. From 4KB to 16KB, your TLB cover four times the memory, which means far fewer TLB misses and fewer slow, multi-level page table walks. Remember that PTE also occupies SRAM cache, so larger pages might also give us fewer cache misses.<p><a href=https://lemire.me/blog/2018/11/13/memory-level-parallelism-intel-skylake-versus-apple-a12-a12x/>Computer scientist Daniel Lemire</a> compared memory performance between high-end Intel Skylake processors and Apple’s A12 mobile chip (iPhone XR’s CPU in 2018, also in iPad and iPad Air). The results were surprising. The A12 has better memory scalability compared to the Intel chip, and it achieved this while consuming far less power. Intel’s processors were more power-hungry but didn’t necessarily deliver better performance in memory-intensive workloads.<div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-1-contents aria-controls=callout-1 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Why larger page size improves performance</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-1 class="callout-1-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>If you want to understand why larger page size improves performance, review a concept you might have learned in computer architecture class: <a href=https://www.geeksforgeeks.org/computer-organization-architecture/virtually-indexed-physically-tagged-vipt-cache/>Virtually Indexed, Physically Tagged (VIPT)</a>.<p>Modern CPU tries to look up the L1 cache at the same time as the TLB lookup. It can’t wait for the physical address. The CPU uses bits from the virtual address to find the “cache index” (the row) in L1 Cache, which is the VI part. Once it finds the row, it reads the “tag” and compares it to the physical address it gets from the TLB. This is the PT part, which makes sure that the cache hit accesses the correct memory. But this creates <a href=https://yushuanhsieh.github.io/post/2021-02-18-l1-cache-arm/>the synonyms problem</a>.<p>With 4KB (<span class="math inline">\(2^{12}\)</span>) pages, you have 12 bits of “safe” offset bits to use for your cache index. With 16KB (<span class="math inline">\(2^{14}\)</span>) pages, you now have 14 bits. Those two extra bits (<span class="math inline">\(2^2 = 4\)</span>) mean chip designers like Apple can build an L1 Data Cache that is 4x larger (or has 4x as many sets) without worrying about the synonym problem. This is one of the reason why Apple’s A-series and M-series chips have great memory performance.</div></div></div></section><section id=fragmentation class=level2><h2 class=anchored data-anchor-id=fragmentation>Fragmentation</h2><p>In the lecture, we mentioned that larger pages could lead to <strong>internal fragmentation</strong>. If a process uses only a small part of a 16KB page, is the rest wasted?<p>This is less of a concern with modern memory allocators. Android’s <strong>ART runtime</strong> and libc’s system <code>malloc</code> do not allocate a full 16KB page for every tiny object. Instead, they request large memory regions (called arenas or slabs) from the OS and then <strong>sub-divide</strong> those regions internally. This allows many small objects to share the same page.<p>This means the wasted space <em>per page</em> is usually minimal. While internal fragmentation technically increases, the significant performance gains from reduced TLB misses and better cache locality almost always outweigh this cost.</section><section id=hybrid-pages class=level2><h2 class=anchored data-anchor-id=hybrid-pages>Hybrid pages?</h2><p>Can we have a hybrid solution? <a href=https://pages.cs.wisc.edu/~remzi/OSTEP/vm-smalltables.pdf>As the textbook says</a>:<blockquote class=blockquote><p>Whenever you have two reasonable but different approaches to something in life, you should always examine the combination of the two to see if you can obtain the best of both worlds. We call such a combination a hybrid.</blockquote><p>What if an OS used both 4KB pages (for small, fine-grained allocations) and 16KB or larger pages (for big, contiguous regions)?<p>Can we get the “best of both worlds”? Linux has tried this. Linux runs background daemon (<code>khugepaged</code>) to constantly scan memory. The daemon tries to find 4KB pages that can be compacted into 2MB pages. This features is called <span class=blue><strong>Transparent Huge Page</strong></span> (THP). However, in practice, this hybrid approach adds <strong>significant complexity</strong>. The benefits can be limited while the engineering cost is high. In chapter 5 of <a href=https://pages.cs.wisc.edu/~markm/papers/dissertation.pdf>Mark Maniatis’s dissertation</a>, the author looks at physical memory fragmentation on big HPC servers. For many server workloads, THP doesn’t provide enough benefit to justify the complexity. <span class=green><strong>Simplicity is often preferred.</strong></span></p><p>Recall from <a href=https://sys-nthu.github.io/os25-fall/handouts/scheduler.html#multi-core-scheduling><strong>Worksheet 6</strong></a> that modern CPUs have both fast performance cores (P-cores) and energy-efficient efficiency cores (E-cores). <a href=https://jia.je/hardware/2024/12/26/apple-m1/#icestorm_2>This Apple Silicon analysis</a> shows that across the <strong>M1 to M4</strong> families, the <strong>P-core L1 ITLB has 192 entries</strong> while the <strong>E-core has 128 entries</strong>.<p>Because these cores have different TLB and cache structures, migrating a process between them is not trivial. The operating system must <span class=red><strong>flush</strong></span> the TLB when it migrates a process or <a href=https://en.wikipedia.org/wiki/Translation_lookaside_buffer#Address-space_switch>perform context switch</a> to clear out old, invalid translations.<p>Managing a <em>hybrid</em> page system (e.g., 4KB + 16KB pages) would be overly complicated. Apple chose simplicity.</p></section><section id=android-in-the-age-of-abundance class=level2><h2 class=anchored data-anchor-id=android-in-the-age-of-abundance>Android in the age of abundance</h2><p>By 2025, the situation is the opposite of 2008. Phones now have 8 GB or more of RAM, large caches, and multi-core processors. Hardware constraints have shifted from scarcity to efficiency: <span class=green><strong>how to make the system faster and more power-efficient.</strong></span><p>Android 15 introduces support for 16KB pages. <a href=https://developer.android.com/guide/practices/page-sizes>Google reports the benefits</a>:<ul><li>3.16% lower app start time.<li>4.56% reduced power draw during app launch.<li>Faster camera launch.<li>Faster system boot time.</ul><p>The improvements a result of fewer TLB misses, better cache utilization, and fewer page table lookups. The slight increase in memory usage is ok.<p><img src=../images/nini-game.png class=img-fluid style=max-width:240px;float:right;margin-left:30px><p>However, using a larger page size doesn’t mean we can suddenly waste memory. What’s different is that today’s hardware can support apps and games that use gigabytes of memory and depend on heavy GPU acceleration (<span class=green><strong>史詩電影等級的華麗手遊，不再只是電競PC的專利</strong></span>). Graphics-fancy games push the limits of address translation speed, so improving that part of the system becomes a key optimization.</section><section id=kb-pages-page-table-structure class=level2><h2 class=anchored data-anchor-id=kb-pages-page-table-structure>16KB Page’s Page Table Structure</h2><p>Recall that in the lecture we’ve introduced x86-64’s 4-level page table, which can map a <span class=green><strong>48-bit</strong></span> virtual address space (256TB!! Who could use so much memory??) Let’s compare that with ARMv8’s 16KB 3-level page table.<div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-2-contents aria-controls=callout-2 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">x86-64 Four-Level Page Table (4KB page)</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-2 class="callout-2-contents callout-collapse collapse"><div class="callout-body-container callout-body"><table class="caption-top table"><thead><tr class=header><th style=text-align:left>Level<th style=text-align:left>Name<th style=text-align:center>Index Bits<th style=text-align:center>Entries<th style=text-align:left>Maps<tbody><tr class=odd><td style=text-align:left>L4<td style=text-align:left>PML4<td style=text-align:center>9<td style=text-align:center>512<td style=text-align:left>Points to PDPT<tr class=even><td style=text-align:left>L3<td style=text-align:left>PDPT<td style=text-align:center>9<td style=text-align:center>512<td style=text-align:left>Points to PD<tr class=odd><td style=text-align:left>L2<td style=text-align:left>PD<td style=text-align:center>9<td style=text-align:center>512<td style=text-align:left>Points to PT<tr class=even><td style=text-align:left>L1<td style=text-align:left>PT<td style=text-align:center>9<td style=text-align:center>512<td style=text-align:left>Physical pages<tr class=odd><td style=text-align:left><strong>Offset</strong><td style=text-align:left>—<td style=text-align:center><strong>12 bits</strong><td style=text-align:center>—<td style=text-align:left>—</table><p>Each entry is 8 bytes, so every page table fits exactly in one 4 KB page (512 × 8B = 4096B).</div></div></div><div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-3-contents aria-controls=callout-3 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">ARMv8 Three-Level Page Table (16KB page)</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-3 class="callout-3-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>Android 15 adopts <strong>16 KB pages</strong> on ARM processors. The page table only has three levels.<table class="caption-top table"><thead><tr class=header><th style=text-align:left>Level<th style=text-align:left>Name<th style=text-align:center>Index Bits<th style=text-align:center>Entries<th style=text-align:left>Maps<tbody><tr class=odd><td style=text-align:left>L2<td style=text-align:left>Level 2 Table<td style=text-align:center>9<td style=text-align:center>512<td style=text-align:left>Points to Level 1<tr class=even><td style=text-align:left>L1<td style=text-align:left>Level 1 Table<td style=text-align:center>9<td style=text-align:center>512<td style=text-align:left>Points to Level 0<tr class=odd><td style=text-align:left>L0<td style=text-align:left>Level 0 Table<td style=text-align:center>9<td style=text-align:center>512<td style=text-align:left>Physical pages<tr class=even><td style=text-align:left><strong>Offset</strong><td style=text-align:left>—<td style=text-align:center><strong>14 bits</strong><td style=text-align:center>—<td style=text-align:left>—</table><p>Total = 9 × 3 + 14 = <strong>41 bits</strong> (support <strong>2 TB virtual address space</strong>, enough for mobile devices). Each table entry maps 8 MB instead of 2 MB (512 entries × 16 KB).</div></div></div><table class="caption-top table"><thead><tr class=header><th style=text-align:left>Property<th style=text-align:left>x86-64 (4 KB)<th style=text-align:left>ARM64 (16 KB)<tbody><tr class=odd><td style=text-align:left>Offset bits<td style=text-align:left>12<td style=text-align:left>14<tr class=even><td style=text-align:left>Levels<td style=text-align:left>4<td style=text-align:left>3<tr class=odd><td style=text-align:left>Entries per table<td style=text-align:left>512<td style=text-align:left>512<tr class=even><td style=text-align:left>One table covers<td style=text-align:left>2 MB<td style=text-align:left>8 MB<tr class=odd><td style=text-align:left>Typical VA space<td style=text-align:left>48 bits (256 TB)<td style=text-align:left>41 bits (2 TB)<tr class=even><td style=text-align:left>Page-table walk cost<td style=text-align:left>Higher<td style=text-align:left>Lower<tr class=odd><td style=text-align:left>Page-table memory use<td style=text-align:left>Larger<td style=text-align:left>Smaller</table><p><img src=../images/bugcat-happy.png class=img-fluid style=max-width:240px;float:right;margin-left:30px><p>Now, I hope I have fully convinced you why a bigger page improves MMU’s address translation efficiency so much.</section><section id=lessons-for-you class=level2><h2 class=anchored data-anchor-id=lessons-for-you>Lessons for You</h2><p>For decades, 4KB pages were a safe and universal choice. <span class=red>As memory grows and the impact of cache miss or TLB miss become relatively larger, that assumption is shaking.</span> Apple’s ecosystem has already shown the benefit; Android is beginning to follow as its hardware ecosystem matures.<p>When you design systems, remember that constants like “page size” are not sacred. They are engineering choices made under past constraints. As those constraints change (larger DRAM, deeper caches, more complex memory hierarchies), our design choices must change as well.<section id=review-questions class=level3><h3 class=anchored data-anchor-id=review-questions>Review Questions</h3><ol type=1><li>Why does increasing the page size reduce TLB misses?<li>Why is internal fragmentation less of a problem in modern allocators?<li>What changed between 2008 and 2025 that made 16KB pages practical for Android?</ol></section></section></section><a onclick="return window.scrollTo(0,0),!1" role=button id=quarto-back-to-top><i class="bi bi-arrow-up"></i> Back to top</a></main><script id=quarto-html-after-body>window.document.addEventListener("DOMContentLoaded",function(){const j="",c=new window.AnchorJS;c.options={placement:"right",icon:j},c.add(".anchored");const v=e=>{for(const t of e.classList)if(t.startsWith("code-annotation-"))return!0;return!1},p=function(e){const t=e.trigger;t.blur(),t.classList.add("code-copy-button-checked");var s=t.getAttribute("title");t.setAttribute("title","Copied!");let n;window.bootstrap&&(t.setAttribute("data-bs-toggle","tooltip"),t.setAttribute("data-bs-placement","left"),t.setAttribute("data-bs-title","Copied!"),n=new bootstrap.Tooltip(t,{trigger:"manual",customClass:"code-copy-button-tooltip",offset:[0,-8]}),n.show()),setTimeout(function(){n&&(n.hide(),t.removeAttribute("data-bs-title"),t.removeAttribute("data-bs-toggle"),t.removeAttribute("data-bs-placement")),t.setAttribute("title",s),t.classList.remove("code-copy-button-checked")},1e3),e.clearSelection()},m=function(e){const t=e.previousElementSibling.cloneNode(!0);for(const e of t.children)v(e)&&e.remove();return t.innerText},b=new window.ClipboardJS(".code-copy-button:not([data-in-quarto-modal])",{text:m});if(b.on("success",p),window.document.getElementById("quarto-embedded-source-code-modal")){const e=new window.ClipboardJS(".code-copy-button[data-in-quarto-modal]",{text:m,container:window.document.getElementById("quarto-embedded-source-code-modal")});e.on("success",p)}for(var s,g=new RegExp(/^(?:http|https):\/\/localhost:?[0-9]*\//),x=new RegExp(/^mailto:/),O=new RegExp("/"+window.location.host+"/"),w=e=>O.test(e)||g.test(e)||x.test(e),u=window.document.querySelectorAll("a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)"),t=0;t<u.length;t++){const e=u[t];w(e.href)||(e.dataset.originalHref!==0[0]&&(e.href=e.dataset.originalHref),e.setAttribute("target","_blank"),e.getAttribute("rel")===null&&e.setAttribute("rel","noopener"),e.classList.add("external"))}function i(e,t,n,s){const o={allowHTML:!0,maxWidth:500,delay:100,arrow:!1,appendTo:function(e){return e.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"bottom-start"};t&&(o.content=t),n&&(o.onTrigger=n),s&&(o.onUntrigger=s),window.tippy(e,o)}const f=window.document.querySelectorAll('a[role="doc-noteref"]');for(t=0;t<f.length;t++){const e=f[t];i(e,function(){let t=e.getAttribute("data-footnote-href")||e.getAttribute("href");try{t=new URL(t).hash}catch{}const s=t.replace(/^#\/?/,""),n=window.document.getElementById(s);return n?n.innerHTML:""})}const r=window.document.querySelectorAll("a.quarto-xref"),o=(e,t)=>{const n=e=>{if(e.classList.remove("page-full","page-columns"),e.children)for(const t of e.children)n(t)};if(n(t),e===null||e.startsWith("sec-")){const e=document.createElement("div");if(t.children&&t.children.length>2){e.appendChild(t.children[0].cloneNode(!0));for(let n=1;n<t.children.length;n++){const s=t.children[n];if(s.tagName==="P"&&s.innerText==="")continue;e.appendChild(s.cloneNode(!0));break}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(e),e.innerHTML}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.innerHTML}else{const e=t.querySelector("a.anchorjs-link");return e&&e.remove(),window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.classList.contains("callout")?t.outerHTML:t.innerHTML}};for(t=0;t<r.length;t++){const e=r[t];i(e,0[0],function(t){t.disable();let n=e.getAttribute("href"),s=0[0];if(n.startsWith("#"))s=n;else try{s=new URL(n).hash}catch{}if(s){const e=s.replace(/^#\/?/,""),i=window.document.getElementById(e);if(i!==null)try{const n=o(e,i.cloneNode(!0));t.setContent(n)}finally{t.enable(),t.show()}else fetch(n.split("#")[0]).then(e=>e.text()).then(n=>{const i=new DOMParser,a=i.parseFromString(n,"text/html"),s=a.getElementById(e);if(s!==null){const n=o(e,s);t.setContent(n)}}).finally(()=>{t.enable(),t.show()})}else fetch(n).then(e=>e.text()).then(e=>{const s=new DOMParser,i=s.parseFromString(e,"text/html"),n=i.querySelector("main.content");if(n!==null){n.children.length>0&&n.children[0].tagName==="HEADER"&&n.children[0].remove();const e=o(null,n);t.setContent(e)}}).finally(()=>{t.enable(),t.show()})},function(){})}let n;const h=(e,t)=>{let n='data-code-cell="'+e+'"',s='data-code-annotation="'+t+'"';const o="span["+n+"]["+s+"]";return o},a=e=>{const d=window.document,i=e.getAttribute("data-target-cell"),r=e.getAttribute("data-target-annotation"),c=window.document.querySelector(h(i,r)),l=c.getAttribute("data-code-lines").split(","),t=l.map(e=>i+"-"+e);let s=null,o=null,a=null;if(t.length>0){const r=window.document.getElementById(t[0]);if(s=r.offsetTop,o=r.offsetHeight,a=r.parentElement.parentElement,t.length>1){const e=window.document.getElementById(t[t.length-1]),n=e.offsetTop+e.offsetHeight;o=n-s}if(s!==null&&o!==null&&a!==null){let e=window.document.getElementById("code-annotation-line-highlight");e===null&&(e=window.document.createElement("div"),e.setAttribute("id","code-annotation-line-highlight"),e.style.position="absolute",a.appendChild(e)),e.style.top=s-2+"px",e.style.height=o+4+"px",e.style.left=0;let t=window.document.getElementById("code-annotation-line-highlight-gutter");if(t===null){t=window.document.createElement("div"),t.setAttribute("id","code-annotation-line-highlight-gutter"),t.style.position="absolute";const e=window.document.getElementById(i),n=e.querySelector(".code-annotation-gutter");n.appendChild(t)}t.style.top=s-2+"px",t.style.height=o+4+"px"}n=e}},y=()=>{const e=["code-annotation-line-highlight","code-annotation-line-highlight-gutter"];e.forEach(e=>{const t=window.document.getElementById(e);t&&t.remove()}),n=0[0]};window.addEventListener("resize",_(()=>{elRect=0[0],n&&a(n)},10));function _(e,t){let s=!1,n;return(...o)=>{s?(n&&clearTimeout(n),n=setTimeout(()=>{e.apply(this,o),n=s=!1},t)):(e.apply(this,o),s=!0)}}const d=window.document.querySelectorAll(".code-annotation-anchor");for(let e=0;e<d.length;e++){const t=d[e],n=t.getAttribute("data-target-cell"),s=t.getAttribute("data-target-annotation"),o=()=>{const e=window.document.querySelector(h(n,s));if(e){const t=e.cloneNode(!0);return t.classList.add("code-annotation-tip-content"),t.outerHTML}},i={allowHTML:!0,content:o,onShow:e=>{a(e.reference),e.reference.classList.add("code-annotation-active"),window.tippy.hideAll()},onHide:e=>{y(),e.reference.classList.remove("code-annotation-active")},maxWidth:300,delay:[50,0],duration:[200,0],offset:[5,10],arrow:!0,appendTo:function(e){return e.parentElement.parentElement.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"right",popperOptions:{modifiers:[{name:"flip",options:{flipVariations:!1,allowedAutoPlacements:["right"],fallbackPlacements:["right","top","top-start","top-end","bottom","bottom-start","bottom-end","left"]}},{name:"preventOverflow",options:{mainAxis:!1,altAxis:!1}}]}};window.tippy(t,i)}const l=e=>{const t=e.parentElement;if(t){const n=t.dataset.cites;return n?{el:e,cites:n.split(" ")}:l(e.parentElement)}else return 0[0]};for(s=window.document.querySelectorAll('a[role="doc-biblioref"]'),t=0;t<s.length;t++){const n=s[t],e=l(n);e&&i(e.el,function(){var t=window.document.createElement("div");return e.cites.forEach(function(e){var s,n=window.document.createElement("div");n.classList.add("hanging-indent"),n.classList.add("csl-entry"),s=window.document.getElementById("ref-"+e),s&&(n.innerHTML=s.innerHTML),t.appendChild(n)}),t.innerHTML})}})</script></div><footer class=footer><div class=nav-footer><div class=nav-footer-left><p><img id=footer-cat-left src=../images/cat-left.png alt="Cat Left"></div><div class=nav-footer-center><p><span id=footer-center>Made with ❤️ by Tony, (CC&nbsp;BY&nbsp;4.0)<br><span style=font-size:8px>Cat source: Freepik and ChatGPT</span></span></div><div class=nav-footer-right><p><img id=footer-cat-right src=../images/cat-right.png alt="Cat Right"></div></div></footer>
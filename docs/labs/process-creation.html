<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en xml:lang=en><meta charset=utf-8><meta name=generator content="quarto-1.7.33"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><title>process-creation – Operating System (2025 Fall)</title><style>code{white-space:pre-wrap}span.smallcaps{font-variant:small-caps}div.columns{display:flex;gap:min(4vw,1.5em)}div.column{flex:auto;overflow-x:auto}div.hanging-indent{margin-left:1.5em;text-indent:-1.5em}ul.task-list{list-style:none}ul.task-list li input[type=checkbox]{width:.8em;margin:0 .8em .2em -1em;vertical-align:middle}html{-webkit-text-size-adjust:100%}pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em}pre.numberSource{margin-left:3em;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}</style><script src=../site_libs/quarto-nav/quarto-nav.js></script><script src=../site_libs/clipboard/clipboard.min.js></script><script src=../site_libs/quarto-search/autocomplete.umd.js></script><script src=../site_libs/quarto-search/fuse.min.js></script><script src=../site_libs/quarto-search/quarto-search.js></script><meta name=quarto:offset content="../"><link href=../images/orange.png rel=icon type=image/png><script src=../site_libs/quarto-html/quarto.js type=module></script><script src=../site_libs/quarto-html/tabsets/tabsets.js type=module></script><script src=../site_libs/quarto-html/popper.min.js></script><script src=../site_libs/quarto-html/tippy.umd.min.js></script><script src=../site_libs/quarto-html/anchor.min.js></script><link href=../site_libs/quarto-html/tippy.css rel=stylesheet><link href=../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css rel=stylesheet id=quarto-text-highlighting-styles><script src=../site_libs/bootstrap/bootstrap.min.js></script><link href=../site_libs/bootstrap/bootstrap-icons.css rel=stylesheet><link href=../site_libs/bootstrap/bootstrap-f63c4ccd0b2cda2e66d2c70eb950e54c.min.css rel=stylesheet append-hash=true id=quarto-bootstrap data-mode=light><script id=quarto-search-options type=application/json>{"location":"navbar","copy-button":false,"collapse-after":3,"panel-placement":"end","type":"overlay","limit":50,"keyboard-shortcut":["f","/","s"],"show-item-context":false,"language":{"search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search"}}</script><body class="nav-sidebar docked nav-fixed fullcontent quarto-light"><div id=quarto-search-results></div><header id=quarto-header class="headroom fixed-top"><nav class="navbar navbar-expand-lg" data-bs-theme=dark><div class="navbar-container container-fluid"><div class="navbar-brand-container mx-auto"><a class=navbar-brand href=../index.html><span class=navbar-title>Operating System (2025 Fall)</span></a></div><div id=quarto-search title=Search></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarCollapse aria-controls=navbarCollapse role=menu aria-expanded=false aria-label="Toggle navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarCollapse><ul class="navbar-nav navbar-nav-scroll me-auto"><li class=nav-item><a class="nav-link active" href=../index.html aria-current=page><span class=menu-text>Home</span></a><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-handouts role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Handouts</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-handouts><li><a class=dropdown-item href=../handouts/env_setup.html><span class=dropdown-text>Enviroment setup</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-admin role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Admin</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-admin><li><a class=dropdown-item href=../admin/policies.html><span class=dropdown-text>Policies</span></a><li><a class=dropdown-item href=../admin/explore.html><span class=dropdown-text>Exploratory Projects</span></a><li><a class=dropdown-item href=../admin/waitbutwhy.html><span class=dropdown-text>SD1↓ (燒蛋一下)</span></a></ul></ul><ul class="navbar-nav navbar-nav-scroll ms-auto"><li class="nav-item compact"><a class=nav-link href=https://dcs.site.nthu.edu.tw/><i class="bi bi-globe" role=img></i><span class=menu-text></span></a></ul></div><div class=quarto-navbar-tools></div></div></nav><nav class=quarto-secondary-nav><div class="container-fluid d-flex"><button type=button class="quarto-btn-toggle btn" data-bs-toggle=collapse role=button data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<i class="bi bi-layout-text-sidebar-reverse"></i></button><nav class=quarto-page-breadcrumbs aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=../weeks/w3.html>Worksheet 3</a><li class=breadcrumb-item><a href=../labs/process-creation.html><code>fork()</code>/<code>exec()</code></a></ol></nav><a class=flex-grow-1 role=navigation data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()></a><button type=button class="btn quarto-search-button" aria-label=Search onclick=window.quartoOpenSearch()>
<i class="bi bi-search"></i></button></div></nav></header><div id=quarto-content class="quarto-container page-columns page-rows-contents page-layout-article page-navbar"><nav id=quarto-sidebar class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center"><div class=sidebar-search><div id=quarto-search title=Search></div></div></div><div class=sidebar-menu-container><ul class="list-unstyled mt-1"><li class=sidebar-item><div class=sidebar-item-container><a href=../index.html class="sidebar-item-text sidebar-link"><span class=menu-text>OS 2025 Fall</span></a></div><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w2.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 2</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-1 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-1 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/env_setup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Environment setup</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w3.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 3</span></a>
<a class="sidebar-item-toggle text-start" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-2 role=navigation aria-expanded=true aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-2 class="collapse list-unstyled sidebar-section depth1 show"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/unix.html class="sidebar-item-text sidebar-link"><span class=menu-text>Unix Philosophy</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/mini-cloud.html class="sidebar-item-text sidebar-link"><span class=menu-text>Your First Week in OS Journey</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-creation.html class="sidebar-item-text sidebar-link active"><span class=menu-text><code>fork()</code>/<code>exec()</code></span></a></div></ul></ul></div></nav><div id=quarto-sidebar-glass class=quarto-sidebar-collapse-item data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item></div><main class=content id=quarto-document-content><header id=title-block-header class=quarto-title-block><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=../weeks/w3.html>Worksheet 3</a><li class=breadcrumb-item><a href=../labs/process-creation.html><code>fork()</code>/<code>exec()</code></a></ol></nav></header><section id=forkexec class=level2><h2 class=anchored data-anchor-id=forkexec><code>fork()</code>/<code>exec()</code></h2><p>Why the UNIX chose a two-step interface (<code>fork</code> then <code>exec</code>) instead of one single API for process creation?<p>The biggest reason is that the parent can adjust many of the child process’s execution environment:<ol type=1><li>scheduling priority (<code>nice</code>)<li>resource limits (<code>rlimit</code>)<li>open file (<code>dup2</code>)<li>permission (<code>umask</code>)<li>working directory (<code>chdir</code>)<li>user ID (<code>setuid</code>)<li>signal handling.</ol><p>A management process run as <code>root</code>. It forks a child, and drops child’s privileges from root to the <code>nobody</code> user. This will <code>exec()</code> the target binary with minimum security risk.<p>If you have a single API for process creation, you would need to populate a very big <code>struct</code> of options.<p>When we <code>exec()</code> a program, we can also pass some inputs into the program. There are two ways to pass inputs to the program:<ul><li>command-line arguments (via argv)<li>environment variables (via envp)</ul><p>Read <a href=https://pages.cs.wisc.edu/~remzi/OSTEP/cpu-api.pdf>OSTEP-proc-5</a> to find out more!<section id=environment-variables class=level3><h3 class=anchored data-anchor-id=environment-variables>Environment Variables</h3><p>Have you ever run AI tool <a href=https://python.langchain.com/docs/integrations/llms/openai/>like this one</a> that needs an API key to talk to OpenAI? It is a bad idea to just write this in the code:<div class=sourceCode id=cb1><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=co># inside my python code ...</span></span>
<span id=cb1-2><a href=#cb1-2 aria-hidden=true tabindex=-1></a>api_key <span class=op>=</span> <span class=st>"sk-ABCDEF123456"</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Why? <span class=red><strong>Because if you commit your code to GitHub, people can see your API key 🙃.</strong></span><p>It is also a bad idea to pass the API key as command line argument like this:<div class=sourceCode id=cb2><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> python3 llama.py api=<span class=st>"sk-ABCDEF123456"</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Why? <span class=red><strong>Because if you run the program on a public workstation, anyone on the same workstation can see your secret by looking at <code>top</code> or <code>ps</code>.</strong></span><p>Instead, the best practice is to pass the API key or any secret information as environment variable:<div class=sourceCode id=cb3><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=im>import</span> getpass</span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true tabindex=-1></a><span class=im>import</span> os</span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true tabindex=-1></a><span class=cf>if</span> <span class=st>"OPENAI_API_KEY"</span> <span class=kw>not</span> <span class=kw>in</span> os.environ:</span>
<span id=cb3-5><a href=#cb3-5 aria-hidden=true tabindex=-1></a>    os.environ[<span class=st>"OPENAI_API_KEY"</span>] <span class=op>=</span> getpass.getpass(<span class=st>"Enter your OpenAI API key: "</span>)</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Before we run the code, we set the environment variable by pasting the API key we get from OpenAI: <code>export OPENAI_API_KEY=sk-ABCDEF123456</code> Environment variables let us pass context to the code we’re running without <strong>hard-coding</strong> it in the code.</section></section><section id=try-it-on-github-codespace class=level2><h2 class=anchored data-anchor-id=try-it-on-github-codespace>Try it on Github Codespace</h2><p>Let’s play with an example script that query Taipei YouBike 2.0 real-time API. Open a previous Github Codespace, and run the following in the terminal to install some packages:<div class=sourceCode id=cb4><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=fu>sudo</span> apt update</span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true tabindex=-1></a><span class=fu>sudo</span> apt install <span class=at>-y</span> jq curl</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><ol type=1><li>Save this script as <code>ubike.sh</code></ol><div class=sourceCode id=cb5><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb5-1><a href=#cb5-1 aria-hidden=true tabindex=-1></a><span class=co>#!/usr/bin/env bash</span></span>
<span id=cb5-2><a href=#cb5-2 aria-hidden=true tabindex=-1></a><span class=co>#</span></span>
<span id=cb5-3><a href=#cb5-3 aria-hidden=true tabindex=-1></a><span class=co># Simple helper for Taipei YouBike 2.0 real-time data</span></span>
<span id=cb5-4><a href=#cb5-4 aria-hidden=true tabindex=-1></a><span class=co>#   • If $STATION is unset/empty  : list all station names (sna)</span></span>
<span id=cb5-5><a href=#cb5-5 aria-hidden=true tabindex=-1></a><span class=co>#   • If $STATION is set          : print the specific field for the matching sna</span></span>
<span id=cb5-6><a href=#cb5-6 aria-hidden=true tabindex=-1></a></span>
<span id=cb5-7><a href=#cb5-7 aria-hidden=true tabindex=-1></a><span class=va>DATA_URL</span><span class=op>=</span><span class=st>"https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json"</span></span>
<span id=cb5-8><a href=#cb5-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb5-9><a href=#cb5-9 aria-hidden=true tabindex=-1></a><span class=va>json</span><span class=op>=</span><span class=va>$(</span><span class=ex>curl</span> <span class=at>-s</span> <span class=st>"</span><span class=va>$DATA_URL</span><span class=st>"</span><span class=va>)</span></span>
<span id=cb5-10><a href=#cb5-10 aria-hidden=true tabindex=-1></a></span>
<span id=cb5-11><a href=#cb5-11 aria-hidden=true tabindex=-1></a><span class=cf>if</span> <span class=kw>[[</span> <span class=ot>-z</span> <span class=st>"</span><span class=va>${STATION</span><span class=op>:-</span><span class=va>}</span><span class=st>"</span> <span class=kw>]];</span> <span class=cf>then</span></span>
<span id=cb5-12><a href=#cb5-12 aria-hidden=true tabindex=-1></a>  <span class=bu>echo</span> <span class=st>"Available stations:"</span></span>
<span id=cb5-13><a href=#cb5-13 aria-hidden=true tabindex=-1></a>  <span class=bu>echo</span> <span class=st>"</span><span class=va>$json</span><span class=st>"</span> <span class=kw>|</span> <span class=ex>jq</span> <span class=at>-r</span> <span class=st>'.[] | .sna'</span> <span class=kw>|</span> <span class=fu>sort</span> <span class=at>-u</span></span>
<span id=cb5-14><a href=#cb5-14 aria-hidden=true tabindex=-1></a><span class=cf>else</span></span>
<span id=cb5-15><a href=#cb5-15 aria-hidden=true tabindex=-1></a>  <span class=bu>echo</span> <span class=st>"Details for station: </span><span class=va>$STATION</span><span class=st>"</span></span>
<span id=cb5-16><a href=#cb5-16 aria-hidden=true tabindex=-1></a>  <span class=bu>echo</span> <span class=st>"</span><span class=va>$json</span><span class=st>"</span> <span class=kw>|</span> <span class=ex>jq</span> <span class=at>-r</span> <span class=at>--arg</span> sna <span class=st>"</span><span class=va>$STATION</span><span class=st>"</span> <span class=st>'</span></span>
<span id=cb5-17><a href=#cb5-17 aria-hidden=true tabindex=-1></a><span class=st>    .[]</span></span>
<span id=cb5-18><a href=#cb5-18 aria-hidden=true tabindex=-1></a><span class=st>    | select(.sna == $sna)</span></span>
<span id=cb5-19><a href=#cb5-19 aria-hidden=true tabindex=-1></a><span class=st>    | to_entries[]</span></span>
<span id=cb5-20><a href=#cb5-20 aria-hidden=true tabindex=-1></a><span class=st>    | "\(.key)=\(.value)"</span></span>
<span id=cb5-21><a href=#cb5-21 aria-hidden=true tabindex=-1></a><span class=st>  '</span></span>
<span id=cb5-22><a href=#cb5-22 aria-hidden=true tabindex=-1></a><span class=cf>fi</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><ol start=2 type=1><li><p>make it executable: <code>chmod +x ubike.sh</code><li><p>Run it:</ol><div class=sourceCode id=cb6><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb6-1><a href=#cb6-1 aria-hidden=true tabindex=-1></a><span class=co># List every station name</span></span>
<span id=cb6-2><a href=#cb6-2 aria-hidden=true tabindex=-1></a><span class=ex>./ubike.sh</span> <span class=co># STATION is empty</span></span>
<span id=cb6-3><a href=#cb6-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-4><a href=#cb6-4 aria-hidden=true tabindex=-1></a><span class=co># Inspect one specific station (Chinese names work fine)</span></span>
<span id=cb6-5><a href=#cb6-5 aria-hidden=true tabindex=-1></a><span class=bu>export</span> <span class=va>STATION</span><span class=op>=</span><span class=st>"YouBike2.0_捷運科技大樓站"</span></span>
<span id=cb6-6><a href=#cb6-6 aria-hidden=true tabindex=-1></a><span class=ex>./ubike.sh</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>As you can see, we just change the behavior of the <code>ubike.sh</code> without passing an argument.<section id=real-world-example-starting-a-postgresql-container class=level3><h3 class=anchored data-anchor-id=real-world-example-starting-a-postgresql-container>Real-World Example: Starting a PostgreSQL Container</h3><p>Docker container images often don’t change once they are built, meaning that their contents (binaries, scripts, configurations) are fixed. Environment variables help us inject dynamic behavior, such as API keys or password, into a container at runtime.<p>The following command launches a PostgreSQL database container. Note the <code>-e</code> flags: they inject environment variables into the container (<a href=https://www.docker.com/blog/how-to-use-the-postgres-docker-official-image/>more customizable variables here</a>).<div class=sourceCode id=cb7><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb7-1><a href=#cb7-1 aria-hidden=true tabindex=-1></a><span class=ex>docker</span> run <span class=at>--name</span> some-postgres <span class=dt>\</span></span>
<span id=cb7-2><a href=#cb7-2 aria-hidden=true tabindex=-1></a>  <span class=at>-e</span> POSTGRES_USER=myuser <span class=dt>\</span></span>
<span id=cb7-3><a href=#cb7-3 aria-hidden=true tabindex=-1></a>  <span class=at>-e</span> POSTGRES_PASSWORD=mypassword <span class=dt>\</span></span>
<span id=cb7-4><a href=#cb7-4 aria-hidden=true tabindex=-1></a>  <span class=at>-e</span> POSTGRES_DB=mydatabase <span class=dt>\</span></span>
<span id=cb7-5><a href=#cb7-5 aria-hidden=true tabindex=-1></a>  <span class=at>-d</span> postgres</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Under the hood, Docker calls <code>execve()</code> to start the database process. The database process reads values like <code>POSTGRES_USER</code> from the environment.<p><strong>Question</strong>: Why not just use command-line arguments: <code>docker run postgres --user=myuser --password=mypassword</code>?</section></section><section id=running-programs-in-the-background-daemonize class=level2><h2 class=anchored data-anchor-id=running-programs-in-the-background-daemonize>Running Programs in the Background: Daemonize</h2><p>You <strong>ssh</strong> into a Linux server, start a long-running program (say <code>./my_model_training</code>), and then your network drops or you log out. Your probably know that the program will get killed….<p>How to keep it alive? We usually use <code>tmux</code> and detach. But the <strong>classic UNIX way</strong> is to <strong>daemonize</strong>: turn your program into a <em>background service</em> that is no longer tied to your terminal.<section id=how-ptt-did-it-the-old-days class=level3><h3 class=anchored data-anchor-id=how-ptt-did-it-the-old-days>How PTT Did It (The Old Days)</h3><p>In the 1990s, PTT was run at 杜奕瑾’s dormitory, manually from a terminal. To keep the program running, PTT called a <a href=https://github.com/ptt/pttbbs/blob/master/common/sys/daemon.c#L14><code>daemonize()</code> function</a> from <a href=https://github.com/ptt/pttbbs/blob/master/daemon/logind/logind.c><code>logind</code></a>, which can handle thousands of log-ins per second. The <code>daemonize()</code> function works like this:<ul><li><strong>fork()</strong> → parent exits, child keeps running in the background.<li><strong>setsid()</strong> → child starts a new “session” with no terminal attached.<li><strong>fork() again (double fork)</strong> → ensures the process can <strong>never accidentally grab a terminal</strong> again.<li><strong>redirect input/output</strong> → stdin/stdout/stderr go to <code>/dev/null</code> or log files.<li><strong>write a PID file</strong> → so admins can later find and control the daemon.</ul><p>That’s why even if the admin logged out, <strong>PTT kept running</strong><p>Here’s the specific code that redirect <code>stderr</code> to logfile. A daemon has no screen, so we send errors into a file.<div class=sourceCode id=cb8><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb8-1><a href=#cb8-1 aria-hidden=true tabindex=-1></a><span class=cf>if</span> <span class=op>(</span>logfile<span class=op>)</span> <span class=op>{</span></span>
<span id=cb8-2><a href=#cb8-2 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=op>((</span>fd <span class=op>=</span> OpenCreate<span class=op>(</span>logfile<span class=op>,</span> O_WRONLY <span class=op>|</span> O_APPEND<span class=op>))</span> <span class=op>&lt;</span> <span class=dv>0</span><span class=op>)</span> <span class=op>{</span></span>
<span id=cb8-3><a href=#cb8-3 aria-hidden=true tabindex=-1></a>        perror<span class=op>(</span><span class=st>"Can't open logfile"</span><span class=op>);</span></span>
<span id=cb8-4><a href=#cb8-4 aria-hidden=true tabindex=-1></a>        exit<span class=op>(</span><span class=dv>1</span><span class=op>);</span></span>
<span id=cb8-5><a href=#cb8-5 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb8-6><a href=#cb8-6 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=op>(</span>fd <span class=op>!=</span> <span class=dv>2</span><span class=op>)</span> <span class=op>{</span></span>
<span id=cb8-7><a href=#cb8-7 aria-hidden=true tabindex=-1></a>        dup2<span class=op>(</span>fd<span class=op>,</span> <span class=dv>2</span><span class=op>);</span></span>
<span id=cb8-8><a href=#cb8-8 aria-hidden=true tabindex=-1></a>        close<span class=op>(</span>fd<span class=op>);</span></span>
<span id=cb8-9><a href=#cb8-9 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb8-10><a href=#cb8-10 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Here’s the code that sends <code>stdin</code> and <code>stdout</code> to black hole<div class=sourceCode id=cb9><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb9-1><a href=#cb9-1 aria-hidden=true tabindex=-1></a><span class=cf>if</span> <span class=op>((</span>fd <span class=op>=</span> open<span class=op>(</span><span class=st>"/dev/null"</span><span class=op>,</span> O_RDWR<span class=op>))</span> <span class=op>&lt;</span> <span class=dv>0</span><span class=op>)</span> <span class=op>{</span></span>
<span id=cb9-2><a href=#cb9-2 aria-hidden=true tabindex=-1></a>    perror<span class=op>(</span><span class=st>"Can't open /dev/null"</span><span class=op>);</span></span>
<span id=cb9-3><a href=#cb9-3 aria-hidden=true tabindex=-1></a>    exit<span class=op>(</span><span class=dv>1</span><span class=op>);</span></span>
<span id=cb9-4><a href=#cb9-4 aria-hidden=true tabindex=-1></a><span class=op>}</span></span>
<span id=cb9-5><a href=#cb9-5 aria-hidden=true tabindex=-1></a></span>
<span id=cb9-6><a href=#cb9-6 aria-hidden=true tabindex=-1></a>dup2<span class=op>(</span>fd<span class=op>,</span> <span class=dv>0</span><span class=op>);</span></span>
<span id=cb9-7><a href=#cb9-7 aria-hidden=true tabindex=-1></a>dup2<span class=op>(</span>fd<span class=op>,</span> <span class=dv>1</span><span class=op>);</span></span>
<span id=cb9-8><a href=#cb9-8 aria-hidden=true tabindex=-1></a><span class=cf>if</span> <span class=op>(!</span>logfile<span class=op>)</span></span>
<span id=cb9-9><a href=#cb9-9 aria-hidden=true tabindex=-1></a>    dup2<span class=op>(</span>fd<span class=op>,</span> <span class=dv>2</span><span class=op>);</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>This is equivalent to running this in a shell:<div class=sourceCode id=cb10><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb10-1><a href=#cb10-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> ./ptt <span class=op>&lt;</span>/dev/null <span class=op>&gt;</span>/dev/null <span class=dv>2</span><span class=op>&gt;&gt;</span><span class=st>"</span><span class=va>$logfile</span><span class=st>"</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=today-systemd-instead-of-diy class=level3><h3 class=anchored data-anchor-id=today-systemd-instead-of-diy>Today: systemd Instead of DIY</h3><p>On modern Linux servers, you rarely write <code>daemonize()</code> yourself. Instead, you write a <strong>systemd service unit</strong>:<div class=sourceCode id=cb11><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id=cb11-1><a href=#cb11-1 aria-hidden=true tabindex=-1></a><span class=kw>[Service]</span></span>
<span id=cb11-2><a href=#cb11-2 aria-hidden=true tabindex=-1></a><span class=dt>ExecStart</span><span class=ot>=</span><span class=st>/usr/local/bin/myapp</span></span>
<span id=cb11-3><a href=#cb11-3 aria-hidden=true tabindex=-1></a><span class=dt>Environment</span><span class=ot>=</span><span class=st>"API_KEY=sk-XXX"</span></span>
<span id=cb11-4><a href=#cb11-4 aria-hidden=true tabindex=-1></a><span class=dt>Restart</span><span class=ot>=</span><span class=st>always</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Systemd then:<ul><li>starts your program in the background,<li>keeps it alive if it crashes,<li>capture error logs (so you can debug later),<li>injects environment variables.</ul><p><img src=https://www.linuxfordevices.com/wp-content/uploads/2020/11/pstree.png class=img-fluid><p>Did you see systemd being the ancestor of all the processes in the system? These processes like databases, web servers, or messaging systems. They run for months, listening on a network port and responding to requests. If they ever crash, they must be restarted immediately to keep the system available.</section></section><a onclick="return window.scrollTo(0,0),!1" role=button id=quarto-back-to-top><i class="bi bi-arrow-up"></i> Back to top</a></main><script id=quarto-html-after-body>window.document.addEventListener("DOMContentLoaded",function(){const j="",c=new window.AnchorJS;c.options={placement:"right",icon:j},c.add(".anchored");const v=e=>{for(const t of e.classList)if(t.startsWith("code-annotation-"))return!0;return!1},p=function(e){const t=e.trigger;t.blur(),t.classList.add("code-copy-button-checked");var s=t.getAttribute("title");t.setAttribute("title","Copied!");let n;window.bootstrap&&(t.setAttribute("data-bs-toggle","tooltip"),t.setAttribute("data-bs-placement","left"),t.setAttribute("data-bs-title","Copied!"),n=new bootstrap.Tooltip(t,{trigger:"manual",customClass:"code-copy-button-tooltip",offset:[0,-8]}),n.show()),setTimeout(function(){n&&(n.hide(),t.removeAttribute("data-bs-title"),t.removeAttribute("data-bs-toggle"),t.removeAttribute("data-bs-placement")),t.setAttribute("title",s),t.classList.remove("code-copy-button-checked")},1e3),e.clearSelection()},m=function(e){const t=e.previousElementSibling.cloneNode(!0);for(const e of t.children)v(e)&&e.remove();return t.innerText},b=new window.ClipboardJS(".code-copy-button:not([data-in-quarto-modal])",{text:m});if(b.on("success",p),window.document.getElementById("quarto-embedded-source-code-modal")){const e=new window.ClipboardJS(".code-copy-button[data-in-quarto-modal]",{text:m,container:window.document.getElementById("quarto-embedded-source-code-modal")});e.on("success",p)}for(var s,g=new RegExp(/^(?:http|https):\/\/localhost:?[0-9]*\//),x=new RegExp(/^mailto:/),O=new RegExp("/"+window.location.host+"/"),w=e=>O.test(e)||g.test(e)||x.test(e),u=window.document.querySelectorAll("a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)"),t=0;t<u.length;t++){const e=u[t];w(e.href)||(e.dataset.originalHref!==0[0]&&(e.href=e.dataset.originalHref),e.setAttribute("target","_blank"),e.getAttribute("rel")===null&&e.setAttribute("rel","noopener"),e.classList.add("external"))}function i(e,t,n,s){const o={allowHTML:!0,maxWidth:500,delay:100,arrow:!1,appendTo:function(e){return e.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"bottom-start"};t&&(o.content=t),n&&(o.onTrigger=n),s&&(o.onUntrigger=s),window.tippy(e,o)}const f=window.document.querySelectorAll('a[role="doc-noteref"]');for(t=0;t<f.length;t++){const e=f[t];i(e,function(){let t=e.getAttribute("data-footnote-href")||e.getAttribute("href");try{t=new URL(t).hash}catch{}const s=t.replace(/^#\/?/,""),n=window.document.getElementById(s);return n?n.innerHTML:""})}const r=window.document.querySelectorAll("a.quarto-xref"),o=(e,t)=>{const n=e=>{if(e.classList.remove("page-full","page-columns"),e.children)for(const t of e.children)n(t)};if(n(t),e===null||e.startsWith("sec-")){const e=document.createElement("div");if(t.children&&t.children.length>2){e.appendChild(t.children[0].cloneNode(!0));for(let n=1;n<t.children.length;n++){const s=t.children[n];if(s.tagName==="P"&&s.innerText==="")continue;e.appendChild(s.cloneNode(!0));break}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(e),e.innerHTML}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.innerHTML}else{const e=t.querySelector("a.anchorjs-link");return e&&e.remove(),window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.classList.contains("callout")?t.outerHTML:t.innerHTML}};for(t=0;t<r.length;t++){const e=r[t];i(e,0[0],function(t){t.disable();let n=e.getAttribute("href"),s=0[0];if(n.startsWith("#"))s=n;else try{s=new URL(n).hash}catch{}if(s){const e=s.replace(/^#\/?/,""),i=window.document.getElementById(e);if(i!==null)try{const n=o(e,i.cloneNode(!0));t.setContent(n)}finally{t.enable(),t.show()}else fetch(n.split("#")[0]).then(e=>e.text()).then(n=>{const i=new DOMParser,a=i.parseFromString(n,"text/html"),s=a.getElementById(e);if(s!==null){const n=o(e,s);t.setContent(n)}}).finally(()=>{t.enable(),t.show()})}else fetch(n).then(e=>e.text()).then(e=>{const s=new DOMParser,i=s.parseFromString(e,"text/html"),n=i.querySelector("main.content");if(n!==null){n.children.length>0&&n.children[0].tagName==="HEADER"&&n.children[0].remove();const e=o(null,n);t.setContent(e)}}).finally(()=>{t.enable(),t.show()})},function(){})}let n;const h=(e,t)=>{let n='data-code-cell="'+e+'"',s='data-code-annotation="'+t+'"';const o="span["+n+"]["+s+"]";return o},a=e=>{const d=window.document,i=e.getAttribute("data-target-cell"),r=e.getAttribute("data-target-annotation"),c=window.document.querySelector(h(i,r)),l=c.getAttribute("data-code-lines").split(","),t=l.map(e=>i+"-"+e);let s=null,o=null,a=null;if(t.length>0){const r=window.document.getElementById(t[0]);if(s=r.offsetTop,o=r.offsetHeight,a=r.parentElement.parentElement,t.length>1){const e=window.document.getElementById(t[t.length-1]),n=e.offsetTop+e.offsetHeight;o=n-s}if(s!==null&&o!==null&&a!==null){let e=window.document.getElementById("code-annotation-line-highlight");e===null&&(e=window.document.createElement("div"),e.setAttribute("id","code-annotation-line-highlight"),e.style.position="absolute",a.appendChild(e)),e.style.top=s-2+"px",e.style.height=o+4+"px",e.style.left=0;let t=window.document.getElementById("code-annotation-line-highlight-gutter");if(t===null){t=window.document.createElement("div"),t.setAttribute("id","code-annotation-line-highlight-gutter"),t.style.position="absolute";const e=window.document.getElementById(i),n=e.querySelector(".code-annotation-gutter");n.appendChild(t)}t.style.top=s-2+"px",t.style.height=o+4+"px"}n=e}},y=()=>{const e=["code-annotation-line-highlight","code-annotation-line-highlight-gutter"];e.forEach(e=>{const t=window.document.getElementById(e);t&&t.remove()}),n=0[0]};window.addEventListener("resize",_(()=>{elRect=0[0],n&&a(n)},10));function _(e,t){let s=!1,n;return(...o)=>{s?(n&&clearTimeout(n),n=setTimeout(()=>{e.apply(this,o),n=s=!1},t)):(e.apply(this,o),s=!0)}}const d=window.document.querySelectorAll(".code-annotation-anchor");for(let e=0;e<d.length;e++){const t=d[e],n=t.getAttribute("data-target-cell"),s=t.getAttribute("data-target-annotation"),o=()=>{const e=window.document.querySelector(h(n,s));if(e){const t=e.cloneNode(!0);return t.classList.add("code-annotation-tip-content"),t.outerHTML}},i={allowHTML:!0,content:o,onShow:e=>{a(e.reference),e.reference.classList.add("code-annotation-active"),window.tippy.hideAll()},onHide:e=>{y(),e.reference.classList.remove("code-annotation-active")},maxWidth:300,delay:[50,0],duration:[200,0],offset:[5,10],arrow:!0,appendTo:function(e){return e.parentElement.parentElement.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"right",popperOptions:{modifiers:[{name:"flip",options:{flipVariations:!1,allowedAutoPlacements:["right"],fallbackPlacements:["right","top","top-start","top-end","bottom","bottom-start","bottom-end","left"]}},{name:"preventOverflow",options:{mainAxis:!1,altAxis:!1}}]}};window.tippy(t,i)}const l=e=>{const t=e.parentElement;if(t){const n=t.dataset.cites;return n?{el:e,cites:n.split(" ")}:l(e.parentElement)}else return 0[0]};for(s=window.document.querySelectorAll('a[role="doc-biblioref"]'),t=0;t<s.length;t++){const n=s[t],e=l(n);e&&i(e.el,function(){var t=window.document.createElement("div");return e.cites.forEach(function(e){var s,n=window.document.createElement("div");n.classList.add("hanging-indent"),n.classList.add("csl-entry"),s=window.document.getElementById("ref-"+e),s&&(n.innerHTML=s.innerHTML),t.appendChild(n)}),t.innerHTML})}})</script></div><footer class=footer><div class=nav-footer><div class=nav-footer-left><p><img id=footer-cat-left src=../images/cat-left.png alt="Cat Left"></div><div class=nav-footer-center><p><span id=footer-center>Made with ❤️ by Tony, (CC&nbsp;BY&nbsp;4.0)<br><span style=font-size:8px>Cat source: Freepik and ChatGPT</span></span></div><div class=nav-footer-right><p><img id=footer-cat-right src=../images/cat-right.png alt="Cat Right"></div></div></footer>
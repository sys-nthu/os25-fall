<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en xml:lang=en><meta charset=utf-8><meta name=generator content="quarto-1.7.33"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><title>event-driven-io – Operating System (2025 Fall)</title><style>code{white-space:pre-wrap}span.smallcaps{font-variant:small-caps}div.columns{display:flex;gap:min(4vw,1.5em)}div.column{flex:auto;overflow-x:auto}div.hanging-indent{margin-left:1.5em;text-indent:-1.5em}ul.task-list{list-style:none}ul.task-list li input[type=checkbox]{width:.8em;margin:0 .8em .2em -1em;vertical-align:middle}html{-webkit-text-size-adjust:100%}pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em}pre.numberSource{margin-left:3em;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}</style><script src=../site_libs/quarto-nav/quarto-nav.js></script><script src=../site_libs/clipboard/clipboard.min.js></script><script src=../site_libs/quarto-search/autocomplete.umd.js></script><script src=../site_libs/quarto-search/fuse.min.js></script><script src=../site_libs/quarto-search/quarto-search.js></script><meta name=quarto:offset content="../"><link href=../images/orange.png rel=icon type=image/png><script src=../site_libs/quarto-html/quarto.js type=module></script><script src=../site_libs/quarto-html/tabsets/tabsets.js type=module></script><script src=../site_libs/quarto-html/popper.min.js></script><script src=../site_libs/quarto-html/tippy.umd.min.js></script><script src=../site_libs/quarto-html/anchor.min.js></script><link href=../site_libs/quarto-html/tippy.css rel=stylesheet><link href=../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css rel=stylesheet id=quarto-text-highlighting-styles><script src=../site_libs/bootstrap/bootstrap.min.js></script><link href=../site_libs/bootstrap/bootstrap-icons.css rel=stylesheet><link href=../site_libs/bootstrap/bootstrap-a3d6f4078ec9f2632a80ad631344d584.min.css rel=stylesheet append-hash=true id=quarto-bootstrap data-mode=light><script id=quarto-search-options type=application/json>{"location":"navbar","copy-button":false,"collapse-after":3,"panel-placement":"end","type":"overlay","limit":50,"keyboard-shortcut":["f","/","s"],"show-item-context":false,"language":{"search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search"}}</script><body class="nav-sidebar docked nav-fixed fullcontent quarto-light"><div id=quarto-search-results></div><header id=quarto-header class="headroom fixed-top"><nav class="navbar navbar-expand-lg" data-bs-theme=dark><div class="navbar-container container-fluid"><div class="navbar-brand-container mx-auto"><a class=navbar-brand href=../index.html><span class=navbar-title>Operating System (2025 Fall)</span></a></div><div id=quarto-search title=Search></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarCollapse aria-controls=navbarCollapse role=menu aria-expanded=false aria-label="Toggle navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarCollapse><ul class="navbar-nav navbar-nav-scroll me-auto"><li class=nav-item><a class="nav-link active" href=../index.html aria-current=page><span class=menu-text>Home</span></a><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-handouts role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Handouts</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-handouts><li><a class=dropdown-item href=../handouts/env_setup.html><span class=dropdown-text>Environment Setup</span></a><li><a class=dropdown-item href=../handouts/unix.html><span class=dropdown-text>Unix</span></a><li><a class=dropdown-item href=../handouts/privilege.html><span class=dropdown-text>Privilege</span></a><li><a class=dropdown-item href=../handouts/scheduler.html><span class=dropdown-text>Scheduler</span></a><li><a class=dropdown-item href=../handouts/buffercache.html><span class=dropdown-text>Buffer Cache</span></a><li><a class=dropdown-item href=../handouts/vm-page-size.html><span class=dropdown-text>Virtual Memory: Page Size</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-labs role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Labs</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-labs><li><a class=dropdown-item href=../labs/mini-cloud.html><span class=dropdown-text>Mini Cloud</span></a><li><a class=dropdown-item href=../labs/linking.html><span class=dropdown-text>Linking</span></a><li><a class=dropdown-item href=../labs/process-creation.html><span class=dropdown-text>Process Creation</span></a><li><a class=dropdown-item href=../labs/process-state.html><span class=dropdown-text>Process State</span></a><li><a class=dropdown-item href=../labs/process-address-space.html><span class=dropdown-text>Process Address Space</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/path-traversal.html><span class=dropdown-text>Path Traversal</span></a><li><a class=dropdown-item href=../labs/pipe-passwords.html><span class=dropdown-text>Pipe Passwords</span></a><li><a class=dropdown-item href=../labs/pipe-dup.html><span class=dropdown-text>Pipe and dup()</span></a><li><a class=dropdown-item href=../labs/pipe-pingpong.html><span class=dropdown-text>Pipe Ping-Pong</span></a><li><a class=dropdown-item href=../labs/fifo.html><span class=dropdown-text>FIFO (named pipe)</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/cat.html><span class=dropdown-text>Cat</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/xv6-syscall.html><span class=dropdown-text>xv6 System Call Tracing</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-admin role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Admin</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-admin><li><a class=dropdown-item href=../admin/policies.html><span class=dropdown-text>Policies</span></a><li><a class=dropdown-item href=../admin/explore.html><span class=dropdown-text>Exploratory Projects</span></a><li><a class=dropdown-item href=../admin/waitbutwhy.html><span class=dropdown-text>SD1↓ (燒蛋一下)</span></a></ul></ul><ul class="navbar-nav navbar-nav-scroll ms-auto"><li class="nav-item compact"><a class=nav-link href="https://elearn.nthu.edu.tw/course/view.php?id=38873"><i class="bi bi-globe" role=img></i><span class=menu-text></span></a></ul></div><div class=quarto-navbar-tools></div></div></nav><nav class=quarto-secondary-nav><div class="container-fluid d-flex"><button type=button class="quarto-btn-toggle btn" data-bs-toggle=collapse role=button data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<i class="bi bi-layout-text-sidebar-reverse"></i></button><nav class=quarto-page-breadcrumbs aria-label=breadcrumb><ol class=breadcrumb></ol></nav><a class=flex-grow-1 role=navigation data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()></a><button type=button class="btn quarto-search-button" aria-label=Search onclick=window.quartoOpenSearch()>
<i class="bi bi-search"></i></button></div></nav></header><div id=quarto-content class="quarto-container page-columns page-rows-contents page-layout-article page-navbar"><nav id=quarto-sidebar class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center"><div class=sidebar-search><div id=quarto-search title=Search></div></div></div><div class=sidebar-menu-container><ul class="list-unstyled mt-1"><li class=sidebar-item><div class=sidebar-item-container><a href=../index.html class="sidebar-item-text sidebar-link"><span class=menu-text>OS 2025 Fall</span></a></div><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w2.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 2</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-1 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-1 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/env_setup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Environment setup</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w3.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 3</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-2 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-2 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/unix.html class="sidebar-item-text sidebar-link"><span class=menu-text>Unix Philosophy</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/mini-cloud.html class="sidebar-item-text sidebar-link"><span class=menu-text>Your First Week in OS Journey</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-creation.html class="sidebar-item-text sidebar-link"><span class=menu-text><code>fork()</code>/<code>exec()</code></span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w4.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 4</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-3 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-3 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/privilege.html class="sidebar-item-text sidebar-link"><span class=menu-text>Privilege</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/path-traversal.html class="sidebar-item-text sidebar-link"><span class=menu-text>Lab: Path Traversal Attack</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-address-space.html class="sidebar-item-text sidebar-link"><span class=menu-text>Address Space Layout</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/linking.html class="sidebar-item-text sidebar-link"><span class=menu-text>Static vs Dynamic Linking</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w5.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 5</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-4 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-4 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-passwords.html class="sidebar-item-text sidebar-link"><span class=menu-text>Parallelizing Rainbow Table Lookup with Pipes</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-dup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipes, Redirection, and File Descriptors</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/fifo.html class="sidebar-item-text sidebar-link"><span class=menu-text>FIFO (named pipe)</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w6.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 6</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-5 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-5 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/scheduler.html class="sidebar-item-text sidebar-link"><span class=menu-text>Schedulers</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-state.html class="sidebar-item-text sidebar-link"><span class=menu-text>Process States in Linux</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-pingpong.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipe Pingpong</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w8.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 8</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-6 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-6 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/buffercache.html class="sidebar-item-text sidebar-link"><span class=menu-text>Caching and Buffering</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/cat.html class="sidebar-item-text sidebar-link"><span class=menu-text>How <code>cat</code> works?</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w9.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 9</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-7 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-7 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-intro.html class="sidebar-item-text sidebar-link"><span class=menu-text>Introduction to xv6</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-gdb.html class="sidebar-item-text sidebar-link"><span class=menu-text>GNU Debugger Tutorial</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-syscall.html class="sidebar-item-text sidebar-link"><span class=menu-text>xv6 Syscall Tracing</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w10.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 10</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-8 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-8 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/vm-page-size.html class="sidebar-item-text sidebar-link"><span class=menu-text>Why Android Moved to 16KB Pages</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w11.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 11</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-9 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-9 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-forkbomb.html class="sidebar-item-text sidebar-link"><span class=menu-text>xv6 Fork Bomb</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-gdb.html class="sidebar-item-text sidebar-link"><span class=menu-text>GNU Debugger Tutorial</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-development-env.html class="sidebar-item-text sidebar-link"><span class=menu-text>Set Up Your Lab Environment</span></a></div></ul></ul></div></nav><div id=quarto-sidebar-glass class=quarto-sidebar-collapse-item data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item></div><main class=content id=quarto-document-content><header id=title-block-header class=quarto-title-block></header><section id=event-driven-io class=level2><h2 class=anchored data-anchor-id=event-driven-io>Event-Driven I/O</h2><p>Multi-threading is useful for two main purposes: parallelizing CPU-intensive tasks and concurrently handling I/O-bound workloads. In this lab, we will focus on the latter, where threads spend most of their time waiting for I/O operations to complete. How can we serve a large number of I/O-bound tasks using the least amount of system resources?<p><span class=big><strong>Use Event-Driven I/O!</strong></span><p><a href=https://sys-nthu.github.io/os25-fall/labs/process-creation.html#how-ptt-did-it-the-old-days>A classic example I mentioned is PTT, which ran on 杜奕瑾’s dormitory PC back in the 1990s.</a> Amazingly, it was able to support over 100,000 users. How was that possible?<p>Each user’s browser maintains a connection to the server, but most of the time that connection just waits for a click, or some other user action. If we were to assign one thread per user session, we would quickly run out of memory and CPU resources because of the overhead of managing thousands of threads.<p>Event-driven I/O <em>multiplexes</em> many connections onto a small number of threads. When a particular connection becomes active, such as when data arrives or a user clicks something, the OS notifies the server to handle that event. The server processes it briefly and then goes back to waiting for the next event.<p>Let’s go!</section><section id=set-up class=level2><h2 class=anchored data-anchor-id=set-up>Set up</h2><p><a href=https://codespaces.new/sys-nthu/lab-python-webserver><img src=https://github.com/codespaces/badge.svg class=img-fluid alt="open in GitHub Codespaces"></a>.<p>Open you have opened in Github Codespace, install the necessary packages in the terminal:<div class=sourceCode id=cb1><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=ex>pip3</span> install streamlit waitress aiohttp</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=趴1-running-a-fun-event-io-web-server class=level2><h2 class=anchored data-anchor-id=趴1-running-a-fun-event-io-web-server>趴1： Running a Fun Event-IO Web Server</h2><p>Let’s run a fun Streamlit app. Streamlit is backed by an event-driven IO framework called Tornado. Let’s observe how Tornado uses <a href=https://hackmd.io/@eric88525/epoll-intro><code>epoll</code></a> to handle network connections and events.<section id=clear-python-cache class=level4><h4 class=anchored data-anchor-id=clear-python-cache>1. Clear Python Cache</h4><div class=sourceCode id=cb2><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=fu>find</span> ~/.local/ <span class=kw>|</span> <span class=fu>grep</span> <span class=at>-E</span> <span class=st>"(/__pycache__$|\.pyc$|\.pyo$)"</span> <span class=kw>|</span> <span class=fu>xargs</span> rm <span class=at>-rf</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=run-the-server class=level4><h4 class=anchored data-anchor-id=run-the-server>2. Run the Server</h4><p>We use <code>strace</code> to see what system calls are made inside streamlit.<div class=sourceCode id=cb3><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=ex>strace</span> <span class=at>-f</span> <span class=at>-o</span> log_streamlit.txt <span class=dt>\</span></span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true tabindex=-1></a>    <span class=at>-e</span> trace=epoll_wait,epoll_ctl,openat,listen,accept,bind <span class=dt>\</span></span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true tabindex=-1></a>    streamlit run streamlit_fun.py <span class=at>--server.address</span><span class=op>=</span>0.0.0.0 <span class=at>--server.port</span><span class=op>=</span>8079</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p><strong>Github Codespace will open a pop-up menu in the bottom right and provide a specific forwarded URL.</strong> <span class=green><strong>Click that!</strong></span></section><section id=in-your-browser class=level4><h4 class=anchored data-anchor-id=in-your-browser>3. In Your Browser</h4><ol type=1><li>Wait for 5-10 seconds for Streamlit to load.<li>Click the <strong>“Give me a lucky number!”</strong> button.</ol></section><section id=clean-up class=level4><h4 class=anchored data-anchor-id=clean-up>4. Clean Up</h4><p>Go back to your terminal and stop the server by pressing <code>Ctrl+C</code>.</section><section id=analyze-straces-output class=level3><h3 class=anchored data-anchor-id=analyze-straces-output>Analyze <code>strace</code>’s output</h3><p>Now, open the log file you got: <code>log_streamlit.txt</code>. Use <code>ctrl-F</code> or <code>cmd-F</code> to search for string in the file.<ol type=1><li><strong>Find the Server’s Socket:</strong></ol><p>Search the log for <code>bind</code>. You’ll find a line showing the server binding to port 8079. It will look something like this: <code>11280 bind(6, {sa_family=AF_INET, sin_port=htons(8079), ...}, 16) = 0</code><p>What is the <strong>file descriptor (fd)</strong> number for your server’s main listening socket? (In the example above, it’s <code>6</code>)<ol start=2 type=1><li><strong>See How the Server “Waits”:</strong></ol><p>Now that you know the server’s main <code>fd</code>, search for the <code>epoll_ctl</code> call that <em>adds</em> it to the list of things to monitor. Can you find the line that looks like <code>epoll_ctl(..., EPOLL_CTL_ADD, &lt;your_fd_from_step_1>, ...)</code>? The server tells the OS: “Please start monitoring this socket (<code>&lt;your_fd_from_step_1></code>) for new connections.”<ol start=3 type=1><li><strong>Find the Balloon Code:</strong></ol><p>When you clicked the button, did you see the balloons flying up?<p>The <code>epoll_wait</code> woke up when you clicked the button and the server ran the code in <code>balloons.py</code> that pop up the balloons. Search the log for the “<code>balloons.py</code>” string. You should see a <code>openat</code> system call.</section></section><section id=趴2-web-server-benchmark class=level2><h2 class=anchored data-anchor-id=趴2-web-server-benchmark>趴2： Web server benchmark</h2><p>Now, let’s compare different approaches to handling concurrent HTTP requests. We’ll measure the throughput and the response time distribution.<p>We will be using the <code>hey</code> benchmark tool to simulate users. All our servers will simulate a <strong>20ms (0.02s)</strong> I/O wait (like a disk or database query). Download <code>hey</code> first:<div class=sourceCode id=cb4><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=fu>wget</span> https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64 <span class=at>-O</span> hey <span class=kw>&amp;&amp;</span> <span class=fu>chmod</span> +x ./hey</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>We will run two benchmarks:<ol type=1><li><strong>Low Concurrency:</strong> <code>./hey -n 200 -c 4 http://localhost:PORT</code> (4 users at once)<li><strong>High Concurrency:</strong> <code>./hey -n 200 -c 16 http://localhost:PORT</code> (16 users at once)</ol><section id=server-a-baseline-single-thread-blocking class=level3><h3 class=anchored data-anchor-id=server-a-baseline-single-thread-blocking>Server A: Baseline (Single-Thread, Blocking)</h3><p>This server can only handle <strong>one request at a time</strong>, sequentially.<p>Run the server in one terminal window: <code>python3 server.py</code> (it will listen on port 8080). Open a new terminal window in VS Code by clicking the “+” sign. Run <code>hey</code>:<div class=sourceCode id=cb5><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb5-1><a href=#cb5-1 aria-hidden=true tabindex=-1></a><span class=ex>./hey</span> <span class=at>-n</span> 200 <span class=at>-c</span> 4 http://localhost:8080</span>
<span id=cb5-2><a href=#cb5-2 aria-hidden=true tabindex=-1></a><span class=ex>./hey</span> <span class=at>-n</span> 200 <span class=at>-c</span> 16 http://localhost:8080</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p><strong>Look at the latency distribution. Where is the peak? Notice how the latency <em>explodes</em> when you run <code>hey</code> with high concurrency.</strong></section><section id=server-b-thread-pool class=level3><h3 class=anchored data-anchor-id=server-b-thread-pool>Server B: Thread Pool</h3><p>We use the <code>waitress</code> to implement a thread pool with 8 worker threads. Thread pool means I create the threads beforehand, so when connection arrives, the main thread can directly assign one worker thread to handle the connection without waiting for a new thread to be created.<p>Run the server in one terminal window: <code>python3 server_threadpool.py</code> (it will listen on port 8081). Open a new terminal window in VS Code by clicking the “+” sign. Run <code>hey</code>:<div class=sourceCode id=cb6><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb6-1><a href=#cb6-1 aria-hidden=true tabindex=-1></a><span class=ex>./hey</span> <span class=at>-n</span> 200 <span class=at>-c</span> 4 http://localhost:8081</span>
<span id=cb6-2><a href=#cb6-2 aria-hidden=true tabindex=-1></a><span class=ex>./hey</span> <span class=at>-n</span> 200 <span class=at>-c</span> 16 http://localhost:8081</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p><strong>How does the latency distribution change when you go from 4 concurrent users to 16?</strong><hr></section><section id=server-c-asyncio-single-thread-non-blocking class=level3><h3 class=anchored data-anchor-id=server-c-asyncio-single-thread-non-blocking>Server C: AsyncIO (Single-Thread, Non-Blocking)</h3><p>Run the server in one terminal window: <code>python3 server_asyncio.py</code> (it will listen on port 8082) Open a new terminal window in VS Code by clicking the “+” sign. Run <code>hey</code>:<div class=sourceCode id=cb7><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb7-1><a href=#cb7-1 aria-hidden=true tabindex=-1></a><span class=ex>./hey</span> <span class=at>-n</span> 200 <span class=at>-c</span> 4 http://localhost:8082</span>
<span id=cb7-2><a href=#cb7-2 aria-hidden=true tabindex=-1></a><span class=ex>./hey</span> <span class=at>-n</span> 200 <span class=at>-c</span> 16 http://localhost:8082</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p><strong>Does the latency distribution change when you go from 4 to 16 concurrent users?</strong></section></section><section id=趴3analysis class=level2><h2 class=anchored data-anchor-id=趴3analysis>趴3：Analysis</h2><p>Let’s analyze your benchmark data. You should have something that looks like this:<table class="caption-top table"><thead><tr class=header><th style=text-align:left>Server Model<th style=text-align:left>Concurrency (C)<th style=text-align:left>Median Latency (Your Data)<tbody><tr class=odd><td style=text-align:left><strong>A: Baseline</strong><td style=text-align:left>4<td style=text-align:left>~0.08s<tr class=even><td style=text-align:left><strong>A: Baseline</strong><td style=text-align:left>16<td style=text-align:left>Very High (e.g., > 0.4s)<tr class=odd><td style=text-align:left><strong>B: Thread Pool</strong><td style=text-align:left>4<td style=text-align:left>~0.02s<tr class=even><td style=text-align:left><strong>B: Thread Pool</strong><td style=text-align:left>16<td style=text-align:left><strong>~0.04s</strong><tr class=odd><td style=text-align:left><strong>C: AsyncIO</strong><td style=text-align:left>4<td style=text-align:left>~0.02s<tr class=even><td style=text-align:left><strong>C: AsyncIO</strong><td style=text-align:left>16<td style=text-align:left><strong>~0.02s</strong></table><section id=food-for-thoughts class=level3><h3 class=anchored data-anchor-id=food-for-thoughts>Food for Thoughts</h3><p>Remember that all our servers add a 20ms (0.02s) sleep to each request handling. Try to reason about the number you see from <code>hey</code>. It can vary due to the number of CPU cores available as well.<ol type=1><li><strong>Server A (Baseline):</strong> Why did the latency for the <code>c=4</code> run make sense (Hint: 4 * 0.02s)? Why did the <code>c=16</code> latency get <em>so much</em> worse, far more than just 16 * 0.02s? (Hint: <a href=https://less.works/less/principles/queueing_theory>“Check M/M/1 waiting behavior here”</a>)<li><strong>Server B (Thread Pool):</strong> Why was the latency for <code>c=4</code> so good (~0.02s)? (Hint: How many threads did we have?)<li><strong>Server B (Thread Pool):</strong> Why did the median latency for Server B <strong>double</strong> to ~0.04s when concurrency hit 16? (Hint: We had 16 concurrent requests, but only 8 worker threads. What happens to requests 9-16?) (Remember we talked about <a href=https://sys-nthu.github.io/os25-fall/handouts/buffercache.html#latency-vs.-throughput>Queue Depth (QD) in SSD</a>? If you increase QD more than *the number of worker inside SSD, your bandwidth will saturate and the queuing delay will grow.)<li><strong>Server C (AsyncIO):</strong> Why did the median latency for the <strong>single-threaded</strong> <code>asyncio</code> server <strong>stay low</strong> at ~0.02s, even with 16 concurrent requests?<li>Suppose you want to run your own <a href=https://steam.oxxostudio.tw/category/python/example/line-webhook.html>Line Bot web server</a> in your dormitory PC. Suppose you expect the server would handle at most 1000 chat connections, which model (Thread Pool or AsyncIO) would you choose, and why?</ol><hr></section><section id=bonus class=level3><h3 class=anchored data-anchor-id=bonus>Bonus</h3><p><a href=https://realpython.com/async-io-python/#async-io-explained>A wonderful explanation</a> of synchronous v.s asynchronous I/O using the story of chess master Judit Polgár:<div class="quarto-figure quarto-figure-center" style=max-width:450px><figure class=figure><p><img src=../images/chess-exhibition.png class="img-fluid figure-img"><figcaption>一口氣跟24個對手下棋! 別人55秒動一步，她5秒動一步</figcaption></figure></div></section></section><a onclick="return window.scrollTo(0,0),!1" role=button id=quarto-back-to-top><i class="bi bi-arrow-up"></i> Back to top</a></main><script id=quarto-html-after-body>window.document.addEventListener("DOMContentLoaded",function(){const j="",c=new window.AnchorJS;c.options={placement:"right",icon:j},c.add(".anchored");const v=e=>{for(const t of e.classList)if(t.startsWith("code-annotation-"))return!0;return!1},h=function(e){const t=e.trigger;t.blur(),t.classList.add("code-copy-button-checked");var s=t.getAttribute("title");t.setAttribute("title","Copied!");let n;window.bootstrap&&(t.setAttribute("data-bs-toggle","tooltip"),t.setAttribute("data-bs-placement","left"),t.setAttribute("data-bs-title","Copied!"),n=new bootstrap.Tooltip(t,{trigger:"manual",customClass:"code-copy-button-tooltip",offset:[0,-8]}),n.show()),setTimeout(function(){n&&(n.hide(),t.removeAttribute("data-bs-title"),t.removeAttribute("data-bs-toggle"),t.removeAttribute("data-bs-placement")),t.setAttribute("title",s),t.classList.remove("code-copy-button-checked")},1e3),e.clearSelection()},m=function(e){const t=e.previousElementSibling.cloneNode(!0);for(const e of t.children)v(e)&&e.remove();return t.innerText},g=new window.ClipboardJS(".code-copy-button:not([data-in-quarto-modal])",{text:m});if(g.on("success",h),window.document.getElementById("quarto-embedded-source-code-modal")){const e=new window.ClipboardJS(".code-copy-button[data-in-quarto-modal]",{text:m,container:window.document.getElementById("quarto-embedded-source-code-modal")});e.on("success",h)}for(var s,p=new RegExp(/^(?:http|https):\/\/localhost:?[0-9]*\//),x=new RegExp(/^mailto:/),O=new RegExp("/"+window.location.host+"/"),y=e=>O.test(e)||p.test(e)||x.test(e),u=window.document.querySelectorAll("a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)"),t=0;t<u.length;t++){const e=u[t];y(e.href)||(e.dataset.originalHref!==0[0]&&(e.href=e.dataset.originalHref),e.setAttribute("target","_blank"),e.getAttribute("rel")===null&&e.setAttribute("rel","noopener"),e.classList.add("external"))}function i(e,t,n,s){const o={allowHTML:!0,maxWidth:500,delay:100,arrow:!1,appendTo:function(e){return e.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"bottom-start"};t&&(o.content=t),n&&(o.onTrigger=n),s&&(o.onUntrigger=s),window.tippy(e,o)}const f=window.document.querySelectorAll('a[role="doc-noteref"]');for(t=0;t<f.length;t++){const e=f[t];i(e,function(){let t=e.getAttribute("data-footnote-href")||e.getAttribute("href");try{t=new URL(t).hash}catch{}const s=t.replace(/^#\/?/,""),n=window.document.getElementById(s);return n?n.innerHTML:""})}const r=window.document.querySelectorAll("a.quarto-xref"),o=(e,t)=>{const n=e=>{if(e.classList.remove("page-full","page-columns"),e.children)for(const t of e.children)n(t)};if(n(t),e===null||e.startsWith("sec-")){const e=document.createElement("div");if(t.children&&t.children.length>2){e.appendChild(t.children[0].cloneNode(!0));for(let n=1;n<t.children.length;n++){const s=t.children[n];if(s.tagName==="P"&&s.innerText==="")continue;e.appendChild(s.cloneNode(!0));break}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(e),e.innerHTML}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.innerHTML}else{const e=t.querySelector("a.anchorjs-link");return e&&e.remove(),window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.classList.contains("callout")?t.outerHTML:t.innerHTML}};for(t=0;t<r.length;t++){const e=r[t];i(e,0[0],function(t){t.disable();let n=e.getAttribute("href"),s=0[0];if(n.startsWith("#"))s=n;else try{s=new URL(n).hash}catch{}if(s){const e=s.replace(/^#\/?/,""),i=window.document.getElementById(e);if(i!==null)try{const n=o(e,i.cloneNode(!0));t.setContent(n)}finally{t.enable(),t.show()}else fetch(n.split("#")[0]).then(e=>e.text()).then(n=>{const i=new DOMParser,a=i.parseFromString(n,"text/html"),s=a.getElementById(e);if(s!==null){const n=o(e,s);t.setContent(n)}}).finally(()=>{t.enable(),t.show()})}else fetch(n).then(e=>e.text()).then(e=>{const s=new DOMParser,i=s.parseFromString(e,"text/html"),n=i.querySelector("main.content");if(n!==null){n.children.length>0&&n.children[0].tagName==="HEADER"&&n.children[0].remove();const e=o(null,n);t.setContent(e)}}).finally(()=>{t.enable(),t.show()})},function(){})}let n;const b=(e,t)=>{let n='data-code-cell="'+e+'"',s='data-code-annotation="'+t+'"';const o="span["+n+"]["+s+"]";return o},a=e=>{const d=window.document,i=e.getAttribute("data-target-cell"),r=e.getAttribute("data-target-annotation"),c=window.document.querySelector(b(i,r)),l=c.getAttribute("data-code-lines").split(","),t=l.map(e=>i+"-"+e);let s=null,o=null,a=null;if(t.length>0){const r=window.document.getElementById(t[0]);if(s=r.offsetTop,o=r.offsetHeight,a=r.parentElement.parentElement,t.length>1){const e=window.document.getElementById(t[t.length-1]),n=e.offsetTop+e.offsetHeight;o=n-s}if(s!==null&&o!==null&&a!==null){let e=window.document.getElementById("code-annotation-line-highlight");e===null&&(e=window.document.createElement("div"),e.setAttribute("id","code-annotation-line-highlight"),e.style.position="absolute",a.appendChild(e)),e.style.top=s-2+"px",e.style.height=o+4+"px",e.style.left=0;let t=window.document.getElementById("code-annotation-line-highlight-gutter");if(t===null){t=window.document.createElement("div"),t.setAttribute("id","code-annotation-line-highlight-gutter"),t.style.position="absolute";const e=window.document.getElementById(i),n=e.querySelector(".code-annotation-gutter");n.appendChild(t)}t.style.top=s-2+"px",t.style.height=o+4+"px"}n=e}},d=()=>{const e=["code-annotation-line-highlight","code-annotation-line-highlight-gutter"];e.forEach(e=>{const t=window.document.getElementById(e);t&&t.remove()}),n=0[0]};window.addEventListener("resize",_(()=>{elRect=0[0],n&&a(n)},10));function _(e,t){let s=!1,n;return(...o)=>{s?(n&&clearTimeout(n),n=setTimeout(()=>{e.apply(this,o),n=s=!1},t)):(e.apply(this,o),s=!0)}}const w=window.document.querySelectorAll("dt[data-target-cell]");for(const e of w)e.addEventListener("click",e=>{const t=e.target;if(t!==n){d();const e=window.document.querySelector("dt[data-target-cell].code-annotation-active");e&&e.classList.remove("code-annotation-active"),a(t),t.classList.add("code-annotation-active")}else d(),t.classList.remove("code-annotation-active")});const l=e=>{const t=e.parentElement;if(t){const n=t.dataset.cites;return n?{el:e,cites:n.split(" ")}:l(e.parentElement)}else return 0[0]};for(s=window.document.querySelectorAll('a[role="doc-biblioref"]'),t=0;t<s.length;t++){const n=s[t],e=l(n);e&&i(e.el,function(){var t=window.document.createElement("div");return e.cites.forEach(function(e){var s,n=window.document.createElement("div");n.classList.add("hanging-indent"),n.classList.add("csl-entry"),s=window.document.getElementById("ref-"+e),s&&(n.innerHTML=s.innerHTML),t.appendChild(n)}),t.innerHTML})}})</script></div><footer class=footer><div class=nav-footer><div class=nav-footer-left><p><img id=footer-cat-left src=../images/cat-left.png alt="Cat Left"></div><div class=nav-footer-center><p><span id=footer-center>Made with ❤️ by Tony, (CC&nbsp;BY&nbsp;4.0)<br><span style=font-size:8px>Cat source: Freepik and ChatGPT</span></span></div><div class=nav-footer-right><p><img id=footer-cat-right src=../images/cat-right.png alt="Cat Right"></div></div></footer>
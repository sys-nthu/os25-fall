<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en xml:lang=en><meta charset=utf-8><meta name=generator content="quarto-1.7.33"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><title>xv6-forkbomb ‚Äì Operating System (2025 Fall)</title><style>code{white-space:pre-wrap}span.smallcaps{font-variant:small-caps}div.columns{display:flex;gap:min(4vw,1.5em)}div.column{flex:auto;overflow-x:auto}div.hanging-indent{margin-left:1.5em;text-indent:-1.5em}ul.task-list{list-style:none}ul.task-list li input[type=checkbox]{width:.8em;margin:0 .8em .2em -1em;vertical-align:middle}html{-webkit-text-size-adjust:100%}pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em}pre.numberSource{margin-left:3em;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}</style><script src=../site_libs/quarto-nav/quarto-nav.js></script><script src=../site_libs/clipboard/clipboard.min.js></script><script src=../site_libs/quarto-search/autocomplete.umd.js></script><script src=../site_libs/quarto-search/fuse.min.js></script><script src=../site_libs/quarto-search/quarto-search.js></script><meta name=quarto:offset content="../"><link href=../images/orange.png rel=icon type=image/png><script src=../site_libs/quarto-html/quarto.js type=module></script><script src=../site_libs/quarto-html/tabsets/tabsets.js type=module></script><script src=../site_libs/quarto-html/popper.min.js></script><script src=../site_libs/quarto-html/tippy.umd.min.js></script><script src=../site_libs/quarto-html/anchor.min.js></script><link href=../site_libs/quarto-html/tippy.css rel=stylesheet><link href=../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css rel=stylesheet id=quarto-text-highlighting-styles><script src=../site_libs/bootstrap/bootstrap.min.js></script><link href=../site_libs/bootstrap/bootstrap-icons.css rel=stylesheet><link href=../site_libs/bootstrap/bootstrap-a3d6f4078ec9f2632a80ad631344d584.min.css rel=stylesheet append-hash=true id=quarto-bootstrap data-mode=light><script src=../site_libs/quarto-contrib/videojs/video.min.js></script><link href=../site_libs/quarto-contrib/videojs/video-js.css rel=stylesheet><script id=quarto-search-options type=application/json>{"location":"navbar","copy-button":false,"collapse-after":3,"panel-placement":"end","type":"overlay","limit":50,"keyboard-shortcut":["f","/","s"],"show-item-context":false,"language":{"search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search"}}</script><body class="nav-sidebar docked nav-fixed quarto-light"><div id=quarto-search-results></div><header id=quarto-header class="headroom fixed-top"><nav class="navbar navbar-expand-lg" data-bs-theme=dark><div class="navbar-container container-fluid"><div class="navbar-brand-container mx-auto"><a class=navbar-brand href=../index.html><span class=navbar-title>Operating System (2025 Fall)</span></a></div><div id=quarto-search title=Search></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarCollapse aria-controls=navbarCollapse role=menu aria-expanded=false aria-label="Toggle navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarCollapse><ul class="navbar-nav navbar-nav-scroll me-auto"><li class=nav-item><a class="nav-link active" href=../index.html aria-current=page><span class=menu-text>Home</span></a><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-handouts role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Handouts</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-handouts><li><a class=dropdown-item href=../handouts/env_setup.html><span class=dropdown-text>Environment Setup</span></a><li><a class=dropdown-item href=../handouts/unix.html><span class=dropdown-text>Unix</span></a><li><a class=dropdown-item href=../handouts/privilege.html><span class=dropdown-text>Privilege</span></a><li><a class=dropdown-item href=../handouts/scheduler.html><span class=dropdown-text>Scheduler</span></a><li><a class=dropdown-item href=../handouts/buffercache.html><span class=dropdown-text>Buffer Cache</span></a><li><a class=dropdown-item href=../handouts/vm-page-size.html><span class=dropdown-text>Virtual Memory: Page Size</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-labs role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Labs</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-labs><li><a class=dropdown-item href=../labs/mini-cloud.html><span class=dropdown-text>Mini Cloud</span></a><li><a class=dropdown-item href=../labs/linking.html><span class=dropdown-text>Linking</span></a><li><a class=dropdown-item href=../labs/process-creation.html><span class=dropdown-text>Process Creation</span></a><li><a class=dropdown-item href=../labs/process-state.html><span class=dropdown-text>Process State</span></a><li><a class=dropdown-item href=../labs/process-address-space.html><span class=dropdown-text>Process Address Space</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/path-traversal.html><span class=dropdown-text>Path Traversal</span></a><li><a class=dropdown-item href=../labs/pipe-passwords.html><span class=dropdown-text>Pipe Passwords</span></a><li><a class=dropdown-item href=../labs/pipe-dup.html><span class=dropdown-text>Pipe and dup()</span></a><li><a class=dropdown-item href=../labs/pipe-pingpong.html><span class=dropdown-text>Pipe Ping-Pong</span></a><li><a class=dropdown-item href=../labs/fifo.html><span class=dropdown-text>FIFO (named pipe)</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/cat.html><span class=dropdown-text>Cat</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/xv6-syscall.html><span class=dropdown-text>xv6 System Call Tracing</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-admin role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Admin</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-admin><li><a class=dropdown-item href=../admin/policies.html><span class=dropdown-text>Policies</span></a><li><a class=dropdown-item href=../admin/explore.html><span class=dropdown-text>Exploratory Projects</span></a><li><a class=dropdown-item href=../admin/waitbutwhy.html><span class=dropdown-text>SD1‚Üì (ÁáíËõã‰∏Ä‰∏ã)</span></a></ul></ul><ul class="navbar-nav navbar-nav-scroll ms-auto"><li class="nav-item compact"><a class=nav-link href="https://elearn.nthu.edu.tw/course/view.php?id=38873"><i class="bi bi-globe" role=img></i><span class=menu-text></span></a></ul></div><div class=quarto-navbar-tools></div></div></nav><nav class=quarto-secondary-nav><div class="container-fluid d-flex"><button type=button class="quarto-btn-toggle btn" data-bs-toggle=collapse role=button data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<i class="bi bi-layout-text-sidebar-reverse"></i></button><nav class=quarto-page-breadcrumbs aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=../weeks/w11.html>Worksheet 11</a><li class=breadcrumb-item><a href=../labs/xv6-forkbomb.html>xv6 Fork Bomb</a></ol></nav><a class=flex-grow-1 role=navigation data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()></a><button type=button class="btn quarto-search-button" aria-label=Search onclick=window.quartoOpenSearch()>
<i class="bi bi-search"></i></button></div></nav></header><div id=quarto-content class="quarto-container page-columns page-rows-contents page-layout-article page-navbar"><nav id=quarto-sidebar class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center"><div class=sidebar-search><div id=quarto-search title=Search></div></div></div><div class=sidebar-menu-container><ul class="list-unstyled mt-1"><li class=sidebar-item><div class=sidebar-item-container><a href=../index.html class="sidebar-item-text sidebar-link"><span class=menu-text>OS 2025 Fall</span></a></div><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w2.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 2</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-1 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-1 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/env_setup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Environment setup</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w3.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 3</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-2 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-2 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/unix.html class="sidebar-item-text sidebar-link"><span class=menu-text>Unix Philosophy</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/mini-cloud.html class="sidebar-item-text sidebar-link"><span class=menu-text>Your First Week in OS Journey</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-creation.html class="sidebar-item-text sidebar-link"><span class=menu-text><code>fork()</code>/<code>exec()</code></span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w4.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 4</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-3 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-3 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/privilege.html class="sidebar-item-text sidebar-link"><span class=menu-text>Privilege</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/path-traversal.html class="sidebar-item-text sidebar-link"><span class=menu-text>Lab: Path Traversal Attack</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-address-space.html class="sidebar-item-text sidebar-link"><span class=menu-text>Address Space Layout</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/linking.html class="sidebar-item-text sidebar-link"><span class=menu-text>Static vs Dynamic Linking</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w5.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 5</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-4 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-4 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-passwords.html class="sidebar-item-text sidebar-link"><span class=menu-text>Parallelizing Rainbow Table Lookup with Pipes</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-dup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipes, Redirection, and File Descriptors</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/fifo.html class="sidebar-item-text sidebar-link"><span class=menu-text>FIFO (named pipe)</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w6.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 6</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-5 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-5 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/scheduler.html class="sidebar-item-text sidebar-link"><span class=menu-text>Schedulers</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-state.html class="sidebar-item-text sidebar-link"><span class=menu-text>Process States in Linux</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-pingpong.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipe Pingpong</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w8.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 8</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-6 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-6 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/buffercache.html class="sidebar-item-text sidebar-link"><span class=menu-text>Caching and Buffering</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/cat.html class="sidebar-item-text sidebar-link"><span class=menu-text>How <code>cat</code> works?</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w9.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 9</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-7 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-7 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-intro.html class="sidebar-item-text sidebar-link"><span class=menu-text>Introduction to xv6</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-gdb.html class="sidebar-item-text sidebar-link"><span class=menu-text>GNU Debugger Tutorial</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-syscall.html class="sidebar-item-text sidebar-link"><span class=menu-text>xv6 Syscall Tracing</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w10.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 10</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-8 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-8 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/vm-page-size.html class="sidebar-item-text sidebar-link"><span class=menu-text>Why Android Moved to 16KB Pages</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w11.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 11</span></a>
<a class="sidebar-item-toggle text-start" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-9 role=navigation aria-expanded=true aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-9 class="collapse list-unstyled sidebar-section depth1 show"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-forkbomb.html class="sidebar-item-text sidebar-link active"><span class=menu-text>xv6 Fork Bomb</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-gdb.html class="sidebar-item-text sidebar-link"><span class=menu-text>GNU Debugger Tutorial</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-development-env.html class="sidebar-item-text sidebar-link"><span class=menu-text>Set Up Your Lab Environment</span></a></div></ul></ul></div></nav><div id=quarto-sidebar-glass class=quarto-sidebar-collapse-item data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item></div><div id=quarto-margin-sidebar class="sidebar margin-sidebar"><nav id=TOC role=doc-toc class=toc-active><h2 id=toc-title>On this page</h2><ul><li><a href=#xv6-fork-bomb id=toc-xv6-fork-bomb class="nav-link active" data-scroll-target=#xv6-fork-bomb>xv6 Fork Bomb</a><ul class=collapse><li><a href=#overview id=toc-overview class=nav-link data-scroll-target=#overview>Overview</a><li><a href=#implementation id=toc-implementation class=nav-link data-scroll-target=#implementation>Implementation</a><li><a href=#step-1-add-non-blocking-wait-warm-up id=toc-step-1-add-non-blocking-wait-warm-up class=nav-link data-scroll-target=#step-1-add-non-blocking-wait-warm-up>Step 1: Add Non-blocking Wait (Warm-up)</a><ul class=collapse><li><a href=#requirements id=toc-requirements class=nav-link data-scroll-target=#requirements>Requirements</a><li><a href=#how id=toc-how class=nav-link data-scroll-target=#how>How</a></ul><li><a href=#step-2-support-background-execution-1 id=toc-step-2-support-background-execution-1 class=nav-link data-scroll-target=#step-2-support-background-execution-1>Step 2: Support Background Execution</a><ul class=collapse><li><a href=#requirements-1 id=toc-requirements-1 class=nav-link data-scroll-target=#requirements-1>Requirements</a><li><a href=#create-a-user-program-sleep id=toc-create-a-user-program-sleep class=nav-link data-scroll-target=#create-a-user-program-sleep>Create a user program <code>sleep</code></a><li><a href=#expected-behavior id=toc-expected-behavior class=nav-link data-scroll-target=#expected-behavior>Expected Behavior</a><li><a href=#hints id=toc-hints class=nav-link data-scroll-target=#hints>Hints</a></ul><li><a href=#step-3-add-jobs-command-1 id=toc-step-3-add-jobs-command-1 class=nav-link data-scroll-target=#step-3-add-jobs-command-1>Step 3: Add&nbsp;<code>jobs</code>&nbsp;Command</a><ul class=collapse><li><a href=#prerequisites id=toc-prerequisites class=nav-link data-scroll-target=#prerequisites>Prerequisites</a><li><a href=#requirements-2 id=toc-requirements-2 class=nav-link data-scroll-target=#requirements-2>Requirements</a><li><a href=#how-1 id=toc-how-1 class=nav-link data-scroll-target=#how-1>How</a><li><a href=#hints-1 id=toc-hints-1 class=nav-link data-scroll-target=#hints-1>Hints</a></ul><li><a href=#step-4-shell-script-execution-1 id=toc-step-4-shell-script-execution-1 class=nav-link data-scroll-target=#step-4-shell-script-execution-1>Step 4: Shell Script Execution</a><ul class=collapse><li><a href=#demonstration id=toc-demonstration class=nav-link data-scroll-target=#demonstration>Demonstration</a><li><a href=#how-2 id=toc-how-2 class=nav-link data-scroll-target=#how-2>How</a><li><a href=#requirements-3 id=toc-requirements-3 class=nav-link data-scroll-target=#requirements-3>Requirements</a></ul><li><a href=#step-5-fork-bomb-script-1 id=toc-step-5-fork-bomb-script-1 class=nav-link data-scroll-target=#step-5-fork-bomb-script-1>Step 5: Fork Bomb Script</a><ul class=collapse><li><a href=#prerequisites-1 id=toc-prerequisites-1 class=nav-link data-scroll-target=#prerequisites-1>Prerequisites</a><li><a href=#lets-go id=toc-lets-go class=nav-link data-scroll-target=#lets-go>üí£ Let‚Äôs Go‚Ä¶ üí£</a></ul><li><a href=#run-grade-script id=toc-run-grade-script class=nav-link data-scroll-target=#run-grade-script>Run grade script</a><li><a href=#demo id=toc-demo class=nav-link data-scroll-target=#demo>Demo</a></ul></ul></nav></div><main class=content id=quarto-document-content><header id=title-block-header class=quarto-title-block><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=../weeks/w11.html>Worksheet 11</a><li class=breadcrumb-item><a href=../labs/xv6-forkbomb.html>xv6 Fork Bomb</a></ol></nav></header><section id=xv6-fork-bomb class=level1><h1>xv6 Fork Bomb</h1><p>In this lab, you will create a fork bomb in xv6. Recall that a shell (like <code>bash</code> on Linux) is a user program that reads commands entered by you (e.g., <code>ls -l</code>), parses that command text, and use system calls (<code>fork</code>, <code>exec</code>, <code>wait</code>) to execute the commands.<p><img src=../images/cat-bomb-2.png class=img-fluid style=max-width:240px;float:right;margin-left:30px><ul><li><strong>Foreground</strong> (e.g., <code>sleep 10</code>): The shell runs the command and <strong>waits</strong> for the command to finish. It calls <code>wait()</code> and blocks until <code>sleep</code> finishes before it gives you a new <code>$</code> prompt.<li><strong>Background</strong> (e.g., <code>sleep 10 &</code>): The <code>&</code> tells the shell: ‚ÄúRun this command, but do not wait for it. Give me a new <code>$</code> prompt immediately.‚Äù</ul><p>The current xv6 shell <code>user/sh.c</code> <em>partially</em> supports background job. It will run the command and give you a new prompt. But it reaps the background job. When the job finishes, it becomes a <strong>‚Äúzombie‚Äù</strong>. We can‚Äôt just ‚Äúfix‚Äù this by having the shell call <code>wait()</code>. The normal <code>wait()</code> system call is <strong>blocking</strong>. If the shell called <code>wait()</code>, it would freeze until the background job finished. Let‚Äôs add a new system call to fix this behavior.<section id=overview class=level2><h2 class=anchored data-anchor-id=overview>Overview</h2><section id=step-1-add-non-blocking-wait class=level4><h4 class=anchored data-anchor-id=step-1-add-non-blocking-wait>Step 1: Add Non-blocking Wait</h4><p>We need a system call that lets the shell <em>ask</em> the kernel, ‚ÄúHey, do I have any finished (zombie) children right now?‚Äù without being forced to wait. You will implement <code>wait_noblock()</code>. This new system call will check for zombie children:<ul><li>If it finds one, it reaps it and returns its PID.<li>If it finds <em>none</em>, it returns 0 <strong>immediately</strong> instead of blocking.</ul></section><section id=step-2-support-background-execution class=level4><h4 class=anchored data-anchor-id=step-2-support-background-execution>Step 2: Support Background Execution</h4><p>Now that we have <code>wait_noblock()</code>, let‚Äôs implement our background job processing as follows.<ol type=1><li><strong>Only fork once:</strong> The original xv6 shell <code>fork()</code>s twice to execute a command. You will modify this behavior to fork only once.<li><strong>Track jobs:</strong> When a background job starts, the shell will print its <code>[pid]</code>.<li><strong>Reap zombies:</strong> Before the shell prints a new <code>$</code> prompt, it will call your new <code>wait_noblock()</code> to reap background jobs that have finished.</ol></section><section id=step-3-add-jobs-command class=level4><h4 class=anchored data-anchor-id=step-3-add-jobs-command>Step 3: Add <code>jobs</code> Command</h4><p>This lets the user ask the shell, ‚ÄúWhat background processes are you currently managing?‚Äù You will implement <code>jobs</code> as a ‚Äúbuilt-in‚Äù command (part of the shell itself, like <code>cd</code>).<ul><li>When a background job is started, you add its PID to the array.<li>When a job is reaped by <code>wait_noblock()</code>, you remove its PID from the array.<li>When the user types <code>jobs</code>, you just print the contents of that array.</ul></section><section id=step-4-shell-script-execution class=level4><h4 class=anchored data-anchor-id=step-4-shell-script-execution>Step 4: Shell Script Execution</h4><p>xv6‚Äôs shell lacks the ability to run shell script. Modify <code>user/sh.c</code> so that: If the shell is run with no arguments (<code>$ sh</code>), it reads commands from the keyboard (interactive mode). If it‚Äôs run with an argument (<code>$ sh script.sh</code>), it will open that file and read/execute commands from it.</section><section id=step-5-fork-bomb-script class=level4><h4 class=anchored data-anchor-id=step-5-fork-bomb-script>Step 5: Fork Bomb Script</h4><p>You will create a script that calls itself in the background, over and over, <span class=red><strong>recursively</strong></span>. This will create new processes exponentially until the kernel has no more process slots and panics.<hr></section></section><section id=implementation class=level2><h2 class=anchored data-anchor-id=implementation>Implementation</h2><p>Please fork or clone the starter code from Github:<p><a href=https://github.com/sys-nthu/xv6-lab-forkbomb><img src=../images/StarStruck_SkinTone1.png class=img-fluid style=max-width:100px alt="open in GitHub"></a>.<p><span class=red>Please DO NOT continue developing on the previous project, xv6-lab-syscall-tracing. You must clone or fork the new repository ‚Äúxv6-lab-forkbomb‚Äù specifically for this lab, otherwise you will be missing the necessary grading programs and script files.</span><div class="callout callout-style-default callout-tip callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-1-contents aria-controls=callout-1 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">How to set up development environment</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-1 class="callout-1-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>Read <a href=../labs/xv6-development-env.html>this article</a>.</div></div></div><div class="callout callout-style-default callout-tip callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-2-contents aria-controls=callout-2 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">How to run and exit xv6</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-2 class="callout-2-contents callout-collapse collapse"><div class="callout-body-container callout-body"><section id=build-and-run-xv6 class=level6><h6 class=anchored data-anchor-id=build-and-run-xv6>Build and run xv6</h6><div class=sourceCode id=cb1><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=ex>prompt</span><span class=op>&gt;</span> make qemu</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=how-to-quit-qemu class=level6><h6 class=anchored data-anchor-id=how-to-quit-qemu>How to quit qemu</h6><p>Type&nbsp;<code>C-a x</code>&nbsp;(that is, hold down&nbsp;<code>control</code>&nbsp;and while doing so, press&nbsp;<code>a</code>, then let go of&nbsp;<code>control</code>, then press&nbsp;<code>x</code>). When you see <code>(qemu)</code>, type <code>quit</code> to quit qemu.</section></div></div></div><div class="callout callout-style-default callout-tip callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-3-contents aria-controls=callout-3 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">How to debug and analyze your code</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-3 class="callout-3-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>Read <a href=../labs/xv6-gdb.html>this article</a>.</div></div></div></section><section id=step-1-add-non-blocking-wait-warm-up class=level2><h2 class=anchored data-anchor-id=step-1-add-non-blocking-wait-warm-up>Step 1: Add Non-blocking Wait (Warm-up)</h2><p>Before your shell can monitor background job termination, you need a new system call to check for <strong>exited child processes without blocking</strong>.<section id=requirements class=level3><h3 class=anchored data-anchor-id=requirements>Requirements</h3><p>Add a new system call <code>uint64 sys_wait_noblock(void)</code>:<ul><li>If no zombie child is available, <strong>Returns 0</strong><li>If a zombie child is reaped, <strong>Returns zombie child‚Äôs PID</strong><li>If a zombie child is reaped, <strong>fills <code>*exit_status</code> with exit status of zombie child</strong></ul></section><section id=how class=level3><h3 class=anchored data-anchor-id=how>How</h3><ul><li><p>First, modify <code>kernel/proc.c</code> and <code>kernel/sysproc.c</code>:<h4 id=proc.c class=anchored>proc.c</h4><p>In <code>kernel/proc.c</code>, here‚Äôs an example implementation of non-blocking wait. You can directly copy and paste this entire code block into a suitable location:<div class=sourceCode id=cb2><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=dt>int</span> wait_noblock<span class=op>(</span>uint64 exit_status<span class=op>)</span> <span class=op>{</span></span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a>  <span class=co>// the current process, which is the shell</span></span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a>  <span class=kw>struct</span> proc <span class=op>*</span>p <span class=op>=</span> myproc<span class=op>();</span></span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a>  <span class=co>// loop through all processes</span></span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true tabindex=-1></a>  <span class=cf>for</span><span class=op>(</span><span class=kw>struct</span> proc <span class=op>*</span>pp <span class=op>=</span> proc<span class=op>;</span> pp <span class=op>&lt;</span> <span class=op>&amp;</span>proc<span class=op>[</span>NPROC<span class=op>];</span> pp<span class=op>++){</span></span>
<span id=cb2-6><a href=#cb2-6 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span><span class=op>(</span>pp<span class=op>-&gt;</span>parent <span class=op>==</span> p <span class=op>&amp;&amp;</span> pp<span class=op>-&gt;</span>state <span class=op>==</span> ZOMBIE<span class=op>){</span></span>
<span id=cb2-7><a href=#cb2-7 aria-hidden=true tabindex=-1></a>      <span class=dt>int</span> pid <span class=op>=</span> pp<span class=op>-&gt;</span>pid<span class=op>;</span></span>
<span id=cb2-8><a href=#cb2-8 aria-hidden=true tabindex=-1></a>      <span class=co>// Get the child's xstate (exit code) to user space:</span></span>
<span id=cb2-9><a href=#cb2-9 aria-hidden=true tabindex=-1></a>      <span class=cf>if</span><span class=op>(</span>copyout<span class=op>(</span>p<span class=op>-&gt;</span>pagetable<span class=op>,</span> exit_status<span class=op>,</span> <span class=op>(</span><span class=dt>char</span> <span class=op>*)&amp;</span>pp<span class=op>-&gt;</span>xstate<span class=op>,</span> <span class=kw>sizeof</span><span class=op>(</span><span class=dt>int</span><span class=op>))</span> <span class=op>&lt;</span> <span class=dv>0</span><span class=op>)</span></span>
<span id=cb2-10><a href=#cb2-10 aria-hidden=true tabindex=-1></a>        <span class=cf>return</span> <span class=op>-</span><span class=dv>1</span><span class=op>;</span></span>
<span id=cb2-11><a href=#cb2-11 aria-hidden=true tabindex=-1></a>      <span class=co>// Free the process entry from the proc table</span></span>
<span id=cb2-12><a href=#cb2-12 aria-hidden=true tabindex=-1></a>      freeproc<span class=op>(</span>pp<span class=op>);</span></span>
<span id=cb2-13><a href=#cb2-13 aria-hidden=true tabindex=-1></a>      <span class=cf>return</span> pid<span class=op>;</span></span>
<span id=cb2-14><a href=#cb2-14 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb2-15><a href=#cb2-15 aria-hidden=true tabindex=-1></a>  <span class=op>}</span></span>
<span id=cb2-16><a href=#cb2-16 aria-hidden=true tabindex=-1></a>  <span class=cf>return</span> <span class=dv>0</span><span class=op>;</span> <span class=co>// no zombie child</span></span>
<span id=cb2-17><a href=#cb2-17 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><blockquote class=blockquote><p>In the above code, we loop through all processes and check if they have entered <em>zombie</em> state (the child has ended but the parent doesn‚Äôt call <code>wait()</code> to get its exit status).</blockquote><h4 id=sysproc.c class=anchored>sysproc.c</h4><p>In <code>kernel/sysproc.c</code>, here‚Äôs an example implementation of <strong>system call for non-blocking wait</strong>. You can directly copy and paste this entire code block into a suitable location:<div class=sourceCode id=cb3><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a>uint64</span>
<span id=cb3-2><a href=#cb3-2 aria-hidden=true tabindex=-1></a>sys_wait_noblock<span class=op>(</span><span class=dt>void</span><span class=op>)</span></span>
<span id=cb3-3><a href=#cb3-3 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb3-4><a href=#cb3-4 aria-hidden=true tabindex=-1></a>  uint64 exit_status<span class=op>;</span></span>
<span id=cb3-5><a href=#cb3-5 aria-hidden=true tabindex=-1></a>  argaddr<span class=op>(</span><span class=dv>0</span><span class=op>,</span> <span class=op>&amp;</span>exit_status<span class=op>);</span></span>
<span id=cb3-6><a href=#cb3-6 aria-hidden=true tabindex=-1></a>  <span class=cf>return</span> wait_noblock<span class=op>(</span>exit_status<span class=op>);</span></span>
<span id=cb3-7><a href=#cb3-7 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><li><p>Then, register the syscall in <code>kernel/syscall.h</code>, <code>kernel/syscall.c</code>, <code>kernel/defs.h</code>, <code>user/usys.pl</code> and <code>user/user.h</code>. (Try it yourself)</ul><p><strong>Think About It:</strong></p><p>Can you trace and explain the complete life cycle (or ‚Äòjourney‚Äô) of a system call, starting from the moment it‚Äôs triggered in a user program, to the moment the user process gets the return value?</section></section><section id=step-2-support-background-execution-1 class=level2><h2 class=anchored data-anchor-id=step-2-support-background-execution-1>Step 2: Support Background Execution</h2><p>xv6 already parses commands ending with&nbsp;<code>&</code>&nbsp;and runs them in the background (see&nbsp;<code>BACK</code>&nbsp;command type in&nbsp;<code>user/sh.c</code>). However, it does not print the child PID, does not track or clean up exited background jobs.<section id=requirements-1 class=level3><h3 class=anchored data-anchor-id=requirements-1>Requirements</h3><ul><li><p>When a background job is run, print&nbsp;<code>[pid]</code>&nbsp;of the child in a new line and print a new command prompt <code>$</code>.<li><p><strong>BEFORE</strong> printing a new command prompt <code>$</code> and <strong>AFTER</strong> inputting a command, poll&nbsp;<code>wait_noblock()</code>&nbsp;to check if there is any exited background job. If there is, print it:<div class=sourceCode id=cb4><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> pid] exited with status X</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></ul><div class="callout callout-style-default callout-tip callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-4-contents aria-controls=callout-4 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Clarification for AFTER and BEFORE:</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-4 class="callout-4-contents callout-collapse collapse"><div class="callout-body-container callout-body"><ul><li><p>Clarification for ‚Äú<strong>AFTER</strong> inputting a command‚Äù: immediately after getcmd() returns<li><p>Clarification for ‚Äú<strong>BEFORE</strong> printing a new command prompt <code>$</code>‚Äù: immediately before printing a new command prompt <code>$</code></ul></div></div></div><ul><li><p>Example Implementation for polling <code>wait_noblock()</code>:<div class=sourceCode id=cb5><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb5-1><a href=#cb5-1 aria-hidden=true tabindex=-1></a><span class=dt>int</span> status<span class=op>;</span></span>
<span id=cb5-2><a href=#cb5-2 aria-hidden=true tabindex=-1></a><span class=dt>int</span> pid<span class=op>;</span></span>
<span id=cb5-3><a href=#cb5-3 aria-hidden=true tabindex=-1></a><span class=cf>while</span> <span class=op>((</span>pid <span class=op>=</span> wait_noblock<span class=op>(&amp;</span>status<span class=op>))</span> <span class=op>&gt;</span> <span class=dv>0</span><span class=op>)</span></span>
<span id=cb5-4><a href=#cb5-4 aria-hidden=true tabindex=-1></a>  printf<span class=op>(</span><span class=st>"[bg </span><span class=sc>%d</span><span class=st>] exited with status </span><span class=sc>%d\n</span><span class=st>"</span><span class=op>,</span> pid<span class=op>,</span> status<span class=op>);</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></ul></section><section id=create-a-user-program-sleep class=level3><h3 class=anchored data-anchor-id=create-a-user-program-sleep>Create a user program <code>sleep</code></h3><ul><li><p>Create a file <code>user/sleep.c</code>:<div class=sourceCode id=cb6><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb6-1><a href=#cb6-1 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"kernel/types.h"</span></span>
<span id=cb6-2><a href=#cb6-2 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"user/user.h"</span></span>
<span id=cb6-3><a href=#cb6-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-4><a href=#cb6-4 aria-hidden=true tabindex=-1></a><span class=dt>int</span></span>
<span id=cb6-5><a href=#cb6-5 aria-hidden=true tabindex=-1></a>main<span class=op>(</span><span class=dt>int</span> argc<span class=op>,</span> <span class=dt>char</span><span class=op>*</span> argv<span class=op>[])</span></span>
<span id=cb6-6><a href=#cb6-6 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb6-7><a href=#cb6-7 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span><span class=op>(</span>argc <span class=op>!=</span> <span class=dv>2</span><span class=op>)</span></span>
<span id=cb6-8><a href=#cb6-8 aria-hidden=true tabindex=-1></a>    <span class=op>{</span></span>
<span id=cb6-9><a href=#cb6-9 aria-hidden=true tabindex=-1></a>        printf<span class=op>(</span><span class=st>"no argument or too many arguments.</span><span class=sc>\n</span><span class=st>"</span><span class=op>);</span></span>
<span id=cb6-10><a href=#cb6-10 aria-hidden=true tabindex=-1></a>        exit<span class=op>(</span><span class=dv>1</span><span class=op>);</span></span>
<span id=cb6-11><a href=#cb6-11 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb6-12><a href=#cb6-12 aria-hidden=true tabindex=-1></a>    sleep<span class=op>(</span>atoi<span class=op>(</span>argv<span class=op>[</span><span class=dv>1</span><span class=op>]));</span></span>
<span id=cb6-13><a href=#cb6-13 aria-hidden=true tabindex=-1></a>    exit<span class=op>(</span><span class=dv>0</span><span class=op>);</span></span>
<span id=cb6-14><a href=#cb6-14 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><li><p>Add new path <code>$U/_sleep\</code> to <code>UPROGS</code> in <code>Makefile</code>.<li><p>Make sure you can <code>$ sleep 20</code> without running into error messages <code>exec sleep failed</code> in xv6.<li><p><span class=red>You‚Äôll notice that in xv6, <code>$ sleep 50</code> doesn‚Äôt actually sleep for 50 seconds, but <strong>approximately</strong> 5 seconds.</span> This isn‚Äôt an anomaly. you can investigate the specific reason and mechanism for this behavior.</ul></section><section id=expected-behavior class=level3><h3 class=anchored data-anchor-id=expected-behavior>Expected Behavior</h3><p>The followings are examples about how your xv6 should behave and how your xv6 should not behave.<p>‚úîÔ∏è <strong>CASE 1</strong>: Run three background job <code>sleep</code>, <code>pid</code> increases by one:<div class=sourceCode id=cb7><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb7-1><a href=#cb7-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 1000 <span class=kw>&amp;</span></span>
<span id=cb7-2><a href=#cb7-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb7-3><a href=#cb7-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 1000 <span class=kw>&amp;</span></span>
<span id=cb7-4><a href=#cb7-4 aria-hidden=true tabindex=-1></a><span class=ex>[4]</span></span>
<span id=cb7-5><a href=#cb7-5 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 1000 <span class=kw>&amp;</span></span>
<span id=cb7-6><a href=#cb7-6 aria-hidden=true tabindex=-1></a><span class=ex>[5]</span></span>
<span id=cb7-7><a href=#cb7-7 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><div class=quarto-video><video id=video_shortcode_videojs_video1 width=192 height=144 class="video-js vjs-default-skin" controls preload=auto data-setup={} title><source src=../images/xv6_ForkBomb_TestCase_1.mp4></video></div><div class="callout callout-style-default callout-warning callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-5-contents aria-controls=callout-5 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">incorrect behavior</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-5 class="callout-5-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>‚úîÔ∏è Run three background job <code>sleep</code>, <code>pid</code> increases by two:<div class=sourceCode id=cb8><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb8-1><a href=#cb8-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 1000 <span class=kw>&amp;</span></span>
<span id=cb8-2><a href=#cb8-2 aria-hidden=true tabindex=-1></a><span class=ex>[4]</span></span>
<span id=cb8-3><a href=#cb8-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 1000 <span class=kw>&amp;</span></span>
<span id=cb8-4><a href=#cb8-4 aria-hidden=true tabindex=-1></a><span class=ex>[6]</span></span>
<span id=cb8-5><a href=#cb8-5 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 1000 <span class=kw>&amp;</span></span>
<span id=cb8-6><a href=#cb8-6 aria-hidden=true tabindex=-1></a><span class=ex>[8]</span></span>
<span id=cb8-7><a href=#cb8-7 aria-hidden=true tabindex=-1></a><span class=ex>$&nbsp;</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>This undesired output is caused by <strong>xv6‚Äôs original <code>user/sh.c</code> implementation, which <code>fork()</code>s twice</strong> for a single command.<ol type=1><li>The shell <code>forks()</code> once to create a child process.<li>This child process then <code>forks()</code> <em>again</em> to create a grandchild process that actually <code>exec()</code>s the <code>sleep</code> command.</ol><p>Even though you only want one background process, this default behavior creates two new processes. Since xv6‚Äôs <code>allocpid</code> function increments the PID for each new process (<strong><code>nextpid = nextpid + 1</code></strong>) and does not reuse PIDs, each background command consumes two PIDs. This is why you see the job IDs jumping by two (e.g., <code>[4]</code>, <code>[6]</code>, <code>[8]</code>).<p>Please <strong>change <code>user/sh.c</code></strong> so that starting a background job creates only <strong>one</strong> process, not two.</div></div></div><p>‚úîÔ∏è <strong>CASE 2</strong>: After the user has entered a second command, the shell calls <code>wait_noblock()</code> and finds that <code>pid=3</code> is finished. It printed <code>[bg 3] exited with status 0</code> before executing the second command.<div class=sourceCode id=cb9><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb9-1><a href=#cb9-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 10 <span class=kw>&amp;</span></span>
<span id=cb9-2><a href=#cb9-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb9-3><a href=#cb9-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 10 <span class=kw>&amp;</span></span>
<span id=cb9-4><a href=#cb9-4 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 3] exited with status 0</span>
<span id=cb9-5><a href=#cb9-5 aria-hidden=true tabindex=-1></a><span class=ex>[4]</span></span>
<span id=cb9-6><a href=#cb9-6 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 10 <span class=kw>&amp;</span></span>
<span id=cb9-7><a href=#cb9-7 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 4] exited with status 0</span>
<span id=cb9-8><a href=#cb9-8 aria-hidden=true tabindex=-1></a><span class=ex>[5]</span></span>
<span id=cb9-9><a href=#cb9-9 aria-hidden=true tabindex=-1></a><span class=ex>$</span> </span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><div class=quarto-video><video id=video_shortcode_videojs_video2 width=192 height=144 class="video-js vjs-default-skin" controls preload=auto data-setup={} title><source src=../images/xv6_ForkBomb_TestCase_2.mp4></video></div><p>‚úîÔ∏è <strong>CASE 3</strong>: After the user has entered the fourth command, the shell calls <code>wait_noblock()</code> and finds that all three previous jobs have finished. It printed <code>[bg 3] exited with status 0</code>, <code>[bg 4] exited with status 0</code>, <code>[bg 5] exited with status 0</code> before executing the fourth command.<div class=sourceCode id=cb10><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb10-1><a href=#cb10-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb10-2><a href=#cb10-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb10-3><a href=#cb10-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb10-4><a href=#cb10-4 aria-hidden=true tabindex=-1></a><span class=ex>[4]</span></span>
<span id=cb10-5><a href=#cb10-5 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb10-6><a href=#cb10-6 aria-hidden=true tabindex=-1></a><span class=ex>[5]</span></span>
<span id=cb10-7><a href=#cb10-7 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 10</span>
<span id=cb10-8><a href=#cb10-8 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 3] exited with status 0</span>
<span id=cb10-9><a href=#cb10-9 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 4] exited with status 0</span>
<span id=cb10-10><a href=#cb10-10 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 5] exited with status 0</span>
<span id=cb10-11><a href=#cb10-11 aria-hidden=true tabindex=-1></a><span class=ex>$</span> </span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><div class=quarto-video><video id=video_shortcode_videojs_video3 width=192 height=144 class="video-js vjs-default-skin" controls preload=auto data-setup={} title><source src=../images/xv6_ForkBomb_TestCase_3.mp4></video></div><p>‚úîÔ∏è <strong>CASE 4</strong>: The user execute two commands connected with a pipe as background process. Print the pid of the first command in the pipeline.</p><div class=sourceCode id=cb11><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb11-1><a href=#cb11-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> ls README <span class=kw>|</span> <span class=fu>cat</span> <span class=kw>&amp;</span></span>
<span id=cb11-2><a href=#cb11-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb11-3><a href=#cb11-3 aria-hidden=true tabindex=-1></a><span class=ex>README</span>         2 2 2292</span>
<span id=cb11-4><a href=#cb11-4 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 3] exited with status 0</span>
<span id=cb11-5><a href=#cb11-5 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><div class="callout callout-style-default callout-warning callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-6-contents aria-controls=callout-6 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">incorrect behavior</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-6 class="callout-6-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>‚ùå Print a new command prompt <code>$</code> more than once instead of <strong>EXACTLY ONCE</strong>:<div class=sourceCode id=cb12><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb12-1><a href=#cb12-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 10 <span class=kw>|</span> <span class=fu>sleep</span> 10 <span class=kw>&amp;</span></span>
<span id=cb12-2><a href=#cb12-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb12-3><a href=#cb12-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> $ $</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><ul><li><p>This is likely due to incorrect control flow within <code>main()</code>. You can debug this by finding out when and where the <code>$</code> prompt is being printed.<li><p>We use this command to test if you print the <code>$</code> prompt only once. If this command looks strange to you, just imagine it is running two long-running programs in background.</ul><p><strong>Think about it:</strong> Printing only one <code>[pid]</code> for this command is the correct behavior. But why is only one <code>[pid]</code> printed? Does this <code>[pid]</code> represent either one of the <code>sleep</code> processes in the pipe?‚Äù</div></div></div><p>‚úîÔ∏è <strong>CASE 5</strong>: You execute an non-existing binary (e.g., ‚Äúasdfgh‚Äù) as background job, please still print its PID and exit status.<p><em>(For the sake of simplicity, it‚Äôs ok in this lab that you don‚Äôt return exit status 127 as command not found)</em><div class=sourceCode id=cb13><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb13-1><a href=#cb13-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> asdfgh <span class=kw>&amp;</span></span>
<span id=cb13-2><a href=#cb13-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb13-3><a href=#cb13-3 aria-hidden=true tabindex=-1></a><span class=bu>exec</span> asdfgh failed</span>
<span id=cb13-4><a href=#cb13-4 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 3] exited with status 0</span>
<span id=cb13-5><a href=#cb13-5 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><div class="callout callout-style-default callout-warning callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-7-contents aria-controls=callout-7 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">incorrect behavior</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-7 class="callout-7-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>‚ùå ‚Äúasdfgh‚Äù does not exist but you execute it, but you don‚Äôt find it as a exited background job and you don‚Äôt print it:<div class=sourceCode id=cb14><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb14-1><a href=#cb14-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> asdfgh <span class=kw>&amp;</span></span>
<span id=cb14-2><a href=#cb14-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb14-3><a href=#cb14-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> exec asdfgh failed</span>
<span id=cb14-4><a href=#cb14-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb14-5><a href=#cb14-5 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>‚ùå Even though <code>[bg 3] exited with status 0</code> printed successfully, the <code>exec asdfgh failed</code> message appeared after the <code>$</code> prompt, and you still have to press <strong>ENTER</strong> again just to get a new <code>$</code> prompt.<div class=sourceCode id=cb15><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb15-1><a href=#cb15-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> asdfgh <span class=kw>&amp;</span></span>
<span id=cb15-2><a href=#cb15-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb15-3><a href=#cb15-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> exec asdfgh failed</span>
<span id=cb15-4><a href=#cb15-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb15-5><a href=#cb15-5 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 3] exited with status 0</span>
<span id=cb15-6><a href=#cb15-6 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>This is the <span class=red>hardest test case</span> in the entire lab. If you get stuck on it for too long, we recommend you finish implementing the other features first and then come back to this one later.</div></div></div><p>‚úîÔ∏è <strong>CASE 6</strong>: If you run a foreground process before background jobs exit, then after that foreground process finishes (and before the $ prompt is displayed), the exit status of the background jobs should be displayed.<div class=sourceCode id=cb16><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb16-1><a href=#cb16-1 aria-hidden=true tabindex=-1></a><span class=ex>xv6</span> kernel is booting</span>
<span id=cb16-2><a href=#cb16-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb16-3><a href=#cb16-3 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 2 starting</span>
<span id=cb16-4><a href=#cb16-4 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 1 starting</span>
<span id=cb16-5><a href=#cb16-5 aria-hidden=true tabindex=-1></a><span class=ex>init:</span> starting sh</span>
<span id=cb16-6><a href=#cb16-6 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb16-7><a href=#cb16-7 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb16-8><a href=#cb16-8 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50</span>
<span id=cb16-9><a href=#cb16-9 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 3] exited with status 0</span>
<span id=cb16-10><a href=#cb16-10 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><div class=quarto-video><video id=video_shortcode_videojs_video4 width=192 height=144 class="video-js vjs-default-skin" controls preload=auto data-setup={} title><source src=../images/xv6_ForkBomb_TestCase_5.mp4></video></div><div class="callout callout-style-default callout-warning callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-8-contents aria-controls=callout-8 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">incorrect behavior</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-8 class="callout-8-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>‚ùå We expect reaping background jobs with <code>PID == 3</code> but instead we end up reaping foreground process <code>PID == 4</code>:<div class=sourceCode id=cb17><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb17-1><a href=#cb17-1 aria-hidden=true tabindex=-1></a><span class=ex>xv6</span> kernel is booting</span>
<span id=cb17-2><a href=#cb17-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb17-3><a href=#cb17-3 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 2 starting</span>
<span id=cb17-4><a href=#cb17-4 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 1 starting</span>
<span id=cb17-5><a href=#cb17-5 aria-hidden=true tabindex=-1></a><span class=ex>init:</span> starting sh</span>
<span id=cb17-6><a href=#cb17-6 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb17-7><a href=#cb17-7 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb17-8><a href=#cb17-8 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50</span>
<span id=cb17-9><a href=#cb17-9 aria-hidden=true tabindex=-1></a><span class=ex>$</span> </span>
<span id=cb17-10><a href=#cb17-10 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 4] exited with status 0</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>‚ùå We don‚Äôt see any <code>[bg 3] exited with status 0</code>, but it should be there:<div class=sourceCode id=cb18><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb18-1><a href=#cb18-1 aria-hidden=true tabindex=-1></a><span class=ex>xv6</span> kernel is booting</span>
<span id=cb18-2><a href=#cb18-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb18-3><a href=#cb18-3 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 2 starting</span>
<span id=cb18-4><a href=#cb18-4 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 1 starting</span>
<span id=cb18-5><a href=#cb18-5 aria-hidden=true tabindex=-1></a><span class=ex>init:</span> starting sh</span>
<span id=cb18-6><a href=#cb18-6 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb18-7><a href=#cb18-7 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb18-8><a href=#cb18-8 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50</span>
<span id=cb18-9><a href=#cb18-9 aria-hidden=true tabindex=-1></a><span class=ex>$</span> </span>
<span id=cb18-10><a href=#cb18-10 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Sometimes, or in this case, you may find that you are not reaping background processes but instead the foreground process as a <strong>zombie</strong>. Why?<ul><li><p>What happened to background processes?<li><p><strong>WHEN</strong> and <strong>WHERE</strong> do background processes being reaped?<li><p>Can you modify <code>user/sh.c</code> to properly <code>wait</code> for the foreground process?</ul><section id=a-hint-for-one-of-the-possible-solutions class=level5><h5 class=anchored data-anchor-id=a-hint-for-one-of-the-possible-solutions>A hint for one of the possible solutions</h5><ul><li><code>jobs[NPROC]</code> in Step 3 will provide you information about who is background process and who is NOT.</ul></section></div></div></div></section><section id=hints class=level3><h3 class=anchored data-anchor-id=hints>Hints</h3><ul><li><p>Make good use of debugger to carefully inspect and learn how <code>sh</code> works when you are executing foreground or background commands <em>(for example, <code>$ sleep 60</code> and <code>$ sleep 60 &</code>)</em>.<li><p>Be careful with <strong>the process you are currently in</strong> if you don‚Äôt get any result from polling <code>wait_noblock()</code>.<li><p>If you still can‚Äôt figure out how to correctly polling <code>wait_noblock()</code>, observe that:<ul><li><p>Which process becomes orphan in <code>sh</code>?<li><p>Can you tell about why orphaned processes may exist?<li><p>How can you modify <code>sh.c</code> to avoid orphaned processes?</ul></ul></section></section><section id=step-3-add-jobs-command-1 class=level2><h2 class=anchored data-anchor-id=step-3-add-jobs-command-1>Step 3: Add&nbsp;<code>jobs</code>&nbsp;Command</h2><p>Now we will add a new command <code>jobs</code> to show all currently running background jobs!<div class=sourceCode id=cb19><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb19-1><a href=#cb19-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb19-2><a href=#cb19-2 aria-hidden=true tabindex=-1></a><span class=ex>[3]</span></span>
<span id=cb19-3><a href=#cb19-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb19-4><a href=#cb19-4 aria-hidden=true tabindex=-1></a><span class=ex>[4]</span></span>
<span id=cb19-5><a href=#cb19-5 aria-hidden=true tabindex=-1></a><span class=ex>$</span> jobs</span>
<span id=cb19-6><a href=#cb19-6 aria-hidden=true tabindex=-1></a><span class=ex>3</span></span>
<span id=cb19-7><a href=#cb19-7 aria-hidden=true tabindex=-1></a><span class=ex>4</span></span>
<span id=cb19-8><a href=#cb19-8 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sleep 50 <span class=kw>&amp;</span></span>
<span id=cb19-9><a href=#cb19-9 aria-hidden=true tabindex=-1></a><span class=ex>[5]</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><blockquote class=blockquote><p>In the example above, <code>jobs</code> command prints all currently running background jobs‚Äô PID.</blockquote><section id=prerequisites class=level3><h3 class=anchored data-anchor-id=prerequisites>Prerequisites</h3><p>Please add the following code to <code>user/sh.c</code> first:<div class=sourceCode id=cb20><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb20-1><a href=#cb20-1 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"kernel/param.h"</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=requirements-2 class=level3><h3 class=anchored data-anchor-id=requirements-2>Requirements</h3><ul><li><p>Add <code>jobs</code> command that show all currently running background jobs.<li><p><span class=red><code>jobs</code> command is not a system call nor a standalone user program.</span> <span class=green>It‚Äôs a shell <strong>built-in</strong> command.</span> You should implement all the functionality of <code>jobs</code> command <strong>ONLY</strong> within <code>user/sh.c</code>.<li><p>You should track background PIDs in a fixed-size array.<li><p>Remember to <strong>remove already exited background jobs</strong> from <code>jobs[NPROC]</code>. Do not print any background PID which was already reaped.<li><p><strong>DO NOT</strong> print anything if no background job is running.<li><p>For the sake of simplicity, you don‚Äôt have to parse <code>jobs &</code> command in this lab. It‚Äôs ok to get <code>exec jobs failed</code> if you input <code>jobs &</code> command.</ul></section><section id=how-1 class=level3><h3 class=anchored data-anchor-id=how-1>How</h3><p>To support&nbsp;<code>jobs</code>&nbsp;command that prints all live (not-yet-reaped) background PIDs, you should modify&nbsp;<code>sh.c</code>:<ol type=1><li><p>Parse the <code>jobs</code> command.<li><p>Create a fixed-size array&nbsp;<code>jobs[NPROC]</code>&nbsp;as global variable. <em>(<code>NPROC</code> has been defined in <code>kernel/param.h</code> so you don‚Äôt have to declare it yourself)</em>.<li><p>Before executing background jobs, add the new child PID into&nbsp;<code>jobs[NPROC]</code>.<li><p>When&nbsp;<code>jobs</code>&nbsp;command is called, print all PID of background jobs currently running.</ol></section><section id=hints-1 class=level3><h3 class=anchored data-anchor-id=hints-1>Hints</h3><ul><li>If you don‚Äôt know how to parse <code>jobs</code> command, observe how <code>cd</code> command was parsed in <code>user/sh.c</code>. <strong>BUT</strong> for <code>jobs</code> command, things are a little different. <span class=green>(Is there any additional <code>char</code> at the tail of <code>jobs</code> strings when you type <code>jobs</code> and press <code>ENTER</code> in shell?)</span></ul></section></section><section id=step-4-shell-script-execution-1 class=level2><h2 class=anchored data-anchor-id=step-4-shell-script-execution-1>Step 4: Shell Script Execution</h2><p>Here comes the most exciting part: We will add support to <code>user/sh.c</code> so it can run a simple shell script fileüòÅ<section id=demonstration class=level3><h3 class=anchored data-anchor-id=demonstration>Demonstration</h3><p>Let‚Äôs look at the example about how to run a shell script file in xv6:<p>We have a file <code>user/script.sh</code>:<div class=sourceCode id=cb21><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb21-1><a href=#cb21-1 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> hello</span>
<span id=cb21-2><a href=#cb21-2 aria-hidden=true tabindex=-1></a><span class=fu>sleep</span> 40 <span class=kw>&amp;</span></span>
<span id=cb21-3><a href=#cb21-3 aria-hidden=true tabindex=-1></a><span class=fu>sleep</span> 30 <span class=kw>&amp;</span></span>
<span id=cb21-4><a href=#cb21-4 aria-hidden=true tabindex=-1></a><span class=bu>jobs</span></span>
<span id=cb21-5><a href=#cb21-5 aria-hidden=true tabindex=-1></a><span class=fu>sleep</span> 50</span>
<span id=cb21-6><a href=#cb21-6 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> Im awake</span>
<span id=cb21-7><a href=#cb21-7 aria-hidden=true tabindex=-1></a><span class=fu>sleep</span> 60 <span class=kw>&amp;</span></span>
<span id=cb21-8><a href=#cb21-8 aria-hidden=true tabindex=-1></a><span class=bu>jobs</span></span>
<span id=cb21-9><a href=#cb21-9 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> done</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>In <strong>xv6</strong>, we <code>$ sh script.sh</code> to run shell script file <code>script.sh</code>, and we get the following result:<div class=sourceCode id=cb22><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb22-1><a href=#cb22-1 aria-hidden=true tabindex=-1></a><span class=ex>xv6</span> kernel is booting</span>
<span id=cb22-2><a href=#cb22-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb22-3><a href=#cb22-3 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 1 starting</span>
<span id=cb22-4><a href=#cb22-4 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 2 starting</span>
<span id=cb22-5><a href=#cb22-5 aria-hidden=true tabindex=-1></a><span class=ex>init:</span> starting sh</span>
<span id=cb22-6><a href=#cb22-6 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sh script.sh</span>
<span id=cb22-7><a href=#cb22-7 aria-hidden=true tabindex=-1></a><span class=ex>hello</span></span>
<span id=cb22-8><a href=#cb22-8 aria-hidden=true tabindex=-1></a><span class=ex>[5]</span></span>
<span id=cb22-9><a href=#cb22-9 aria-hidden=true tabindex=-1></a><span class=ex>[6]</span></span>
<span id=cb22-10><a href=#cb22-10 aria-hidden=true tabindex=-1></a><span class=ex>5</span></span>
<span id=cb22-11><a href=#cb22-11 aria-hidden=true tabindex=-1></a><span class=ex>6</span></span>
<span id=cb22-12><a href=#cb22-12 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 6] exited with status 0</span>
<span id=cb22-13><a href=#cb22-13 aria-hidden=true tabindex=-1></a><span class=ex>[bg</span> 5] exited with status 0</span>
<span id=cb22-14><a href=#cb22-14 aria-hidden=true tabindex=-1></a><span class=ex>Im</span> awake</span>
<span id=cb22-15><a href=#cb22-15 aria-hidden=true tabindex=-1></a><span class=ex>[9]</span></span>
<span id=cb22-16><a href=#cb22-16 aria-hidden=true tabindex=-1></a><span class=ex>9</span></span>
<span id=cb22-17><a href=#cb22-17 aria-hidden=true tabindex=-1></a><span class=cf>done</span></span>
<span id=cb22-18><a href=#cb22-18 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>In <strong>Bash</strong> or other shells, if you run the exact same shell script, you will not get the exact same result as above, so please don‚Äôt refer to or rely on the output of other shells too much in Step 4.</section><section id=how-2 class=level3><h3 class=anchored data-anchor-id=how-2>How</h3><ol type=1><li><p>First, copy and paste the following script into <code>user/script.sh</code>:<div class=sourceCode id=cb23><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb23-1><a href=#cb23-1 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> hello</span>
<span id=cb23-2><a href=#cb23-2 aria-hidden=true tabindex=-1></a><span class=fu>sleep</span> 2 <span class=kw>&amp;</span></span>
<span id=cb23-3><a href=#cb23-3 aria-hidden=true tabindex=-1></a><span class=bu>echo</span> done</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></ol><div class="callout callout-style-default callout-tip callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-9-contents aria-controls=callout-9 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Expected output</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-9 class="callout-9-contents callout-collapse collapse"><div class="callout-body-container callout-body"><div class=sourceCode id=cb24><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb24-1><a href=#cb24-1 aria-hidden=true tabindex=-1></a><span class=ex>xv6</span> kernel is booting</span>
<span id=cb24-2><a href=#cb24-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb24-3><a href=#cb24-3 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 1 starting</span>
<span id=cb24-4><a href=#cb24-4 aria-hidden=true tabindex=-1></a><span class=ex>hart</span> 2 starting</span>
<span id=cb24-5><a href=#cb24-5 aria-hidden=true tabindex=-1></a><span class=ex>init:</span> starting sh</span>
<span id=cb24-6><a href=#cb24-6 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sh script.sh</span>
<span id=cb24-7><a href=#cb24-7 aria-hidden=true tabindex=-1></a><span class=ex>hello</span></span>
<span id=cb24-8><a href=#cb24-8 aria-hidden=true tabindex=-1></a><span class=ex>[5]</span></span>
<span id=cb24-9><a href=#cb24-9 aria-hidden=true tabindex=-1></a><span class=cf>done</span></span>
<span id=cb24-10><a href=#cb24-10 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></div></div></div><ol start=2 type=1><li><p>In <code>user/sh.c</code>, modify<div class=sourceCode id=cb25><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb25-1><a href=#cb25-1 aria-hidden=true tabindex=-1></a><span class=dt>int</span></span>
<span id=cb25-2><a href=#cb25-2 aria-hidden=true tabindex=-1></a>main<span class=op>(</span><span class=dt>void</span><span class=op>)</span></span>
<span id=cb25-3><a href=#cb25-3 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb25-4><a href=#cb25-4 aria-hidden=true tabindex=-1></a>    <span class=co>// some code here...</span></span>
<span id=cb25-5><a href=#cb25-5 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>to<div class=sourceCode id=cb26><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb26-1><a href=#cb26-1 aria-hidden=true tabindex=-1></a><span class=dt>int</span></span>
<span id=cb26-2><a href=#cb26-2 aria-hidden=true tabindex=-1></a>main<span class=op>(</span><span class=dt>int</span> argc<span class=op>,</span> <span class=dt>char</span><span class=op>*</span> argv<span class=op>[])</span></span>
<span id=cb26-3><a href=#cb26-3 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb26-4><a href=#cb26-4 aria-hidden=true tabindex=-1></a>    <span class=co>// some code here...    </span></span>
<span id=cb26-5><a href=#cb26-5 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><li><p>Now, it‚Äôs your turn to implement remaining features of executing shell scripts. We will describe in detail what you need to do in <strong>Requirements</strong> section.</ol></section><section id=requirements-3 class=level3><h3 class=anchored data-anchor-id=requirements-3>Requirements</h3><ul><li><p>In&nbsp;<code>main()</code>&nbsp;of&nbsp;<code>user/sh.c</code>, open&nbsp;<code>argv[1]</code>&nbsp;as input if <code>argc > 1</code>.<ul><li><p>If you don‚Äôt know how to open a file, looking around and investigate how other user programs achieve that.<li><p>When opening a non-existent file <em>(more precisely, if your program can‚Äôt open a file)</em>, please print <code>sh: cannot open xxx.sh</code>.<p><strong>Example Output</strong><div class=sourceCode id=cb27><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb27-1><a href=#cb27-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> sh asdfgh.sh</span>
<span id=cb27-2><a href=#cb27-2 aria-hidden=true tabindex=-1></a><span class=ex>sh:</span> cannot open asdfgh.sh</span>
<span id=cb27-3><a href=#cb27-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></ul><li><p>Read and parse each line as a shell command.<ul><li>xv6 already contains a lot of useful user libraries. If you don‚Äôt know how to read and parse texts line by line, looking around and investigate how other user programs achieve that.</ul><li><p>Execute them in the same logic as interactive input.<li><p>For the sake of simplicity, you don‚Äôt have to parse <code>$ ./script.sh</code> in this lab. It‚Äôs ok to get <code>exec ./script.sh failed</code> if you input <code>$ ./script.sh</code> only instead of <code>$ sh script.sh</code>.</ul><div class="callout callout-style-default callout-warning callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-10-contents aria-controls=callout-10 aria-expanded=false aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">Debugging for Windows: Why Every PID Output Increments by 1</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-10 class="callout-10-contents callout-collapse collapse"><div class="callout-body-container callout-body"><p>You might run into this problem if you are developing on <strong>Windows</strong>. This is because Windows handles line endings (newlines) differently. Please change every <code>.sh</code> file from <strong>CRLF</strong> mode to <strong>LF</strong> mode. If you are using VSCode, you can switch the file from CRLF to LF in the bottom-right corner of the editor.</div></div></div></section></section><section id=step-5-fork-bomb-script-1 class=level2><h2 class=anchored data-anchor-id=step-5-fork-bomb-script-1>Step 5: Fork Bomb Script</h2><p>Congratulations on completing all the features! With all the features you extend, we can finally do something crazy to xv6 now!<section id=prerequisites-1 class=level3><h3 class=anchored data-anchor-id=prerequisites-1>Prerequisites</h3><ul><li><p>In <code>kernel/param.h</code>, please change the value of <code>NOFILE</code> from <code>16</code> to <code>24</code>:<p>from<div class=sourceCode id=cb28><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb28-1><a href=#cb28-1 aria-hidden=true tabindex=-1></a><span class=pp>#define NOFILE       </span><span class=dv>16</span><span class=pp>  </span><span class=co>// open files per process</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>to<div class=sourceCode id=cb29><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb29-1><a href=#cb29-1 aria-hidden=true tabindex=-1></a><span class=pp>#define NOFILE       </span><span class=dv>24</span><span class=pp>  </span><span class=co>// open files per process</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><li><p>Create a file <code>user/dummy.c</code>:<div class=sourceCode id=cb30><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb30-1><a href=#cb30-1 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"kernel/types.h"</span></span>
<span id=cb30-2><a href=#cb30-2 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"user/user.h"</span></span>
<span id=cb30-3><a href=#cb30-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb30-4><a href=#cb30-4 aria-hidden=true tabindex=-1></a><span class=dt>int</span></span>
<span id=cb30-5><a href=#cb30-5 aria-hidden=true tabindex=-1></a>main<span class=op>(</span><span class=dt>int</span> argc<span class=op>,</span> <span class=dt>char</span><span class=op>*</span> argv<span class=op>[])</span></span>
<span id=cb30-6><a href=#cb30-6 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb30-7><a href=#cb30-7 aria-hidden=true tabindex=-1></a>    <span class=cf>while</span><span class=op>(</span><span class=dv>1</span><span class=op>);</span></span>
<span id=cb30-8><a href=#cb30-8 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><li><p>Copy and paste the following script into <code>user/bomb.sh</code>:<div class=sourceCode id=cb31><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb31-1><a href=#cb31-1 aria-hidden=true tabindex=-1></a><span class=ex>./dummy</span> <span class=kw>&amp;</span></span>
<span id=cb31-2><a href=#cb31-2 aria-hidden=true tabindex=-1></a><span class=ex>./dummy</span> <span class=kw>&amp;</span></span>
<span id=cb31-3><a href=#cb31-3 aria-hidden=true tabindex=-1></a><span class=fu>sh</span> /bomb.sh</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><li><p>Don‚Äôt forget to add new paths <code>$U/_dummy\</code> to <code>UPROGS</code> in <code>Makefile</code>.</ul></section><section id=lets-go class=level3><h3 class=anchored data-anchor-id=lets-go>üí£ Let‚Äôs Go‚Ä¶ üí£</h3><p>Run <code>$ sh bomb.sh</code> in your xv6 and see what happen.<p><img src=../images/angrybird.png class=img-fluid style=max-width:200px><p><strong>Think About It</strong>:<p>A fork bomb will drain all the CPU on an unprotected OS like xv6, but modern OS like Linux has protection to prevent bad program (like the fork bomb) from taking all the resources. What are the mechanisms in Linux that enforce this CPU resource management?<p><img src=../images/cat-bomb-2.png class=img-fluid style=max-width:240px;float:right;margin-left:30px></section></section><section id=run-grade-script class=level2><h2 class=anchored data-anchor-id=run-grade-script>Run grade script</h2><div class=sourceCode id=cb32><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb32-1><a href=#cb32-1 aria-hidden=true tabindex=-1></a><span class=ex>prompt</span><span class=op>&gt;</span> python3 grade-lab-forkbomb</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=demo class=level2><h2 class=anchored data-anchor-id=demo>Demo</h2><ol type=1><li><strong>‚ÄúThink About It‚Äù Questions:</strong> The <strong>‚ÄúThink About It‚Äù</strong> sections are for your own learning. They are interesting, but they will not be asked during the demo.<li><strong>Prepare Answers in Advance:</strong> The demo questions for this lab are more complex than the last one. We strongly recommend preparing your answers <em>before</em> your demo time to save everyone‚Äôs time.<li><strong>Have Your Code Ready:</strong> Before the demo starts, please open all the source code that will help you answer the questions. Close any files that are not needed. This will help you quickly find and show us your work when we ask.</ol><section id=questions-1-and-2 class=level4><h4 class=anchored data-anchor-id=questions-1-and-2>Questions 1 and 2</h4><p>In the <code>int wait_noblock()</code> implementation we provided in Step 1, there is this line:<div class=sourceCode id=cb33><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb33-1><a href=#cb33-1 aria-hidden=true tabindex=-1></a><span class=cf>if</span><span class=op>(</span>copyout<span class=op>(</span>p<span class=op>-&gt;</span>pagetable<span class=op>,</span> exit_status<span class=op>,</span> <span class=op>(</span><span class=dt>char</span> <span class=op>*)&amp;</span>pp<span class=op>-&gt;</span>xstate<span class=op>,</span> <span class=kw>sizeof</span><span class=op>(</span><span class=dt>int</span><span class=op>))</span> <span class=op>&lt;</span> <span class=dv>0</span><span class=op>)</span> </span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p><strong>The question is:</strong> Why must we use <code>copyout</code>? Why can‚Äôt we just use the <code>=</code> (equals) sign to assign the value of <code>xstate</code> to <code>exit_status</code>?<p><span class=red>1. Please answer this question from the perspective of <strong>Virtual Memory</strong>.</span><p><span class=red>2. Please answer this question from the perspective of <strong>Protection / Security</strong>.</span></section><section id=questions-3 class=level4><h4 class=anchored data-anchor-id=questions-3>Questions 3</h4><p>In the first example under <strong>Step 2: More Examples</strong>, we asked you to change the original xv6 behavior where running a background job creates <strong>TWO</strong> processes, so that it only creates <strong>ONE</strong> process now.<p><span class=red>3. Please briefly explain how you changed the control flow in <code>user/sh.c</code> to achieve this.</span></section><section id=questions-4 class=level4><h4 class=anchored data-anchor-id=questions-4>Questions 4</h4><p>In <strong>Step 3</strong>, we gave this specific hint:<blockquote class=blockquote><p>Is there any additional char at the tail of jobs strings when you type jobs and press ENTER in shell?</blockquote><p><span class=red>4. Please briefly explain why parsing the <code>jobs</code> command is slightly different from the <code>cd</code> command.</span></section></section></section><a onclick="return window.scrollTo(0,0),!1" role=button id=quarto-back-to-top><i class="bi bi-arrow-up"></i> Back to top</a></main><script id=quarto-html-after-body>window.document.addEventListener("DOMContentLoaded",function(){const j="Óßã",c=new window.AnchorJS;c.options={placement:"right",icon:j},c.add(".anchored");const v=e=>{for(const t of e.classList)if(t.startsWith("code-annotation-"))return!0;return!1},p=function(e){const t=e.trigger;t.blur(),t.classList.add("code-copy-button-checked");var s=t.getAttribute("title");t.setAttribute("title","Copied!");let n;window.bootstrap&&(t.setAttribute("data-bs-toggle","tooltip"),t.setAttribute("data-bs-placement","left"),t.setAttribute("data-bs-title","Copied!"),n=new bootstrap.Tooltip(t,{trigger:"manual",customClass:"code-copy-button-tooltip",offset:[0,-8]}),n.show()),setTimeout(function(){n&&(n.hide(),t.removeAttribute("data-bs-title"),t.removeAttribute("data-bs-toggle"),t.removeAttribute("data-bs-placement")),t.setAttribute("title",s),t.classList.remove("code-copy-button-checked")},1e3),e.clearSelection()},m=function(e){const t=e.previousElementSibling.cloneNode(!0);for(const e of t.children)v(e)&&e.remove();return t.innerText},b=new window.ClipboardJS(".code-copy-button:not([data-in-quarto-modal])",{text:m});if(b.on("success",p),window.document.getElementById("quarto-embedded-source-code-modal")){const e=new window.ClipboardJS(".code-copy-button[data-in-quarto-modal]",{text:m,container:window.document.getElementById("quarto-embedded-source-code-modal")});e.on("success",p)}for(var s,g=new RegExp(/^(?:http|https):\/\/localhost:?[0-9]*\//),x=new RegExp(/^mailto:/),O=new RegExp("/"+window.location.host+"/"),w=e=>O.test(e)||g.test(e)||x.test(e),u=window.document.querySelectorAll("a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)"),t=0;t<u.length;t++){const e=u[t];w(e.href)||(e.dataset.originalHref!==0[0]&&(e.href=e.dataset.originalHref),e.setAttribute("target","_blank"),e.getAttribute("rel")===null&&e.setAttribute("rel","noopener"),e.classList.add("external"))}function i(e,t,n,s){const o={allowHTML:!0,maxWidth:500,delay:100,arrow:!1,appendTo:function(e){return e.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"bottom-start"};t&&(o.content=t),n&&(o.onTrigger=n),s&&(o.onUntrigger=s),window.tippy(e,o)}const f=window.document.querySelectorAll('a[role="doc-noteref"]');for(t=0;t<f.length;t++){const e=f[t];i(e,function(){let t=e.getAttribute("data-footnote-href")||e.getAttribute("href");try{t=new URL(t).hash}catch{}const s=t.replace(/^#\/?/,""),n=window.document.getElementById(s);return n?n.innerHTML:""})}const r=window.document.querySelectorAll("a.quarto-xref"),o=(e,t)=>{const n=e=>{if(e.classList.remove("page-full","page-columns"),e.children)for(const t of e.children)n(t)};if(n(t),e===null||e.startsWith("sec-")){const e=document.createElement("div");if(t.children&&t.children.length>2){e.appendChild(t.children[0].cloneNode(!0));for(let n=1;n<t.children.length;n++){const s=t.children[n];if(s.tagName==="P"&&s.innerText==="")continue;e.appendChild(s.cloneNode(!0));break}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(e),e.innerHTML}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.innerHTML}else{const e=t.querySelector("a.anchorjs-link");return e&&e.remove(),window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.classList.contains("callout")?t.outerHTML:t.innerHTML}};for(t=0;t<r.length;t++){const e=r[t];i(e,0[0],function(t){t.disable();let n=e.getAttribute("href"),s=0[0];if(n.startsWith("#"))s=n;else try{s=new URL(n).hash}catch{}if(s){const e=s.replace(/^#\/?/,""),i=window.document.getElementById(e);if(i!==null)try{const n=o(e,i.cloneNode(!0));t.setContent(n)}finally{t.enable(),t.show()}else fetch(n.split("#")[0]).then(e=>e.text()).then(n=>{const i=new DOMParser,a=i.parseFromString(n,"text/html"),s=a.getElementById(e);if(s!==null){const n=o(e,s);t.setContent(n)}}).finally(()=>{t.enable(),t.show()})}else fetch(n).then(e=>e.text()).then(e=>{const s=new DOMParser,i=s.parseFromString(e,"text/html"),n=i.querySelector("main.content");if(n!==null){n.children.length>0&&n.children[0].tagName==="HEADER"&&n.children[0].remove();const e=o(null,n);t.setContent(e)}}).finally(()=>{t.enable(),t.show()})},function(){})}let n;const h=(e,t)=>{let n='data-code-cell="'+e+'"',s='data-code-annotation="'+t+'"';const o="span["+n+"]["+s+"]";return o},a=e=>{const d=window.document,i=e.getAttribute("data-target-cell"),r=e.getAttribute("data-target-annotation"),c=window.document.querySelector(h(i,r)),l=c.getAttribute("data-code-lines").split(","),t=l.map(e=>i+"-"+e);let s=null,o=null,a=null;if(t.length>0){const r=window.document.getElementById(t[0]);if(s=r.offsetTop,o=r.offsetHeight,a=r.parentElement.parentElement,t.length>1){const e=window.document.getElementById(t[t.length-1]),n=e.offsetTop+e.offsetHeight;o=n-s}if(s!==null&&o!==null&&a!==null){let e=window.document.getElementById("code-annotation-line-highlight");e===null&&(e=window.document.createElement("div"),e.setAttribute("id","code-annotation-line-highlight"),e.style.position="absolute",a.appendChild(e)),e.style.top=s-2+"px",e.style.height=o+4+"px",e.style.left=0;let t=window.document.getElementById("code-annotation-line-highlight-gutter");if(t===null){t=window.document.createElement("div"),t.setAttribute("id","code-annotation-line-highlight-gutter"),t.style.position="absolute";const e=window.document.getElementById(i),n=e.querySelector(".code-annotation-gutter");n.appendChild(t)}t.style.top=s-2+"px",t.style.height=o+4+"px"}n=e}},y=()=>{const e=["code-annotation-line-highlight","code-annotation-line-highlight-gutter"];e.forEach(e=>{const t=window.document.getElementById(e);t&&t.remove()}),n=0[0]};window.addEventListener("resize",_(()=>{elRect=0[0],n&&a(n)},10));function _(e,t){let s=!1,n;return(...o)=>{s?(n&&clearTimeout(n),n=setTimeout(()=>{e.apply(this,o),n=s=!1},t)):(e.apply(this,o),s=!0)}}const d=window.document.querySelectorAll(".code-annotation-anchor");for(let e=0;e<d.length;e++){const t=d[e],n=t.getAttribute("data-target-cell"),s=t.getAttribute("data-target-annotation"),o=()=>{const e=window.document.querySelector(h(n,s));if(e){const t=e.cloneNode(!0);return t.classList.add("code-annotation-tip-content"),t.outerHTML}},i={allowHTML:!0,content:o,onShow:e=>{a(e.reference),e.reference.classList.add("code-annotation-active"),window.tippy.hideAll()},onHide:e=>{y(),e.reference.classList.remove("code-annotation-active")},maxWidth:300,delay:[50,0],duration:[200,0],offset:[5,10],arrow:!0,appendTo:function(e){return e.parentElement.parentElement.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"right",popperOptions:{modifiers:[{name:"flip",options:{flipVariations:!1,allowedAutoPlacements:["right"],fallbackPlacements:["right","top","top-start","top-end","bottom","bottom-start","bottom-end","left"]}},{name:"preventOverflow",options:{mainAxis:!1,altAxis:!1}}]}};window.tippy(t,i)}const l=e=>{const t=e.parentElement;if(t){const n=t.dataset.cites;return n?{el:e,cites:n.split(" ")}:l(e.parentElement)}else return 0[0]};for(s=window.document.querySelectorAll('a[role="doc-biblioref"]'),t=0;t<s.length;t++){const n=s[t],e=l(n);e&&i(e.el,function(){var t=window.document.createElement("div");return e.cites.forEach(function(e){var s,n=window.document.createElement("div");n.classList.add("hanging-indent"),n.classList.add("csl-entry"),s=window.document.getElementById("ref-"+e),s&&(n.innerHTML=s.innerHTML),t.appendChild(n)}),t.innerHTML})}})</script></div><footer class=footer><div class=nav-footer><div class=nav-footer-left><p><img id=footer-cat-left src=../images/cat-left.png alt="Cat Left"></div><div class=nav-footer-center><p><span id=footer-center>Made with ‚ù§Ô∏è by Tony, (CC&nbsp;BY&nbsp;4.0)<br><span style=font-size:8px>Cat source: Freepik and ChatGPT</span></span></div><div class=nav-footer-right><p><img id=footer-cat-right src=../images/cat-right.png alt="Cat Right"></div></div></footer><script>videojs(video_shortcode_videojs_video1)</script><script>videojs(video_shortcode_videojs_video2)</script><script>videojs(video_shortcode_videojs_video3)</script><script>videojs(video_shortcode_videojs_video4)</script>
<!doctype html><html xmlns=http://www.w3.org/1999/xhtml lang=en xml:lang=en><meta charset=utf-8><meta name=generator content="quarto-1.7.33"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><title>xv6-syscall – Operating System (2025 Fall)</title><style>code{white-space:pre-wrap}span.smallcaps{font-variant:small-caps}div.columns{display:flex;gap:min(4vw,1.5em)}div.column{flex:auto;overflow-x:auto}div.hanging-indent{margin-left:1.5em;text-indent:-1.5em}ul.task-list{list-style:none}ul.task-list li input[type=checkbox]{width:.8em;margin:0 .8em .2em -1em;vertical-align:middle}html{-webkit-text-size-adjust:100%}pre>code.sourceCode{white-space:pre;position:relative}pre>code.sourceCode>span{display:inline-block;line-height:1.25}pre>code.sourceCode>span:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode>span{color:inherit;text-decoration:inherit}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{pre>code.sourceCode{white-space:pre-wrap}pre>code.sourceCode>span{text-indent:-5em;padding-left:5em}}pre.numberSource code{counter-reset:source-line 0}pre.numberSource code>span{position:relative;left:-4em;counter-increment:source-line}pre.numberSource code>span>a:first-child::before{content:counter(source-line);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em}pre.numberSource{margin-left:3em;padding-left:4px}div.sourceCode{}@media screen{pre>code.sourceCode>span>a:first-child::before{text-decoration:underline}}</style><script src=../site_libs/quarto-nav/quarto-nav.js></script><script src=../site_libs/clipboard/clipboard.min.js></script><script src=../site_libs/quarto-search/autocomplete.umd.js></script><script src=../site_libs/quarto-search/fuse.min.js></script><script src=../site_libs/quarto-search/quarto-search.js></script><meta name=quarto:offset content="../"><link href=../images/orange.png rel=icon type=image/png><script src=../site_libs/quarto-html/quarto.js type=module></script><script src=../site_libs/quarto-html/tabsets/tabsets.js type=module></script><script src=../site_libs/quarto-html/popper.min.js></script><script src=../site_libs/quarto-html/tippy.umd.min.js></script><script src=../site_libs/quarto-html/anchor.min.js></script><link href=../site_libs/quarto-html/tippy.css rel=stylesheet><link href=../site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css rel=stylesheet id=quarto-text-highlighting-styles><script src=../site_libs/bootstrap/bootstrap.min.js></script><link href=../site_libs/bootstrap/bootstrap-icons.css rel=stylesheet><link href=../site_libs/bootstrap/bootstrap-a3d6f4078ec9f2632a80ad631344d584.min.css rel=stylesheet append-hash=true id=quarto-bootstrap data-mode=light><script id=quarto-search-options type=application/json>{"location":"navbar","copy-button":false,"collapse-after":3,"panel-placement":"end","type":"overlay","limit":50,"keyboard-shortcut":["f","/","s"],"show-item-context":false,"language":{"search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search"}}</script><body class="nav-sidebar docked nav-fixed quarto-light"><div id=quarto-search-results></div><header id=quarto-header class="headroom fixed-top"><nav class="navbar navbar-expand-lg" data-bs-theme=dark><div class="navbar-container container-fluid"><div class="navbar-brand-container mx-auto"><a class=navbar-brand href=../index.html><span class=navbar-title>Operating System (2025 Fall)</span></a></div><div id=quarto-search title=Search></div><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarCollapse aria-controls=navbarCollapse role=menu aria-expanded=false aria-label="Toggle navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarCollapse><ul class="navbar-nav navbar-nav-scroll me-auto"><li class=nav-item><a class="nav-link active" href=../index.html aria-current=page><span class=menu-text>Home</span></a><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-handouts role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Handouts</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-handouts><li><a class=dropdown-item href=../handouts/env_setup.html><span class=dropdown-text>Environment Setup</span></a><li><a class=dropdown-item href=../handouts/unix.html><span class=dropdown-text>Unix</span></a><li><a class=dropdown-item href=../handouts/privilege.html><span class=dropdown-text>Privilege</span></a><li><a class=dropdown-item href=../handouts/scheduler.html><span class=dropdown-text>Scheduler</span></a><li><a class=dropdown-item href=../handouts/buffercache.html><span class=dropdown-text>Buffer Cache</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-labs role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Labs</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-labs><li><a class=dropdown-item href=../labs/mini-cloud.html><span class=dropdown-text>Mini Cloud</span></a><li><a class=dropdown-item href=../labs/linking.html><span class=dropdown-text>Linking</span></a><li><a class=dropdown-item href=../labs/process-creation.html><span class=dropdown-text>Process Creation</span></a><li><a class=dropdown-item href=../labs/process-state.html><span class=dropdown-text>Process State</span></a><li><a class=dropdown-item href=../labs/process-address-space.html><span class=dropdown-text>Process Address Space</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/path-traversal.html><span class=dropdown-text>Path Traversal</span></a><li><a class=dropdown-item href=../labs/pipe-passwords.html><span class=dropdown-text>Pipe Passwords</span></a><li><a class=dropdown-item href=../labs/pipe-dup.html><span class=dropdown-text>Pipe and dup()</span></a><li><a class=dropdown-item href=../labs/pipe-pingpong.html><span class=dropdown-text>Pipe Ping-Pong</span></a><li><a class=dropdown-item href=../labs/fifo.html><span class=dropdown-text>FIFO (named pipe)</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/cat.html><span class=dropdown-text>Cat</span></a><li><hr class=dropdown-divider><li><a class=dropdown-item href=../labs/xv6-syscall.html><span class=dropdown-text>xv6 System Call Tracing</span></a></ul><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=nav-menu-admin role=link data-bs-toggle=dropdown aria-expanded=false><span class=menu-text>Admin</span></a><ul class=dropdown-menu aria-labelledby=nav-menu-admin><li><a class=dropdown-item href=../admin/policies.html><span class=dropdown-text>Policies</span></a><li><a class=dropdown-item href=../admin/explore.html><span class=dropdown-text>Exploratory Projects</span></a><li><a class=dropdown-item href=../admin/waitbutwhy.html><span class=dropdown-text>SD1↓ (燒蛋一下)</span></a></ul></ul><ul class="navbar-nav navbar-nav-scroll ms-auto"><li class="nav-item compact"><a class=nav-link href="https://elearn.nthu.edu.tw/course/view.php?id=38873"><i class="bi bi-globe" role=img></i><span class=menu-text></span></a></ul></div><div class=quarto-navbar-tools></div></div></nav><nav class=quarto-secondary-nav><div class="container-fluid d-flex"><button type=button class="quarto-btn-toggle btn" data-bs-toggle=collapse role=button data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()>
<i class="bi bi-layout-text-sidebar-reverse"></i></button><nav class=quarto-page-breadcrumbs aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=../weeks/w9.html>Worksheet 9</a><li class=breadcrumb-item><a href=../labs/xv6-syscall.html>xv6 Syscall Tracing</a></ol></nav><a class=flex-grow-1 role=navigation data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item aria-controls=quarto-sidebar aria-expanded=false aria-label="Toggle sidebar navigation" onclick=window.quartoToggleHeadroom&&window.quartoToggleHeadroom()></a><button type=button class="btn quarto-search-button" aria-label=Search onclick=window.quartoOpenSearch()>
<i class="bi bi-search"></i></button></div></nav></header><div id=quarto-content class="quarto-container page-columns page-rows-contents page-layout-article page-navbar"><nav id=quarto-sidebar class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center"><div class=sidebar-search><div id=quarto-search title=Search></div></div></div><div class=sidebar-menu-container><ul class="list-unstyled mt-1"><li class=sidebar-item><div class=sidebar-item-container><a href=../index.html class="sidebar-item-text sidebar-link"><span class=menu-text>OS 2025 Fall</span></a></div><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w2.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 2</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-1 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-1 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/env_setup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Environment setup</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w3.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 3</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-2 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-2 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/unix.html class="sidebar-item-text sidebar-link"><span class=menu-text>Unix Philosophy</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/mini-cloud.html class="sidebar-item-text sidebar-link"><span class=menu-text>Your First Week in OS Journey</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-creation.html class="sidebar-item-text sidebar-link"><span class=menu-text><code>fork()</code>/<code>exec()</code></span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w4.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 4</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-3 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-3 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/privilege.html class="sidebar-item-text sidebar-link"><span class=menu-text>Privilege</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/path-traversal.html class="sidebar-item-text sidebar-link"><span class=menu-text>Lab: Path Traversal Attack</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-address-space.html class="sidebar-item-text sidebar-link"><span class=menu-text>Address Space Layout</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/linking.html class="sidebar-item-text sidebar-link"><span class=menu-text>Static vs Dynamic Linking</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w5.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 5</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-4 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-4 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-passwords.html class="sidebar-item-text sidebar-link"><span class=menu-text>Parallelizing Rainbow Table Lookup with Pipes</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-dup.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipes, Redirection, and File Descriptors</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/fifo.html class="sidebar-item-text sidebar-link"><span class=menu-text>FIFO (named pipe)</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w6.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 6</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-5 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-5 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/scheduler.html class="sidebar-item-text sidebar-link"><span class=menu-text>Schedulers</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/process-state.html class="sidebar-item-text sidebar-link"><span class=menu-text>Process States in Linux</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/pipe-pingpong.html class="sidebar-item-text sidebar-link"><span class=menu-text>Pipe Pingpong</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w8.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 8</span></a>
<a class="sidebar-item-toggle text-start collapsed" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-6 role=navigation aria-expanded=false aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-6 class="collapse list-unstyled sidebar-section depth1"><li class=sidebar-item><div class=sidebar-item-container><a href=../handouts/buffercache.html class="sidebar-item-text sidebar-link"><span class=menu-text>Caching and Buffering</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/cat.html class="sidebar-item-text sidebar-link"><span class=menu-text>How <code>cat</code> works?</span></a></div></ul><li class="sidebar-item sidebar-item-section"><div class=sidebar-item-container><a href=../weeks/w9.html class="sidebar-item-text sidebar-link"><span class=menu-text>Worksheet 9</span></a>
<a class="sidebar-item-toggle text-start" data-bs-toggle=collapse data-bs-target=#quarto-sidebar-section-7 role=navigation aria-expanded=true aria-label="Toggle section"><i class="bi bi-chevron-right ms-2"></i></a></div><ul id=quarto-sidebar-section-7 class="collapse list-unstyled sidebar-section depth1 show"><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-intro.html class="sidebar-item-text sidebar-link"><span class=menu-text>Introduction to xv6</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-gdb.html class="sidebar-item-text sidebar-link"><span class=menu-text>GNU Debugger Tutorial</span></a></div><li class=sidebar-item><div class=sidebar-item-container><a href=../labs/xv6-syscall.html class="sidebar-item-text sidebar-link active"><span class=menu-text>xv6 Syscall Tracing</span></a></div></ul></ul></div></nav><div id=quarto-sidebar-glass class=quarto-sidebar-collapse-item data-bs-toggle=collapse data-bs-target=.quarto-sidebar-collapse-item></div><div id=quarto-margin-sidebar class="sidebar margin-sidebar"><nav id=TOC role=doc-toc class=toc-active><h2 id=toc-title>On this page</h2><ul><li><a href=#xv6-syscall-tracing id=toc-xv6-syscall-tracing class="nav-link active" data-scroll-target=#xv6-syscall-tracing>xv6 Syscall Tracing</a><ul class=collapse><li><a href=#getting-started id=toc-getting-started class=nav-link data-scroll-target=#getting-started>Getting Started</a><li><a href=#warm-up-exercise-add-find-command id=toc-warm-up-exercise-add-find-command class=nav-link data-scroll-target=#warm-up-exercise-add-find-command>Warm-up exercise: Add <code>find</code> Command</a><ul class=collapse><li><a href=#expected-output-format id=toc-expected-output-format class=nav-link data-scroll-target=#expected-output-format>Expected Output Format</a><li><a href=#create-the-file id=toc-create-the-file class=nav-link data-scroll-target=#create-the-file>Create the file</a><li><a href=#modify-the-makefile id=toc-modify-the-makefile class=nav-link data-scroll-target=#modify-the-makefile>Modify the Makefile</a><li><a href=#testing id=toc-testing class=nav-link data-scroll-target=#testing>Testing</a></ul><li><a href=#main-lab-syscall-tracing id=toc-main-lab-syscall-tracing class=nav-link data-scroll-target=#main-lab-syscall-tracing>Main lab: Syscall tracing</a><ul class=collapse><li><a href=#step-1-add-process-tracing-state id=toc-step-1-add-process-tracing-state class=nav-link data-scroll-target=#step-1-add-process-tracing-state>Step 1: Add Process Tracing State</a><li><a href=#step-2-implement-find_proc_by_pid id=toc-step-2-implement-find_proc_by_pid class=nav-link data-scroll-target=#step-2-implement-find_proc_by_pid>Step 2: Implement <code>find_proc_by_pid()</code></a><li><a href=#step-3-implement-sys_trace-syscall id=toc-step-3-implement-sys_trace-syscall class=nav-link data-scroll-target=#step-3-implement-sys_trace-syscall>Step 3: Implement <code>sys_trace</code> syscall</a><li><a href=#step-4-modify-syscall.c id=toc-step-4-modify-syscall.c class=nav-link data-scroll-target=#step-4-modify-syscall.c>Step 4: Modify <code>syscall.c</code></a><li><a href=#step-5-create-a-user-program-strace id=toc-step-5-create-a-user-program-strace class=nav-link data-scroll-target=#step-5-create-a-user-program-strace>Step 5: Create a User Program <code>strace</code></a><li><a href=#the-interleaved-output-problem id=toc-the-interleaved-output-problem class=nav-link data-scroll-target=#the-interleaved-output-problem>The Interleaved Output Problem</a><li><a href=#how-to-fix-it id=toc-how-to-fix-it class=nav-link data-scroll-target=#how-to-fix-it>How to Fix It</a><li><a href=#testing-1 id=toc-testing-1 class=nav-link data-scroll-target=#testing-1>Testing</a><li><a href=#understanding-the-output id=toc-understanding-the-output class=nav-link data-scroll-target=#understanding-the-output>Understanding the Output</a><li><a href=#run-the-grading-script id=toc-run-the-grading-script class=nav-link data-scroll-target=#run-the-grading-script>Run the Grading Script</a></ul><li><a href=#final-reflection-demo id=toc-final-reflection-demo class=nav-link data-scroll-target=#final-reflection-demo>Final Reflection & Demo</a><ul class=collapse><li><a href=#during-demo-time id=toc-during-demo-time class=nav-link data-scroll-target=#during-demo-time>During Demo Time</a></ul></ul></ul></nav></div><main class=content id=quarto-document-content><header id=title-block-header class=quarto-title-block><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label=breadcrumb><ol class=breadcrumb><li class=breadcrumb-item><a href=../weeks/w9.html>Worksheet 9</a><li class=breadcrumb-item><a href=../labs/xv6-syscall.html>xv6 Syscall Tracing</a></ol></nav></header><section id=xv6-syscall-tracing class=level1><h1>xv6 Syscall Tracing</h1><p>In this lab, we will implement a simple <strong>strace</strong>-like syscall tracing on xv6 to understand what system calls are made by an user program.<p>This lab has two parts: We will start with a <strong>warm-up exercise</strong>: you will add the <code>find.c</code> user program into xv6.<p>After you are not cold, you can complete the lab by following three steps:<p><strong>Step 1:</strong> Add a new <code>trace</code> system call to mark a process for syscall tracing.<p><strong>Step 2:</strong> Extend the kernel system call dispatcher to log syscalls made by traced processes.<p><strong>Step 3:</strong> Write a simple user-space <code>strace</code> program that attaches to a child and observes its syscalls, similar to <code>strace</code> on Linux.<p>By the end of this lab, you will know how to …<ul><li>Implement new system calls in xv6<li>Understand process structure and the flow of dispatching a system call<li>Create a user program in xv6</ul><section id=getting-started class=level2><h2 class=anchored data-anchor-id=getting-started>Getting Started</h2><p>Please clone the starter code from Github:<p><a href=https://github.com/sys-nthu/xv6-lab-syscall-tracing><img src=../images/StarStruck_SkinTone1.png class=img-fluid style=max-width:100px alt="open in GitHub"></a>.</p><ul><li>How to use xv6: <a href=../labs/xv6-intro.html>Read me</a>.<li>How to use <code>gdb</code> to debug your code: <a href=../labs/xv6-gdb.html>Read me</a>.</ul></section><section id=warm-up-exercise-add-find-command class=level2><h2 class=anchored data-anchor-id=warm-up-exercise-add-find-command>Warm-up exercise: Add <code>find</code> Command</h2><p>Before starting the main lab, you will add a simple <code>find</code> command to get familiar with xv6 file operations (we provide you the code, you just copy paste it 😘😘). <code>find</code> command recursively searches for files matching a pattern:<div class=sourceCode id=cb1><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb1-1><a href=#cb1-1 aria-hidden=true tabindex=-1></a><span class=fu>find</span> <span class=pp>[</span><span class=ss>directory_name</span><span class=pp>]</span> <span class=pp>[</span><span class=ss>filename_pattern</span><span class=pp>]</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>The <code>find</code> command should:<ul><li><p>Recursively traverse all subdirectories under the given directory<li><p>Print the full path of all files whose names match the given pattern<li><p>Skip the <code>.</code> (current) and <code>..</code> (parent) directory entries<li><p>Handle nested directory structures correctly</ul><section id=expected-output-format class=level3><h3 class=anchored data-anchor-id=expected-output-format>Expected Output Format</h3><p>When you run these instruction:<div class=sourceCode id=cb2><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb2-1><a href=#cb2-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> echo <span class=op>&gt;</span> b</span>
<span id=cb2-2><a href=#cb2-2 aria-hidden=true tabindex=-1></a><span class=ex>$</span> mkdir a  </span>
<span id=cb2-3><a href=#cb2-3 aria-hidden=true tabindex=-1></a><span class=ex>$</span> echo <span class=op>&gt;</span> a/b</span>
<span id=cb2-4><a href=#cb2-4 aria-hidden=true tabindex=-1></a><span class=ex>$</span> mkdir a/aa</span>
<span id=cb2-5><a href=#cb2-5 aria-hidden=true tabindex=-1></a><span class=ex>$</span> echo <span class=op>&gt;</span> a/aa/b</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>and<div class=sourceCode id=cb3><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb3-1><a href=#cb3-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> find . b</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Your output will be:<div class=sourceCode id=cb4><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb4-1><a href=#cb4-1 aria-hidden=true tabindex=-1></a><span class=ex>./b</span></span>
<span id=cb4-2><a href=#cb4-2 aria-hidden=true tabindex=-1></a><span class=ex>./a/b</span></span>
<span id=cb4-3><a href=#cb4-3 aria-hidden=true tabindex=-1></a><span class=ex>./a/aa/b</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p><strong>If you have already run the above command, running it again will fail because the file has already been created.</strong><div class=sourceCode id=cb5><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb5-1><a href=#cb5-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> echo <span class=op>&gt;</span> b</span>
<span id=cb5-2><a href=#cb5-2 aria-hidden=true tabindex=-1></a><span class=ex>$</span> echo <span class=op>&gt;</span> b</span>
<span id=cb5-3><a href=#cb5-3 aria-hidden=true tabindex=-1></a><span class=bu>exec</span> echo failed</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=create-the-file class=level3><h3 class=anchored data-anchor-id=create-the-file>Create the file</h3><ul><li>Copy and paste the following code into <code>user/find.c</code>:</ul><div class=sourceCode id=cb6><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb6-1><a href=#cb6-1 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"kernel/types.h"</span></span>
<span id=cb6-2><a href=#cb6-2 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"kernel/stat.h"</span></span>
<span id=cb6-3><a href=#cb6-3 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"user/user.h"</span></span>
<span id=cb6-4><a href=#cb6-4 aria-hidden=true tabindex=-1></a><span class=pp>#include </span><span class=im>"kernel/fs.h"</span></span>
<span id=cb6-5><a href=#cb6-5 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-6><a href=#cb6-6 aria-hidden=true tabindex=-1></a><span class=dt>int</span> ismatch<span class=op>(</span><span class=dt>char</span><span class=op>*</span>s<span class=op>,</span><span class=dt>char</span><span class=op>*</span>p<span class=op>){</span></span>
<span id=cb6-7><a href=#cb6-7 aria-hidden=true tabindex=-1></a>  <span class=dt>int</span> advance <span class=op>=</span> <span class=dv>1</span> <span class=op>;</span><span class=co>//advance p</span></span>
<span id=cb6-8><a href=#cb6-8 aria-hidden=true tabindex=-1></a>  <span class=cf>if</span><span class=op>(*</span>p <span class=op>==</span> <span class=dv>0</span><span class=op>)</span></span>
<span id=cb6-9><a href=#cb6-9 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> <span class=op>*</span>s <span class=op>==</span> <span class=dv>0</span><span class=op>;</span></span>
<span id=cb6-10><a href=#cb6-10 aria-hidden=true tabindex=-1></a>  <span class=cf>if</span><span class=op>(*</span>p <span class=op>&amp;&amp;</span> <span class=op>*(</span>p<span class=op>+</span><span class=dv>1</span><span class=op>)</span> <span class=op>&amp;&amp;</span> <span class=op>*(</span>p<span class=op>+</span><span class=dv>1</span><span class=op>)==</span><span class=ch>'*'</span><span class=op>){</span></span>
<span id=cb6-11><a href=#cb6-11 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span><span class=op>(</span>ismatch<span class=op>(</span>s<span class=op>,</span>p<span class=op>+</span><span class=dv>2</span><span class=op>))</span></span>
<span id=cb6-12><a href=#cb6-12 aria-hidden=true tabindex=-1></a>      <span class=cf>return</span> <span class=dv>1</span><span class=op>;</span></span>
<span id=cb6-13><a href=#cb6-13 aria-hidden=true tabindex=-1></a>    advance <span class=op>=</span> <span class=dv>0</span><span class=op>;</span></span>
<span id=cb6-14><a href=#cb6-14 aria-hidden=true tabindex=-1></a>  <span class=op>}</span></span>
<span id=cb6-15><a href=#cb6-15 aria-hidden=true tabindex=-1></a>  <span class=cf>if</span><span class=op>((*</span>s<span class=op>&amp;&amp;*</span>p<span class=op>==</span><span class=ch>'.'</span><span class=op>)||*</span>s<span class=op>==*</span>p<span class=op>)</span></span>
<span id=cb6-16><a href=#cb6-16 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> ismatch<span class=op>(</span>s<span class=op>+</span><span class=dv>1</span><span class=op>,</span>p<span class=op>+</span>advance<span class=op>);</span></span>
<span id=cb6-17><a href=#cb6-17 aria-hidden=true tabindex=-1></a>  <span class=cf>return</span> <span class=dv>0</span><span class=op>;</span></span>
<span id=cb6-18><a href=#cb6-18 aria-hidden=true tabindex=-1></a><span class=op>}</span></span>
<span id=cb6-19><a href=#cb6-19 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-20><a href=#cb6-20 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-21><a href=#cb6-21 aria-hidden=true tabindex=-1></a><span class=dt>char</span> buf<span class=op>[</span><span class=dv>512</span><span class=op>];</span></span>
<span id=cb6-22><a href=#cb6-22 aria-hidden=true tabindex=-1></a><span class=dt>char</span><span class=op>*</span></span>
<span id=cb6-23><a href=#cb6-23 aria-hidden=true tabindex=-1></a>fmtname<span class=op>(</span><span class=dt>char</span> <span class=op>*</span>path<span class=op>)</span></span>
<span id=cb6-24><a href=#cb6-24 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb6-25><a href=#cb6-25 aria-hidden=true tabindex=-1></a>  <span class=dt>static</span> <span class=dt>char</span> buf<span class=op>[</span>DIRSIZ<span class=op>+</span><span class=dv>1</span><span class=op>];</span></span>
<span id=cb6-26><a href=#cb6-26 aria-hidden=true tabindex=-1></a>  <span class=dt>char</span> <span class=op>*</span>p<span class=op>;</span></span>
<span id=cb6-27><a href=#cb6-27 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-28><a href=#cb6-28 aria-hidden=true tabindex=-1></a>  <span class=co>// Find first character after last slash.</span></span>
<span id=cb6-29><a href=#cb6-29 aria-hidden=true tabindex=-1></a>  <span class=cf>for</span><span class=op>(</span>p<span class=op>=</span>path<span class=op>+</span>strlen<span class=op>(</span>path<span class=op>);</span> p <span class=op>&gt;=</span> path <span class=op>&amp;&amp;</span> <span class=op>*</span>p <span class=op>!=</span> <span class=ch>'/'</span><span class=op>;</span> p<span class=op>--)</span></span>
<span id=cb6-30><a href=#cb6-30 aria-hidden=true tabindex=-1></a>    <span class=op>;</span></span>
<span id=cb6-31><a href=#cb6-31 aria-hidden=true tabindex=-1></a>  p<span class=op>++;</span></span>
<span id=cb6-32><a href=#cb6-32 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-33><a href=#cb6-33 aria-hidden=true tabindex=-1></a>  <span class=co>// Return blank-padded name.</span></span>
<span id=cb6-34><a href=#cb6-34 aria-hidden=true tabindex=-1></a>  <span class=cf>if</span><span class=op>(</span>strlen<span class=op>(</span>p<span class=op>)</span> <span class=op>&gt;=</span> DIRSIZ<span class=op>)</span></span>
<span id=cb6-35><a href=#cb6-35 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span> p<span class=op>;</span></span>
<span id=cb6-36><a href=#cb6-36 aria-hidden=true tabindex=-1></a>  memmove<span class=op>(</span>buf<span class=op>,</span> p<span class=op>,</span> strlen<span class=op>(</span>p<span class=op>));</span></span>
<span id=cb6-37><a href=#cb6-37 aria-hidden=true tabindex=-1></a>  memset<span class=op>(</span>buf<span class=op>+</span>strlen<span class=op>(</span>p<span class=op>),</span> <span class=ch>'</span><span class=sc>\0</span><span class=ch>'</span><span class=op>,</span> DIRSIZ<span class=op>-</span>strlen<span class=op>(</span>p<span class=op>));</span></span>
<span id=cb6-38><a href=#cb6-38 aria-hidden=true tabindex=-1></a>  <span class=cf>return</span> buf<span class=op>;</span></span>
<span id=cb6-39><a href=#cb6-39 aria-hidden=true tabindex=-1></a><span class=op>}</span></span>
<span id=cb6-40><a href=#cb6-40 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-41><a href=#cb6-41 aria-hidden=true tabindex=-1></a><span class=dt>void</span></span>
<span id=cb6-42><a href=#cb6-42 aria-hidden=true tabindex=-1></a>find<span class=op>(</span><span class=dt>char</span> <span class=op>*</span>path<span class=op>,</span><span class=dt>char</span><span class=op>*</span>name<span class=op>)</span></span>
<span id=cb6-43><a href=#cb6-43 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb6-44><a href=#cb6-44 aria-hidden=true tabindex=-1></a>  <span class=dt>char</span> <span class=op>*</span>p<span class=op>;</span></span>
<span id=cb6-45><a href=#cb6-45 aria-hidden=true tabindex=-1></a>  <span class=dt>int</span> fd<span class=op>;</span></span>
<span id=cb6-46><a href=#cb6-46 aria-hidden=true tabindex=-1></a>  <span class=kw>struct</span> dirent de<span class=op>;</span></span>
<span id=cb6-47><a href=#cb6-47 aria-hidden=true tabindex=-1></a>  <span class=kw>struct</span> stat st<span class=op>;</span></span>
<span id=cb6-48><a href=#cb6-48 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-49><a href=#cb6-49 aria-hidden=true tabindex=-1></a>  <span class=cf>if</span><span class=op>((</span>fd <span class=op>=</span> open<span class=op>(</span>path<span class=op>,</span> <span class=dv>0</span><span class=op>))</span> <span class=op>&lt;</span> <span class=dv>0</span><span class=op>){</span></span>
<span id=cb6-50><a href=#cb6-50 aria-hidden=true tabindex=-1></a>    fprintf<span class=op>(</span><span class=dv>2</span><span class=op>,</span> <span class=st>"ls: cannot open </span><span class=sc>%s\n</span><span class=st>"</span><span class=op>,</span> path<span class=op>);</span></span>
<span id=cb6-51><a href=#cb6-51 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span><span class=op>;</span></span>
<span id=cb6-52><a href=#cb6-52 aria-hidden=true tabindex=-1></a>  <span class=op>}</span></span>
<span id=cb6-53><a href=#cb6-53 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-54><a href=#cb6-54 aria-hidden=true tabindex=-1></a>  <span class=cf>if</span><span class=op>(</span>fstat<span class=op>(</span>fd<span class=op>,</span> <span class=op>&amp;</span>st<span class=op>)</span> <span class=op>&lt;</span> <span class=dv>0</span><span class=op>){</span></span>
<span id=cb6-55><a href=#cb6-55 aria-hidden=true tabindex=-1></a>    fprintf<span class=op>(</span><span class=dv>2</span><span class=op>,</span> <span class=st>"ls: cannot stat </span><span class=sc>%s\n</span><span class=st>"</span><span class=op>,</span> path<span class=op>);</span></span>
<span id=cb6-56><a href=#cb6-56 aria-hidden=true tabindex=-1></a>    close<span class=op>(</span>fd<span class=op>);</span></span>
<span id=cb6-57><a href=#cb6-57 aria-hidden=true tabindex=-1></a>    <span class=cf>return</span><span class=op>;</span></span>
<span id=cb6-58><a href=#cb6-58 aria-hidden=true tabindex=-1></a>  <span class=op>}</span></span>
<span id=cb6-59><a href=#cb6-59 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-60><a href=#cb6-60 aria-hidden=true tabindex=-1></a>  <span class=cf>switch</span><span class=op>(</span>st<span class=op>.</span>type<span class=op>){</span></span>
<span id=cb6-61><a href=#cb6-61 aria-hidden=true tabindex=-1></a>  <span class=cf>case</span> T_FILE<span class=op>:</span></span>
<span id=cb6-62><a href=#cb6-62 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span><span class=op>(</span>ismatch<span class=op>(</span>fmtname<span class=op>(</span>path<span class=op>),</span>name<span class=op>)!=</span><span class=dv>0</span><span class=op>){</span></span>
<span id=cb6-63><a href=#cb6-63 aria-hidden=true tabindex=-1></a>        printf<span class=op>(</span><span class=st>"</span><span class=sc>%s\n</span><span class=st>"</span><span class=op>,</span>path<span class=op>);</span></span>
<span id=cb6-64><a href=#cb6-64 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb6-65><a href=#cb6-65 aria-hidden=true tabindex=-1></a>    <span class=cf>break</span><span class=op>;</span></span>
<span id=cb6-66><a href=#cb6-66 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-67><a href=#cb6-67 aria-hidden=true tabindex=-1></a>  <span class=cf>case</span> T_DIR<span class=op>:</span></span>
<span id=cb6-68><a href=#cb6-68 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span><span class=op>(</span>strlen<span class=op>(</span>path<span class=op>)</span> <span class=op>+</span> <span class=dv>1</span> <span class=op>+</span> DIRSIZ <span class=op>+</span> <span class=dv>1</span> <span class=op>&gt;</span> <span class=kw>sizeof</span> buf<span class=op>){</span></span>
<span id=cb6-69><a href=#cb6-69 aria-hidden=true tabindex=-1></a>      printf<span class=op>(</span><span class=st>"ls: path too long</span><span class=sc>\n</span><span class=st>"</span><span class=op>);</span></span>
<span id=cb6-70><a href=#cb6-70 aria-hidden=true tabindex=-1></a>      <span class=cf>break</span><span class=op>;</span></span>
<span id=cb6-71><a href=#cb6-71 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb6-72><a href=#cb6-72 aria-hidden=true tabindex=-1></a>    strcpy<span class=op>(</span>buf<span class=op>,</span> path<span class=op>);</span></span>
<span id=cb6-73><a href=#cb6-73 aria-hidden=true tabindex=-1></a>    p <span class=op>=</span> buf<span class=op>+</span>strlen<span class=op>(</span>buf<span class=op>);</span></span>
<span id=cb6-74><a href=#cb6-74 aria-hidden=true tabindex=-1></a>    <span class=op>*</span>p<span class=op>++</span> <span class=op>=</span> <span class=ch>'/'</span><span class=op>;</span></span>
<span id=cb6-75><a href=#cb6-75 aria-hidden=true tabindex=-1></a>    <span class=cf>while</span><span class=op>(</span>read<span class=op>(</span>fd<span class=op>,</span> <span class=op>&amp;</span>de<span class=op>,</span> <span class=kw>sizeof</span><span class=op>(</span>de<span class=op>))</span> <span class=op>==</span> <span class=kw>sizeof</span><span class=op>(</span>de<span class=op>)){</span></span>
<span id=cb6-76><a href=#cb6-76 aria-hidden=true tabindex=-1></a>      <span class=cf>if</span><span class=op>(</span>de<span class=op>.</span>inum <span class=op>==</span> <span class=dv>0</span> <span class=op>||</span> strcmp<span class=op>(</span>de<span class=op>.</span>name<span class=op>,</span><span class=st>"."</span><span class=op>)==</span><span class=dv>0</span> <span class=op>||</span> strcmp<span class=op>(</span>de<span class=op>.</span>name<span class=op>,</span><span class=st>".."</span><span class=op>)==</span><span class=dv>0</span><span class=op>)</span></span>
<span id=cb6-77><a href=#cb6-77 aria-hidden=true tabindex=-1></a>        <span class=cf>continue</span><span class=op>;</span></span>
<span id=cb6-78><a href=#cb6-78 aria-hidden=true tabindex=-1></a>      memmove<span class=op>(</span>p<span class=op>,</span> de<span class=op>.</span>name<span class=op>,</span> DIRSIZ<span class=op>);</span></span>
<span id=cb6-79><a href=#cb6-79 aria-hidden=true tabindex=-1></a>      p<span class=op>[</span>DIRSIZ<span class=op>]</span> <span class=op>=</span> <span class=dv>0</span><span class=op>;</span></span>
<span id=cb6-80><a href=#cb6-80 aria-hidden=true tabindex=-1></a>      find<span class=op>(</span>buf<span class=op>,</span>name<span class=op>);</span></span>
<span id=cb6-81><a href=#cb6-81 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb6-82><a href=#cb6-82 aria-hidden=true tabindex=-1></a>    <span class=cf>break</span><span class=op>;</span></span>
<span id=cb6-83><a href=#cb6-83 aria-hidden=true tabindex=-1></a>  <span class=op>}</span></span>
<span id=cb6-84><a href=#cb6-84 aria-hidden=true tabindex=-1></a>  close<span class=op>(</span>fd<span class=op>);</span></span>
<span id=cb6-85><a href=#cb6-85 aria-hidden=true tabindex=-1></a><span class=op>}</span></span>
<span id=cb6-86><a href=#cb6-86 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-87><a href=#cb6-87 aria-hidden=true tabindex=-1></a><span class=dt>int</span></span>
<span id=cb6-88><a href=#cb6-88 aria-hidden=true tabindex=-1></a>main<span class=op>(</span><span class=dt>int</span> argc<span class=op>,</span> <span class=dt>char</span> <span class=op>*</span>argv<span class=op>[])</span></span>
<span id=cb6-89><a href=#cb6-89 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb6-90><a href=#cb6-90 aria-hidden=true tabindex=-1></a>  find<span class=op>(</span>argv<span class=op>[</span><span class=dv>1</span><span class=op>],</span>argv<span class=op>[</span><span class=dv>2</span><span class=op>]);</span></span>
<span id=cb6-91><a href=#cb6-91 aria-hidden=true tabindex=-1></a></span>
<span id=cb6-92><a href=#cb6-92 aria-hidden=true tabindex=-1></a>  exit<span class=op>(</span><span class=dv>0</span><span class=op>);</span></span>
<span id=cb6-93><a href=#cb6-93 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=modify-the-makefile class=level3><h3 class=anchored data-anchor-id=modify-the-makefile>Modify the Makefile</h3><p>Add <code>find</code> to the <code>UPROGS</code> list in the <code>Makefile</code>.</section><section id=testing class=level3><h3 class=anchored data-anchor-id=testing>Testing</h3><p>If you complete all the steps, run the grading script to see if the behavior of <code>find</code> meets the testing data.<div class=sourceCode id=cb7><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb7-1><a href=#cb7-1 aria-hidden=true tabindex=-1></a><span class=ex>python3</span> grade-find.py</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section></section><section id=main-lab-syscall-tracing class=level2><h2 class=anchored data-anchor-id=main-lab-syscall-tracing>Main lab: Syscall tracing</h2><p>Once you complete the warm-up exercise and pass the tests, we can start the main lab: syscall tracing.<section id=step-1-add-process-tracing-state class=level3><h3 class=anchored data-anchor-id=step-1-add-process-tracing-state>Step 1: Add Process Tracing State</h3><p>Add tracing functionality to the process structure.<p><strong>How?</strong>: Try to add a tracing flag <code>traced</code> to the process structure in <code>kernel/proc.h</code>.</section><section id=step-2-implement-find_proc_by_pid class=level3><h3 class=anchored data-anchor-id=step-2-implement-find_proc_by_pid>Step 2: Implement <code>find_proc_by_pid()</code></h3><p>Implement <code>find_proc_by_pid()</code> to find a process by PID.<section id=modify-the-file class=level4><h4 class=anchored data-anchor-id=modify-the-file>Modify the file</h4><ul><li><p><code>kernel/proc.c</code>: Please implement <code>find_proc_by_pid()</code><li><p><code>kernel/defs.h</code>: Add the prototypes for <code>find_proc_by_pid()</code></ul><p>this function will:<ul><li>Take PID as parameter<li>Search through the process table<li>Return a pointer to the matching process if found; otherwise, return NULL.<li>Handle the case where PID is invalid or process doesn’t exist</ul></section><section id=pseudo-code class=level4><h4 class=anchored data-anchor-id=pseudo-code>Pseudo Code</h4><div class=sourceCode id=cb8><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb8-1><a href=#cb8-1 aria-hidden=true tabindex=-1></a><span class=kw>struct</span> proc<span class=op>*</span> now_proc<span class=op>;</span></span>
<span id=cb8-2><a href=#cb8-2 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-3><a href=#cb8-3 aria-hidden=true tabindex=-1></a><span class=co>// Search through the process table</span></span>
<span id=cb8-4><a href=#cb8-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-5><a href=#cb8-5 aria-hidden=true tabindex=-1></a>  <span class=co>// if the matching process is found</span></span>
<span id=cb8-6><a href=#cb8-6 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-7><a href=#cb8-7 aria-hidden=true tabindex=-1></a>  <span class=co>// return pointer to the matching process</span></span>
<span id=cb8-8><a href=#cb8-8 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-9><a href=#cb8-9 aria-hidden=true tabindex=-1></a></span>
<span id=cb8-10><a href=#cb8-10 aria-hidden=true tabindex=-1></a><span class=co>// the matching process is not found</span></span>
<span id=cb8-11><a href=#cb8-11 aria-hidden=true tabindex=-1></a><span class=cf>return</span> NULL<span class=op>;</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section></section><section id=step-3-implement-sys_trace-syscall class=level3><h3 class=anchored data-anchor-id=step-3-implement-sys_trace-syscall>Step 3: Implement <code>sys_trace</code> syscall</h3><p>Add a new system call that allows us to trace a specific process (Learn how to add a new system call <a href=labs/xv6-intro.html##how-to-add-a-new-system-call>here</a><section id=implement-sys_trace class=level4><h4 class=anchored data-anchor-id=implement-sys_trace>Implement <code>sys_trace()</code></h4><p>this function will:<ul><li>Accept one integer argument (PID)<li>Find the process with that PID using <code>find_proc_by_pid()</code><li>Set the tracing flag for matching process<li>Return 0 on success, -1 on failure (if process not found)</ul></section><section id=pseudo-code-1 class=level4><h4 class=anchored data-anchor-id=pseudo-code-1>Pseudo Code</h4><div class=sourceCode id=cb9><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb9-1><a href=#cb9-1 aria-hidden=true tabindex=-1></a></span>
<span id=cb9-2><a href=#cb9-2 aria-hidden=true tabindex=-1></a><span class=dt>int</span> pid<span class=op>;</span></span>
<span id=cb9-3><a href=#cb9-3 aria-hidden=true tabindex=-1></a><span class=co>// Accept argument (PID)</span></span>
<span id=cb9-4><a href=#cb9-4 aria-hidden=true tabindex=-1></a></span>
<span id=cb9-5><a href=#cb9-5 aria-hidden=true tabindex=-1></a><span class=kw>struct</span> proc <span class=op>*</span>p <span class=op>=</span> find_proc_by_pid<span class=op>(</span>pid<span class=op>);</span> <span class=co>// implement this function</span></span>
<span id=cb9-6><a href=#cb9-6 aria-hidden=true tabindex=-1></a><span class=cf>if</span> <span class=op>(</span>p <span class=op>!=</span> NULL<span class=op>){</span></span>
<span id=cb9-7><a href=#cb9-7 aria-hidden=true tabindex=-1></a>  <span class=co>// The process with the specified PID exists</span></span>
<span id=cb9-8><a href=#cb9-8 aria-hidden=true tabindex=-1></a><span class=op>}</span></span>
<span id=cb9-9><a href=#cb9-9 aria-hidden=true tabindex=-1></a><span class=cf>else</span><span class=op>{</span></span>
<span id=cb9-10><a href=#cb9-10 aria-hidden=true tabindex=-1></a>  <span class=co>// No such process</span></span>
<span id=cb9-11><a href=#cb9-11 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>What would happen if the tracing flag is not set for the matching process?</section><section id=modify-the-file-1 class=level4><h4 class=anchored data-anchor-id=modify-the-file-1>Modify the file</h4><ul><li><code>kernel/sysproc.c</code>: Implement <code>sys_trace()</code><li><code>kernel/syscall.h</code>: Add syscall number definition<li><code>kernel/syscall.c</code>: Register the syscall<li><code>user/user.h</code>: Add user-space declaration<li><code>user/usys.pl</code>: Add system call stub</ul></section></section><section id=step-4-modify-syscall.c class=level3><h3 class=anchored data-anchor-id=step-4-modify-syscall.c>Step 4: Modify <code>syscall.c</code></h3><p>Modify the syscall dispatcher to log traced system calls.<section id=modify-the-file-2 class=level4><h4 class=anchored data-anchor-id=modify-the-file-2>Modify the file</h4><ul><li><code>kernel/syscall.c</code>:</ul><ol type=1><li>Define the <strong>syscall name table</strong></ol><p>At the top of <strong>syscall.c</strong>, Create a static array mapping syscall numbers to name strings<div class=sourceCode id=cb10><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb10-1><a href=#cb10-1 aria-hidden=true tabindex=-1></a><span class=dt>static</span> <span class=dt>char</span> <span class=op>*</span>syscall_names<span class=op>[]</span> <span class=op>=</span> <span class=op>{</span></span>
<span id=cb10-2><a href=#cb10-2 aria-hidden=true tabindex=-1></a><span class=op>[</span>SYS_fork<span class=op>]</span>    <span class=st>"fork"</span><span class=op>,</span></span>
<span id=cb10-3><a href=#cb10-3 aria-hidden=true tabindex=-1></a><span class=op>[</span>SYS_exit<span class=op>]</span>    <span class=st>"exit"</span><span class=op>,</span></span>
<span id=cb10-4><a href=#cb10-4 aria-hidden=true tabindex=-1></a><span class=op>[</span>SYS_wait<span class=op>]</span>    <span class=st>"wait"</span><span class=op>,</span></span>
<span id=cb10-5><a href=#cb10-5 aria-hidden=true tabindex=-1></a><span class=op>[</span>SYS_pipe<span class=op>]</span>    <span class=st>"pipe"</span><span class=op>,</span></span>
<span id=cb10-6><a href=#cb10-6 aria-hidden=true tabindex=-1></a><span class=co>// ... Complete me</span></span>
<span id=cb10-7><a href=#cb10-7 aria-hidden=true tabindex=-1></a><span class=op>};</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><ol start=2 type=1><li>Add syscall argument printing in <strong>syscall()</strong></ol><section id=expected-output-format-1 class=level5><h5 class=anchored data-anchor-id=expected-output-format-1>Expected Output Format</h5><p>For each traced syscall, we print:<div class=sourceCode id=cb11><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb11-1><a href=#cb11-1 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> X] syscall_name<span class=er>(</span><span class=ex>first_argument</span><span class=kw>)</span> <span class=ex>=</span> return_value</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=argument-printing-rules class=level5><h5 class=anchored data-anchor-id=argument-printing-rules>Argument Printing Rules</h5><ul><li>String arguments (for <code>open</code>, <code>chdir</code>, <code>mkdir</code>, <code>unlink</code>, <code>link</code>): Print as “string”<li>Exec syscall: Print the program name from <code>argv[0]</code> as “program” (When we run <code>ls</code>, the output should be <strong>exec(“ls”)</strong>)<li>All other syscalls: Print first argument as integer<li>Invalid pointers: Print “&lt;bad ptr>”</ul></section><section id=pseudo-code-2 class=level5><h5 class=anchored data-anchor-id=pseudo-code-2>Pseudo Code</h5><div class=sourceCode id=cb12><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id=cb12-1><a href=#cb12-1 aria-hidden=true tabindex=-1></a><span class=dt>void</span> syscall<span class=op>(</span><span class=dt>void</span><span class=op>)</span></span>
<span id=cb12-2><a href=#cb12-2 aria-hidden=true tabindex=-1></a><span class=op>{</span></span>
<span id=cb12-3><a href=#cb12-3 aria-hidden=true tabindex=-1></a></span>
<span id=cb12-4><a href=#cb12-4 aria-hidden=true tabindex=-1></a>  <span class=dt>int</span> num<span class=op>;</span></span>
<span id=cb12-5><a href=#cb12-5 aria-hidden=true tabindex=-1></a>  <span class=kw>struct</span> proc <span class=op>*</span>p <span class=op>=</span> myproc<span class=op>();</span></span>
<span id=cb12-6><a href=#cb12-6 aria-hidden=true tabindex=-1></a>  num <span class=op>=</span> p<span class=op>-&gt;</span>trapframe<span class=op>-&gt;</span>a7<span class=op>;</span></span>
<span id=cb12-7><a href=#cb12-7 aria-hidden=true tabindex=-1></a>  <span class=cf>if</span> <span class=op>(</span>num <span class=op>&gt;</span> <span class=dv>0</span> <span class=op>&amp;&amp;</span> num <span class=op>&lt;</span> NELEM<span class=op>(</span>syscalls<span class=op>)</span> <span class=op>&amp;&amp;</span> syscalls<span class=op>[</span>num<span class=op>])</span></span>
<span id=cb12-8><a href=#cb12-8 aria-hidden=true tabindex=-1></a>  <span class=op>{</span></span>
<span id=cb12-9><a href=#cb12-9 aria-hidden=true tabindex=-1></a></span>
<span id=cb12-10><a href=#cb12-10 aria-hidden=true tabindex=-1></a>    </span>
<span id=cb12-11><a href=#cb12-11 aria-hidden=true tabindex=-1></a>    uint64 arg0 <span class=op>=</span> p<span class=op>-&gt;</span>trapframe<span class=op>-&gt;</span>a0<span class=op>;</span> <span class=co>// Save first argument BEFORE syscall dispatch</span></span>
<span id=cb12-12><a href=#cb12-12 aria-hidden=true tabindex=-1></a></span>
<span id=cb12-13><a href=#cb12-13 aria-hidden=true tabindex=-1></a>    p<span class=op>-&gt;</span>trapframe<span class=op>-&gt;</span>a0 <span class=op>=</span> syscalls<span class=op>[</span>num<span class=op>]();</span> <span class=co>// Use num to lookup the system call function for num, call it, and store its return value in p-&gt;trapframe-&gt;a0</span></span>
<span id=cb12-14><a href=#cb12-14 aria-hidden=true tabindex=-1></a></span>
<span id=cb12-15><a href=#cb12-15 aria-hidden=true tabindex=-1></a></span>
<span id=cb12-16><a href=#cb12-16 aria-hidden=true tabindex=-1></a>    <span class=cf>if</span> <span class=op>(</span>p<span class=op>-&gt;</span>traced<span class=op>)</span></span>
<span id=cb12-17><a href=#cb12-17 aria-hidden=true tabindex=-1></a>    <span class=op>{</span></span>
<span id=cb12-18><a href=#cb12-18 aria-hidden=true tabindex=-1></a></span>
<span id=cb12-19><a href=#cb12-19 aria-hidden=true tabindex=-1></a>      <span class=co>// Print syscall name, first argument</span></span>
<span id=cb12-20><a href=#cb12-20 aria-hidden=true tabindex=-1></a></span>
<span id=cb12-21><a href=#cb12-21 aria-hidden=true tabindex=-1></a>      <span class=cf>if</span> <span class=op>(</span>num <span class=op>==</span> SYS_open <span class=op>||</span> num <span class=op>==</span> SYS_unlink <span class=op>||</span>  </span>
<span id=cb12-22><a href=#cb12-22 aria-hidden=true tabindex=-1></a>          num <span class=op>==</span> SYS_chdir <span class=op>||</span> num <span class=op>==</span> SYS_mkdir <span class=op>||</span> num <span class=op>==</span> SYS_link</span>
<span id=cb12-23><a href=#cb12-23 aria-hidden=true tabindex=-1></a>          <span class=co>/* ignore the second string argument of `link` */</span><span class=op>)</span></span>
<span id=cb12-24><a href=#cb12-24 aria-hidden=true tabindex=-1></a>      <span class=op>{</span></span>
<span id=cb12-25><a href=#cb12-25 aria-hidden=true tabindex=-1></a>         <span class=co>// If the syscall is one of these five...  </span></span>
<span id=cb12-26><a href=#cb12-26 aria-hidden=true tabindex=-1></a>      <span class=op>}</span></span>
<span id=cb12-27><a href=#cb12-27 aria-hidden=true tabindex=-1></a>      <span class=cf>else</span> <span class=cf>if</span> <span class=op>(</span> num <span class=op>==</span> SYS_exec <span class=op>){</span></span>
<span id=cb12-28><a href=#cb12-28 aria-hidden=true tabindex=-1></a>         <span class=co>// If the syscall is exec... </span></span>
<span id=cb12-29><a href=#cb12-29 aria-hidden=true tabindex=-1></a>      <span class=op>}</span></span>
<span id=cb12-30><a href=#cb12-30 aria-hidden=true tabindex=-1></a>      <span class=cf>else</span></span>
<span id=cb12-31><a href=#cb12-31 aria-hidden=true tabindex=-1></a>      <span class=op>{</span></span>
<span id=cb12-32><a href=#cb12-32 aria-hidden=true tabindex=-1></a>         <span class=co>// If the syscall is any of the others...</span></span>
<span id=cb12-33><a href=#cb12-33 aria-hidden=true tabindex=-1></a>      <span class=op>}</span></span>
<span id=cb12-34><a href=#cb12-34 aria-hidden=true tabindex=-1></a></span>
<span id=cb12-35><a href=#cb12-35 aria-hidden=true tabindex=-1></a>      <span class=co>// Print the remaining part.</span></span>
<span id=cb12-36><a href=#cb12-36 aria-hidden=true tabindex=-1></a>    <span class=op>}</span></span>
<span id=cb12-37><a href=#cb12-37 aria-hidden=true tabindex=-1></a>  <span class=op>}</span></span>
<span id=cb12-38><a href=#cb12-38 aria-hidden=true tabindex=-1></a>  <span class=cf>else</span></span>
<span id=cb12-39><a href=#cb12-39 aria-hidden=true tabindex=-1></a>  <span class=op>{</span></span>
<span id=cb12-40><a href=#cb12-40 aria-hidden=true tabindex=-1></a>    printf<span class=op>(</span><span class=st>"</span><span class=sc>%d</span><span class=st> </span><span class=sc>%s</span><span class=st>: unknown sys call </span><span class=sc>%d\n</span><span class=st>"</span><span class=op>,</span></span>
<span id=cb12-41><a href=#cb12-41 aria-hidden=true tabindex=-1></a>           p<span class=op>-&gt;</span>pid<span class=op>,</span> p<span class=op>-&gt;</span>name<span class=op>,</span> num<span class=op>);</span></span>
<span id=cb12-42><a href=#cb12-42 aria-hidden=true tabindex=-1></a>    p<span class=op>-&gt;</span>trapframe<span class=op>-&gt;</span>a0 <span class=op>=</span> <span class=op>-</span><span class=dv>1</span><span class=op>;</span></span>
<span id=cb12-43><a href=#cb12-43 aria-hidden=true tabindex=-1></a>  <span class=op>}</span></span>
<span id=cb12-44><a href=#cb12-44 aria-hidden=true tabindex=-1></a><span class=op>}</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=example-output class=level5><h5 class=anchored data-anchor-id=example-output>Example Output</h5><div class=sourceCode id=cb13><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb13-1><a href=#cb13-1 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] exec<span class=er>(</span><span class=st>"grep"</span><span class=kw>)</span> <span class=ex>=</span> 3</span>
<span id=cb13-2><a href=#cb13-2 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] open<span class=er>(</span><span class=st>"README"</span><span class=kw>)</span> <span class=ex>=</span> 3</span>
<span id=cb13-3><a href=#cb13-3 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] read<span class=er>(</span><span class=ex>3</span><span class=kw>)</span> <span class=ex>=</span> 1023</span>
<span id=cb13-4><a href=#cb13-4 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] close<span class=er>(</span><span class=ex>3</span><span class=kw>)</span> <span class=ex>=</span> 0</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>What would happen if we don’t handle <code>SYS_exec</code> separately from the other five syscalls?</section></section></section><section id=step-5-create-a-user-program-strace class=level3><h3 class=anchored data-anchor-id=step-5-create-a-user-program-strace>Step 5: Create a User Program <code>strace</code></h3><p>Create a user program that traces system calls of child processes.<section id=create-the-file-userstrace.c class=level4><h4 class=anchored data-anchor-id=create-the-file-userstrace.c>Create the file <code>user/strace.c</code></h4><p>This user program will:<ul><li>Accept command-line arguments: <code>strace [args...]</code><li>Fork a child process to run the specified command<li>Enable tracing for the child process<li>Wait for child completion</ul><p>This user program should:<ul><li>Validate command-line arguments (at least 2 arguments required)<li>Use <code>fork()</code> to create child process<li><strong>In child</strong>: <code>exec()</code> the target program with its arguments<li><strong>In parent</strong>: call <code>trace()</code> on child PID, then <code>wait()</code> for completion</ul><div class="callout callout-style-default callout-note callout-titled"><div class="callout-header d-flex align-content-center" data-bs-toggle=collapse data-bs-target=.callout-1-contents aria-controls=callout-1 aria-expanded=true aria-label="Toggle callout"><div class=callout-icon-container><i class=callout-icon></i></div><div class="callout-title-container flex-fill">If you find something strange after modifying something, try running:</div><div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class=callout-toggle></i></div></div><div id=callout-1 class="callout-1-contents callout-collapse collapse show"><div class="callout-body-container callout-body"><div class=sourceCode id=cb14><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb14-1><a href=#cb14-1 aria-hidden=true tabindex=-1></a><span class=op>&gt;</span> make <span class=ex>clean</span></span>
<span id=cb14-2><a href=#cb14-2 aria-hidden=true tabindex=-1></a><span class=op>&gt;</span> make</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>before executing<div class=sourceCode id=cb15><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb15-1><a href=#cb15-1 aria-hidden=true tabindex=-1></a><span class=op>&gt;</span> make <span class=ex>qemu</span></span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></div></div></div></section></section><section id=the-interleaved-output-problem class=level3><h3 class=anchored data-anchor-id=the-interleaved-output-problem>The Interleaved Output Problem</h3><p>When you first run:<div class=sourceCode id=cb16><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb16-1><a href=#cb16-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> strace echo hello</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>you might see something like:<div class=sourceCode id=cb17><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb17-1><a href=#cb17-1 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 5] exec<span class=er>(</span><span class=st>"echo"</span><span class=kw>)</span> <span class=ex>=</span> 2</span>
<span id=cb17-2><a href=#cb17-2 aria-hidden=true tabindex=-1></a><span class=va>hello</span><span class=op>[</span>pid 5<span class=op>]</span> <span class=fu>write</span><span class=er>(</span><span class=ex>1</span><span class=kw>)</span> <span class=ex>=</span> 5</span>
<span id=cb17-3><a href=#cb17-3 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 5] write<span class=er>(</span><span class=ex>1</span><span class=kw>)</span> <span class=ex>=</span> 1</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Notice that the <code>"hello"</code> output appears <em>in the middle</em> of the syscall trace? But this is <strong>not good</strong>. We don’t want the output of traced program and tracing messages to mix up.<ul><li>Why does this happen?<li>Which part of xv6 is responsible for writing user output to the console?<li>When the kernel prints syscall tracing info, is it also writing to the same console device?</ul><p>This is your debugging moment. Try to reason it out, and try to dig the kernel with <code>gdb</code>.</section><section id=how-to-fix-it class=level3><h3 class=anchored data-anchor-id=how-to-fix-it>How to Fix It</h3><p>Hints:<ul><li>User <code>write()</code> calls eventually reach <code>consolewrite()</code> in <code>kernel/console.c</code>.<li>Both the user’s output (<code>hello</code>) and your tracing output use the console.<li>But we only want the kernel tracer to print <strong>after</strong> or <strong>outside</strong> of user writes.<li>The current process can be accessed using <code>myproc()</code>.</ul><p>Think about how you can modify the behavior so that the syscall tracing and the user’s output don’t interfere with each other. Once you fix it, your result should look like this:<div class=sourceCode id=cb18><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb18-1><a href=#cb18-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> strace echo hello</span>
<span id=cb18-2><a href=#cb18-2 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 5] exec<span class=er>(</span><span class=st>"echo"</span><span class=kw>)</span> <span class=ex>=</span> 2</span>
<span id=cb18-3><a href=#cb18-3 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 5] write<span class=er>(</span><span class=ex>1</span><span class=kw>)</span> <span class=ex>=</span> 5</span>
<span id=cb18-4><a href=#cb18-4 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 5] write<span class=er>(</span><span class=ex>1</span><span class=kw>)</span> <span class=ex>=</span> 1</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=testing-1 class=level3><h3 class=anchored data-anchor-id=testing-1>Testing</h3><p>If you have completed the above steps, please test your implementation:<div class=sourceCode id=cb19><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb19-1><a href=#cb19-1 aria-hidden=true tabindex=-1></a><span class=ex>$</span> strace grep hello README</span>
<span id=cb19-2><a href=#cb19-2 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] exec<span class=er>(</span><span class=st>"grep"</span><span class=kw>)</span> <span class=ex>=</span> 3</span>
<span id=cb19-3><a href=#cb19-3 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] open<span class=er>(</span><span class=st>"README"</span><span class=kw>)</span> <span class=ex>=</span> 3</span>
<span id=cb19-4><a href=#cb19-4 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] read<span class=er>(</span><span class=ex>3</span><span class=kw>)</span> <span class=ex>=</span> 1023</span>
<span id=cb19-5><a href=#cb19-5 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] read<span class=er>(</span><span class=ex>3</span><span class=kw>)</span> <span class=ex>=</span> 971</span>
<span id=cb19-6><a href=#cb19-6 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] read<span class=er>(</span><span class=ex>3</span><span class=kw>)</span> <span class=ex>=</span> 298</span>
<span id=cb19-7><a href=#cb19-7 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] read<span class=er>(</span><span class=ex>3</span><span class=kw>)</span> <span class=ex>=</span> 0</span>
<span id=cb19-8><a href=#cb19-8 aria-hidden=true tabindex=-1></a><span class=ex>[pid</span> 6] close<span class=er>(</span><span class=ex>3</span><span class=kw>)</span> <span class=ex>=</span> 0</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section><section id=understanding-the-output class=level3><h3 class=anchored data-anchor-id=understanding-the-output>Understanding the Output</h3><p>Example:<ul><li><code>[pid 4] exec("grep") = 3</code> → Process 4 executed <code>grep</code> using the <code>exec</code> syscall.<li><code>[pid 6] open("README") = 3</code> → Process 6 opened file <code>README</code> and got file descriptor 3.</ul><hr></section><section id=run-the-grading-script class=level3><h3 class=anchored data-anchor-id=run-the-grading-script>Run the Grading Script</h3><p>When everything seems correct, verify your implementation using:<div class=sourceCode id=cb20><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb20-1><a href=#cb20-1 aria-hidden=true tabindex=-1></a><span class=ex>python3</span> grade-syscall_trace.py</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><p>Then also test:<div class=sourceCode id=cb21><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb21-1><a href=#cb21-1 aria-hidden=true tabindex=-1></a><span class=ex>strace</span> find a b</span>
<span id=cb21-2><a href=#cb21-2 aria-hidden=true tabindex=-1></a><span class=ex>strace</span> ls a</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div></section></section><section id=final-reflection-demo class=level2><h2 class=anchored data-anchor-id=final-reflection-demo>Final Reflection & Demo</h2><p><strong>Make sure you can reason about the following questions:</strong><ol type=1><li>Why was the output interleaved earlier, and how did your fix resolve it?<li>Why must we treat <code>SYS_exec</code> differently from other syscalls?<li>What happens if the tracing flag is never cleared or reset?<li>Why do we print only the <em>first</em> argument of each syscall?</ol><p>TA will ask you these questions during the demo.<section id=during-demo-time class=level3><h3 class=anchored data-anchor-id=during-demo-time>During Demo Time</h3><p>Please <strong>bring your own laptop</strong> to the classroom. You will be asked to:<ol type=1><li>Run the grading scripts:</ol><div class=sourceCode id=cb22><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id=cb22-1><a href=#cb22-1 aria-hidden=true tabindex=-1></a><span class=ex>python3</span> grade-find.py</span>
<span id=cb22-2><a href=#cb22-2 aria-hidden=true tabindex=-1></a><span class=ex>python3</span> grade-syscall_trace.py</span></code><button title="Copy to Clipboard" class=code-copy-button><i class=bi></i></button></pre></div><ol start=2 type=1><li>Demonstrate that all tests pass.<li>Explain the answers to the reflection questions above.</ol></section></section></section><a onclick="return window.scrollTo(0,0),!1" role=button id=quarto-back-to-top><i class="bi bi-arrow-up"></i> Back to top</a></main><script id=quarto-html-after-body>window.document.addEventListener("DOMContentLoaded",function(){const j="",c=new window.AnchorJS;c.options={placement:"right",icon:j},c.add(".anchored");const v=e=>{for(const t of e.classList)if(t.startsWith("code-annotation-"))return!0;return!1},p=function(e){const t=e.trigger;t.blur(),t.classList.add("code-copy-button-checked");var s=t.getAttribute("title");t.setAttribute("title","Copied!");let n;window.bootstrap&&(t.setAttribute("data-bs-toggle","tooltip"),t.setAttribute("data-bs-placement","left"),t.setAttribute("data-bs-title","Copied!"),n=new bootstrap.Tooltip(t,{trigger:"manual",customClass:"code-copy-button-tooltip",offset:[0,-8]}),n.show()),setTimeout(function(){n&&(n.hide(),t.removeAttribute("data-bs-title"),t.removeAttribute("data-bs-toggle"),t.removeAttribute("data-bs-placement")),t.setAttribute("title",s),t.classList.remove("code-copy-button-checked")},1e3),e.clearSelection()},m=function(e){const t=e.previousElementSibling.cloneNode(!0);for(const e of t.children)v(e)&&e.remove();return t.innerText},b=new window.ClipboardJS(".code-copy-button:not([data-in-quarto-modal])",{text:m});if(b.on("success",p),window.document.getElementById("quarto-embedded-source-code-modal")){const e=new window.ClipboardJS(".code-copy-button[data-in-quarto-modal]",{text:m,container:window.document.getElementById("quarto-embedded-source-code-modal")});e.on("success",p)}for(var s,g=new RegExp(/^(?:http|https):\/\/localhost:?[0-9]*\//),x=new RegExp(/^mailto:/),O=new RegExp("/"+window.location.host+"/"),w=e=>O.test(e)||g.test(e)||x.test(e),u=window.document.querySelectorAll("a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)"),t=0;t<u.length;t++){const e=u[t];w(e.href)||(e.dataset.originalHref!==0[0]&&(e.href=e.dataset.originalHref),e.setAttribute("target","_blank"),e.getAttribute("rel")===null&&e.setAttribute("rel","noopener"),e.classList.add("external"))}function i(e,t,n,s){const o={allowHTML:!0,maxWidth:500,delay:100,arrow:!1,appendTo:function(e){return e.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"bottom-start"};t&&(o.content=t),n&&(o.onTrigger=n),s&&(o.onUntrigger=s),window.tippy(e,o)}const f=window.document.querySelectorAll('a[role="doc-noteref"]');for(t=0;t<f.length;t++){const e=f[t];i(e,function(){let t=e.getAttribute("data-footnote-href")||e.getAttribute("href");try{t=new URL(t).hash}catch{}const s=t.replace(/^#\/?/,""),n=window.document.getElementById(s);return n?n.innerHTML:""})}const r=window.document.querySelectorAll("a.quarto-xref"),o=(e,t)=>{const n=e=>{if(e.classList.remove("page-full","page-columns"),e.children)for(const t of e.children)n(t)};if(n(t),e===null||e.startsWith("sec-")){const e=document.createElement("div");if(t.children&&t.children.length>2){e.appendChild(t.children[0].cloneNode(!0));for(let n=1;n<t.children.length;n++){const s=t.children[n];if(s.tagName==="P"&&s.innerText==="")continue;e.appendChild(s.cloneNode(!0));break}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(e),e.innerHTML}return window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.innerHTML}else{const e=t.querySelector("a.anchorjs-link");return e&&e.remove(),window.Quarto?.typesetMath&&window.Quarto.typesetMath(t),t.classList.contains("callout")?t.outerHTML:t.innerHTML}};for(t=0;t<r.length;t++){const e=r[t];i(e,0[0],function(t){t.disable();let n=e.getAttribute("href"),s=0[0];if(n.startsWith("#"))s=n;else try{s=new URL(n).hash}catch{}if(s){const e=s.replace(/^#\/?/,""),i=window.document.getElementById(e);if(i!==null)try{const n=o(e,i.cloneNode(!0));t.setContent(n)}finally{t.enable(),t.show()}else fetch(n.split("#")[0]).then(e=>e.text()).then(n=>{const i=new DOMParser,a=i.parseFromString(n,"text/html"),s=a.getElementById(e);if(s!==null){const n=o(e,s);t.setContent(n)}}).finally(()=>{t.enable(),t.show()})}else fetch(n).then(e=>e.text()).then(e=>{const s=new DOMParser,i=s.parseFromString(e,"text/html"),n=i.querySelector("main.content");if(n!==null){n.children.length>0&&n.children[0].tagName==="HEADER"&&n.children[0].remove();const e=o(null,n);t.setContent(e)}}).finally(()=>{t.enable(),t.show()})},function(){})}let n;const h=(e,t)=>{let n='data-code-cell="'+e+'"',s='data-code-annotation="'+t+'"';const o="span["+n+"]["+s+"]";return o},a=e=>{const d=window.document,i=e.getAttribute("data-target-cell"),r=e.getAttribute("data-target-annotation"),c=window.document.querySelector(h(i,r)),l=c.getAttribute("data-code-lines").split(","),t=l.map(e=>i+"-"+e);let s=null,o=null,a=null;if(t.length>0){const r=window.document.getElementById(t[0]);if(s=r.offsetTop,o=r.offsetHeight,a=r.parentElement.parentElement,t.length>1){const e=window.document.getElementById(t[t.length-1]),n=e.offsetTop+e.offsetHeight;o=n-s}if(s!==null&&o!==null&&a!==null){let e=window.document.getElementById("code-annotation-line-highlight");e===null&&(e=window.document.createElement("div"),e.setAttribute("id","code-annotation-line-highlight"),e.style.position="absolute",a.appendChild(e)),e.style.top=s-2+"px",e.style.height=o+4+"px",e.style.left=0;let t=window.document.getElementById("code-annotation-line-highlight-gutter");if(t===null){t=window.document.createElement("div"),t.setAttribute("id","code-annotation-line-highlight-gutter"),t.style.position="absolute";const e=window.document.getElementById(i),n=e.querySelector(".code-annotation-gutter");n.appendChild(t)}t.style.top=s-2+"px",t.style.height=o+4+"px"}n=e}},y=()=>{const e=["code-annotation-line-highlight","code-annotation-line-highlight-gutter"];e.forEach(e=>{const t=window.document.getElementById(e);t&&t.remove()}),n=0[0]};window.addEventListener("resize",_(()=>{elRect=0[0],n&&a(n)},10));function _(e,t){let s=!1,n;return(...o)=>{s?(n&&clearTimeout(n),n=setTimeout(()=>{e.apply(this,o),n=s=!1},t)):(e.apply(this,o),s=!0)}}const d=window.document.querySelectorAll(".code-annotation-anchor");for(let e=0;e<d.length;e++){const t=d[e],n=t.getAttribute("data-target-cell"),s=t.getAttribute("data-target-annotation"),o=()=>{const e=window.document.querySelector(h(n,s));if(e){const t=e.cloneNode(!0);return t.classList.add("code-annotation-tip-content"),t.outerHTML}},i={allowHTML:!0,content:o,onShow:e=>{a(e.reference),e.reference.classList.add("code-annotation-active"),window.tippy.hideAll()},onHide:e=>{y(),e.reference.classList.remove("code-annotation-active")},maxWidth:300,delay:[50,0],duration:[200,0],offset:[5,10],arrow:!0,appendTo:function(e){return e.parentElement.parentElement.parentElement},interactive:!0,interactiveBorder:10,theme:"quarto",placement:"right",popperOptions:{modifiers:[{name:"flip",options:{flipVariations:!1,allowedAutoPlacements:["right"],fallbackPlacements:["right","top","top-start","top-end","bottom","bottom-start","bottom-end","left"]}},{name:"preventOverflow",options:{mainAxis:!1,altAxis:!1}}]}};window.tippy(t,i)}const l=e=>{const t=e.parentElement;if(t){const n=t.dataset.cites;return n?{el:e,cites:n.split(" ")}:l(e.parentElement)}else return 0[0]};for(s=window.document.querySelectorAll('a[role="doc-biblioref"]'),t=0;t<s.length;t++){const n=s[t],e=l(n);e&&i(e.el,function(){var t=window.document.createElement("div");return e.cites.forEach(function(e){var s,n=window.document.createElement("div");n.classList.add("hanging-indent"),n.classList.add("csl-entry"),s=window.document.getElementById("ref-"+e),s&&(n.innerHTML=s.innerHTML),t.appendChild(n)}),t.innerHTML})}})</script></div><footer class=footer><div class=nav-footer><div class=nav-footer-left><p><img id=footer-cat-left src=../images/cat-left.png alt="Cat Left"></div><div class=nav-footer-center><p><span id=footer-center>Made with ❤️ by Tony, (CC&nbsp;BY&nbsp;4.0)<br><span style=font-size:8px>Cat source: Freepik and ChatGPT</span></span></div><div class=nav-footer-right><p><img id=footer-cat-right src=../images/cat-right.png alt="Cat Right"></div></div></footer>